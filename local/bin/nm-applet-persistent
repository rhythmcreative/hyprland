#!/bin/bash

# Script mejorado para mantener nm-applet corriendo de forma persistente
# Evita que se cierre autom√°ticamente y maneja reinicios suaves

set -euo pipefail

LOG_FILE="$HOME/.cache/nm-applet-persistent.log"

# Funci√≥n de logging
log() {
    local message="[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    echo "$message" | tee -a "$LOG_FILE"
}

# Funci√≥n para verificar si nm-applet est√° corriendo
is_nm_applet_running() {
    pgrep -x nm-applet > /dev/null 2>&1
}

# Funci√≥n para matar nm-applet de forma limpia
kill_nm_applet() {
    if is_nm_applet_running; then
        local pid=$(pgrep -x nm-applet | head -1)
        log "üîÑ Cerrando nm-applet actual (PID: $pid)..."
        
        # Intentar cerrar gracefully primero
        kill -TERM "$pid" 2>/dev/null || true
        sleep 1
        
        # Si a√∫n est√° corriendo, forzar cierre
        if is_nm_applet_running; then
            kill -KILL "$pid" 2>/dev/null || true
            sleep 1
        fi
        
        # Esperar a que realmente se cierre
        local attempts=0
        while is_nm_applet_running && [ $attempts -lt 5 ]; do
            sleep 1
            ((attempts++))
        done
        
        if is_nm_applet_running; then
            log "‚ö†Ô∏è nm-applet resistente a cerrarse, continuando..."
        else
            log "‚úÖ nm-applet cerrado exitosamente"
        fi
    fi
}

# Funci√≥n para iniciar nm-applet con configuraci√≥n optimizada
start_nm_applet() {
    log "üöÄ Iniciando nm-applet con configuraci√≥n persistente..."
    
    # Variables de entorno para estabilidad
    export GTK_THEME="Arc-Dark"
    export GDK_BACKEND="wayland,x11"
    export DISPLAY="${DISPLAY:-:0}"
    export WAYLAND_DISPLAY="${WAYLAND_DISPLAY:-wayland-0}"
    
    # Iniciar nm-applet en segundo plano con nohup para persistencia
    nohup nm-applet > /dev/null 2>&1 &
    local nm_applet_pid=$!
    
    # Esperar un momento para verificar que se inicie correctamente
    sleep 3
    
    if is_nm_applet_running; then
        local actual_pid=$(pgrep -x nm-applet | head -1)
        log "‚úÖ nm-applet iniciado exitosamente (PID: $actual_pid)"
        
        # Verificar que realmente est√° funcionando
        sleep 2
        if is_nm_applet_running; then
            log "üîí nm-applet confirmado como estable"
            return 0
        else
            log "‚ùå nm-applet se cerr√≥ inmediatamente despu√©s del inicio"
            return 1
        fi
    else
        log "‚ùå Fall√≥ al iniciar nm-applet"
        return 1
    fi
}

# Funci√≥n para restart suave (sin matar si est√° funcionando bien)
soft_restart() {
    log "üîÑ Realizando restart suave de nm-applet..."
    
    if is_nm_applet_running; then
        # Verificar si nm-applet responde correctamente
        local pid=$(pgrep -x nm-applet | head -1)
        
        # Verificar que el proceso no est√© zombie o colgado
        if kill -0 "$pid" 2>/dev/null; then
            log "‚úÖ nm-applet est√° corriendo y responde (PID: $pid)"
            log "‚ÑπÔ∏è No es necesario reiniciar, manteni√©ndolo activo"
            return 0
        else
            log "‚ö†Ô∏è nm-applet no responde, reiniciando..."
        fi
    fi
    
    # Reiniciar si no est√° corriendo o no responde
    kill_nm_applet
    sleep 2
    start_nm_applet
}

# Funci√≥n para restart forzado
force_restart() {
    log "üîÑ Realizando restart forzado de nm-applet..."
    kill_nm_applet
    sleep 2
    start_nm_applet
}

# Funci√≥n para asegurar que nm-applet est√© corriendo
ensure_running() {
    log "üîç Verificando estado de nm-applet..."
    
    if is_nm_applet_running; then
        local pid=$(pgrep -x nm-applet | head -1)
        log "‚úÖ nm-applet ya est√° corriendo (PID: $pid)"
        return 0
    else
        log "‚ö†Ô∏è nm-applet no est√° corriendo, iniciando..."
        start_nm_applet
    fi
}

# Funci√≥n principal
main() {
    local action="${1:-ensure}"
    
    log "üì∂ === nm-applet-persistent: $action ==="
    
    case "$action" in
        "start")
            kill_nm_applet
            start_nm_applet
            ;;
        "stop")
            kill_nm_applet
            ;;
        "restart"|"force")
            force_restart
            ;;
        "soft"|"gentle")
            soft_restart
            ;;
        "ensure"|*)
            ensure_running
            ;;
    esac
    
    # Verificaci√≥n final
    if is_nm_applet_running; then
        local final_pid=$(pgrep -x nm-applet | head -1)
        log "üéâ nm-applet funcionando correctamente (PID: $final_pid)"
        
        # Crear archivo de estado para monitoreo
        echo "$(date '+%Y-%m-%d %H:%M:%S') - PID: $final_pid" > "$HOME/.cache/nm-applet-status"
    else
        log "‚ùå nm-applet no est√° funcionando"
        rm -f "$HOME/.cache/nm-applet-status" 2>/dev/null || true
        exit 1
    fi
}

# Ejecutar funci√≥n principal
main "$@"
