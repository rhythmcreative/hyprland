#!/bin/bash

# Monitor de wallpaper que detecta cambios y actualiza autom√°ticamente el tema GTK

WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
CACHE_FILE="$HOME/.cache/current_wallpaper"

echo "üîç Monitor de wallpaper iniciado..."
echo "Detectar√° cambios autom√°ticamente y actualizar√° temas GTK"

# Funci√≥n para detectar wallpaper actual de swww
get_current_wallpaper() {
    if command -v swww >/dev/null 2>&1; then
        swww query 2>/dev/null | grep -o 'image: .*' | cut -d' ' -f2- | head -1
    fi
}

# Funci√≥n para procesar cambio de wallpaper
process_wallpaper_change() {
    local new_wallpaper="$1"
    
    if [[ -n "$new_wallpaper" && -f "$new_wallpaper" ]]; then
        echo "üé® Detectado nuevo wallpaper: $(basename "$new_wallpaper")"
        
        # Generar colores con wal (sin cambiar wallpaper ya que swww ya lo hizo)
        echo "Generando colores y tema GTK..."
        if wal -i "$new_wallpaper" >/dev/null 2>&1; then
            # El hook post.sh se ejecutar√° autom√°ticamente
            echo "‚úì Tema actualizado autom√°ticamente"
            
            # Guardar wallpaper actual en cache
            echo "$new_wallpaper" > "$CACHE_FILE"
            
            # Notificaci√≥n
            if command -v notify-send >/dev/null 2>&1; then
                notify-send "üé® Tema Auto-Actualizado" "$(basename "$new_wallpaper")" -t 2000
            fi
        else
            echo "‚ùå Error al generar colores"
        fi
    fi
}

# Funci√≥n de monitoreo continuo
monitor_wallpaper() {
    local last_wallpaper=""
    
    if [[ -f "$CACHE_FILE" ]]; then
        last_wallpaper=$(cat "$CACHE_FILE")
    fi
    
    while true; do
        current_wallpaper=$(get_current_wallpaper)
        
        if [[ "$current_wallpaper" != "$last_wallpaper" ]]; then
            process_wallpaper_change "$current_wallpaper"
            last_wallpaper="$current_wallpaper"
        fi
        
        sleep 2  # Revisar cada 2 segundos
    done
}

# Funci√≥n para ejecutar en background
start_daemon() {
    if pgrep -f "wallpaper-monitor" >/dev/null 2>&1; then
        echo "‚ùå Monitor ya est√° ejecut√°ndose"
        exit 1
    fi
    
    echo "üöÄ Iniciando monitor en background..."
    nohup "$0" monitor >/dev/null 2>&1 &
    echo "‚úì Monitor iniciado (PID: $!)"
}

# Funci√≥n para detener daemon
stop_daemon() {
    if pgrep -f "wallpaper-monitor" >/dev/null 2>&1; then
        pkill -f "wallpaper-monitor"
        echo "‚úì Monitor detenido"
    else
        echo "‚ùå Monitor no est√° ejecut√°ndose"
    fi
}

# Funci√≥n para mostrar estado
status_daemon() {
    if pgrep -f "wallpaper-monitor" >/dev/null 2>&1; then
        echo "‚úì Monitor est√° ejecut√°ndose"
        pgrep -f "wallpaper-monitor" | while read pid; do
            echo "  PID: $pid"
        done
    else
        echo "‚ùå Monitor no est√° ejecut√°ndose"
    fi
}

# Procesar argumentos
case "$1" in
    "monitor")
        monitor_wallpaper
        ;;
    "start")
        start_daemon
        ;;
    "stop")
        stop_daemon
        ;;
    "restart")
        stop_daemon
        sleep 1
        start_daemon
        ;;
    "status")
        status_daemon
        ;;
    *)
        echo "Monitor de Wallpaper - Auto-actualizador de temas GTK"
        echo ""
        echo "Uso: $0 {start|stop|restart|status|monitor}"
        echo ""
        echo "Comandos:"
        echo "  start     - Iniciar monitor en background"
        echo "  stop      - Detener monitor"
        echo "  restart   - Reiniciar monitor"
        echo "  status    - Ver estado del monitor"
        echo "  monitor   - Ejecutar monitor en foreground (debug)"
        echo ""
        echo "El monitor detecta autom√°ticamente cambios de wallpaper"
        echo "y actualiza los temas GTK sin intervenci√≥n manual."
        ;;
esac
