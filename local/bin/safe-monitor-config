#!/bin/bash

# Script para generar configuraci√≥n de monitores segura basada en monitores conectados
# Evita crashes cuando hay discrepancia entre monitores.conf est√°tico y monitores reales

set -euo pipefail

MONITORS_CONF="$HOME/.config/hypr/monitors.conf"
BACKUP_CONF="$HOME/.config/hypr/monitors.conf.backup-$(date +%s)"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >&2
}

# Backup de la configuraci√≥n actual
backup_current_config() {
    if [[ -f "$MONITORS_CONF" ]]; then
        cp "$MONITORS_CONF" "$BACKUP_CONF"
        log "‚úÖ Backup creado: $BACKUP_CONF"
    fi
}

# Generar configuraci√≥n de monitores basada en lo que est√° conectado
generate_safe_config() {
    local temp_conf=$(mktemp)
    
    log "üîç Detectando monitores conectados..."
    
    # Obtener informaci√≥n de monitores conectados
    local connected_monitors=()
    while IFS= read -r line; do
        if [[ "$line" =~ ^Monitor\ ([^[:space:]]+) ]]; then
            monitor_name="${BASH_REMATCH[1]}"
            connected_monitors+=("$monitor_name")
        fi
    done < <(hyprctl monitors)
    
    log "üì∫ Monitores conectados: ${connected_monitors[*]}"
    
    # Escribir header
    cat > "$temp_conf" << EOF
# Generated by safe-monitor-config on $(date). Safe configuration.
# This config is generated based on currently connected monitors only.

EOF

    # Generar configuraci√≥n para cada monitor conectado
    local monitor_index=0
    for monitor in "${connected_monitors[@]}"; do
        log "‚öôÔ∏è Configurando monitor: $monitor"
        
        # Obtener informaci√≥n detallada del monitor
        local monitor_info=$(hyprctl monitors | awk "/^Monitor $monitor/,/^$/" | head -20)
        
        # Extraer resoluci√≥n y refresh rate
        local resolution_line=$(echo "$monitor_info" | grep -E "^\s+[0-9]+x[0-9]+@[0-9]+\.[0-9]+" | head -1 | xargs)
        
        if [[ -n "$resolution_line" ]]; then
            # Usar la informaci√≥n actual del monitor
            local position_x=$((monitor_index * 1920))  # Posicionamiento simple lado a lado
            echo "monitor=$monitor,$resolution_line,${position_x}x0,1.0" >> "$temp_conf"
            log "‚úÖ $monitor configurado: $resolution_line en ${position_x}x0"
        else
            # Configuraci√≥n de fallback
            log "‚ö†Ô∏è No se pudo detectar resoluci√≥n para $monitor, usando auto"
            echo "monitor=$monitor,preferred,auto,1.0" >> "$temp_conf"
        fi
        
        ((monitor_index++))
    done
    
    # Verificar que se gener√≥ contenido
    if [[ -s "$temp_conf" ]]; then
        # Mover la configuraci√≥n temporal al lugar final
        mv "$temp_conf" "$MONITORS_CONF"
        log "‚úÖ Nueva configuraci√≥n de monitores generada exitosamente"
        
        # Mostrar contenido generado
        log "üìÑ Contenido de la nueva configuraci√≥n:"
        cat "$MONITORS_CONF" >&2
        
        return 0
    else
        log "‚ùå Error: No se pudo generar configuraci√≥n de monitores"
        rm -f "$temp_conf"
        return 1
    fi
}

# Restaurar configuraci√≥n desde backup
restore_config() {
    local backup_file="$1"
    if [[ -f "$backup_file" ]]; then
        cp "$backup_file" "$MONITORS_CONF"
        log "üîÑ Configuraci√≥n restaurada desde: $backup_file"
        return 0
    else
        log "‚ùå Backup no encontrado: $backup_file"
        return 1
    fi
}

# Funci√≥n principal
main() {
    case "${1:-generate}" in
        "generate")
            log "üöÄ Generando configuraci√≥n segura de monitores..."
            backup_current_config
            if generate_safe_config; then
                log "üéâ Configuraci√≥n de monitores actualizada exitosamente"
                exit 0
            else
                log "‚ùå Error al generar configuraci√≥n"
                exit 1
            fi
            ;;
        "restore")
            if [[ -n "${2:-}" ]]; then
                restore_config "$2"
            else
                # Buscar el backup m√°s reciente
                local latest_backup=$(ls -t "$HOME/.config/hypr/monitors.conf.backup-"* 2>/dev/null | head -1 || echo "")
                if [[ -n "$latest_backup" ]]; then
                    restore_config "$latest_backup"
                else
                    log "‚ùå No se encontraron backups"
                    exit 1
                fi
            fi
            ;;
        "list-backups")
            log "üìã Backups disponibles:"
            ls -la "$HOME/.config/hypr/monitors.conf.backup-"* 2>/dev/null || log "No hay backups disponibles"
            ;;
        *)
            log "Uso: $0 [generate|restore [backup_file]|list-backups]"
            log "  generate     - Generar configuraci√≥n basada en monitores conectados (default)"
            log "  restore      - Restaurar desde backup (m√°s reciente si no se especifica)"
            log "  list-backups - Listar backups disponibles"
            exit 1
            ;;
    esac
}

main "$@"
