#!/bin/bash

# Script mejorado para sincronizar waybar con pywal automÃ¡ticamente
# Este script puede ser llamado despuÃ©s de cambiar wallpapers

# FunciÃ³n de logging
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a /tmp/waybar-sync.log
}

# Verificar si pywal estÃ¡ instalado
if ! command -v wal &> /dev/null; then
    log "âŒ Error: pywal no estÃ¡ instalado"
    exit 1
fi

# Verificar argumentos
if [ $# -eq 0 ]; then
    log "ğŸ“‹ Uso: $0 <imagen_wallpaper> [opciones_wal]"
    log "ğŸ“‹ Ejemplo: $0 ~/Pictures/wallpaper.jpg"
    log "ğŸ“‹ O simplemente: $0 --reload (para recargar waybar con colores actuales)"
    exit 1
fi

# OpciÃ³n para solo recargar waybar sin cambiar wallpaper
if [ "$1" = "--reload" ]; then
    log "ğŸ”„ Recargando waybar con colores actuales (optimizado)..."
    # Usar el script optimizado de waybar-pywal-sync
    if [ -x "$HOME/.local/bin/waybar-pywal-sync" ]; then
        "$HOME/.local/bin/waybar-pywal-sync"
        log "âœ… Waybar recargado con waybar-pywal-sync (sin reinicios mÃºltiples)"
    else
        # Fallback simple sin reinicio
        waybar_pids=$(pgrep -x waybar)
        if [[ -n "$waybar_pids" ]]; then
            kill -USR2 $waybar_pids 2>/dev/null || true
            log "âœ… Waybar CSS recargado con seÃ±al USR2"
        fi
    fi
    exit 0
fi

# Verificar si el archivo de imagen existe
if [ ! -f "$1" ]; then
    log "âŒ Error: El archivo '$1' no existe"
    exit 1
fi

log "ğŸ¨ Cambiando wallpaper y sincronizando waybar..."
log "ğŸ“‚ Archivo: $1"

# Aplicar pywal con el wallpaper
log "ğŸ”§ Ejecutando pywal..."
wal_output=$(wal -i "$1" "${@:2}" 2>&1)
wal_exit_code=$?

if [ $wal_exit_code -ne 0 ]; then
    log "âŒ Error ejecutando pywal: $wal_output"
    exit 1
fi

log "âœ… Pywal ejecutado correctamente"

# Esperar un momento para asegurar que los archivos se hayan generado
sleep 0.5

# Verificar si se generaron los templates de waybar
if [ ! -f "$HOME/.cache/wal/waybar-style.css" ]; then
    log "âš ï¸  Advertencia: Template waybar-style.css no encontrado"
fi

if [ ! -f "$HOME/.cache/wal/waybar-style-varied.css" ]; then
    log "âš ï¸  Advertencia: Template waybar-style-varied.css no encontrado"
fi

# Usar el script optimizado waybar-pywal-sync (sin reinicios mÃºltiples)
log "ğŸ”„ Actualizando waybar (script optimizado)..."
if [ -x "$HOME/.local/bin/waybar-pywal-sync" ]; then
    "$HOME/.local/bin/waybar-pywal-sync"
    log "âœ… Waybar actualizado correctamente (sin reinicios mÃºltiples)"
else
    log "âš ï¸ Script optimizado no encontrado, usando recarga simple..."
    waybar_pids=$(pgrep -x waybar)
    if [[ -n "$waybar_pids" ]]; then
        kill -USR2 $waybar_pids 2>/dev/null || {
            kill -TERM $waybar_pids 2>/dev/null
            sleep 1
            waybar > /dev/null 2>&1 &
        }
        log "âœ… Waybar recargado (fallback simple)"
    fi
fi

# Sincronizar nm-applet con los colores de waybar
log "ğŸ¨ Sincronizando nm-applet con colores de waybar..."
if [ -x "$HOME/.local/bin/sync-nm-applet-waybar" ]; then
    "$HOME/.local/bin/sync-nm-applet-waybar" > /dev/null 2>&1 &
    log "âœ… nm-applet sincronizado automÃ¡ticamente con waybar"
else
    log "âš ï¸ Script de sincronizaciÃ³n nm-applet no encontrado"
fi

log "ğŸ‰ SincronizaciÃ³n completa: wallpaper y waybar actualizados"
log "ğŸ“· Wallpaper: $(basename "$1")"
log "ğŸ¨ Tema: $current_theme"
