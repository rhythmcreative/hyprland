#!/bin/bash

# Script para gestionar temas de Steam usando wal_steam
# Uso: steam-theme [update|apply|status|help]

SCRIPT_NAME="steam-theme"
LOG_FILE="$HOME/.cache/wallpaper-theme.log"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$SCRIPT_NAME] $1" >> "$LOG_FILE"
}

# Funci√≥n para mostrar ayuda
show_help() {
    echo "Gestor de temas de Steam con pywal"
    echo ""
    echo "Uso: $SCRIPT_NAME [COMANDO]"
    echo ""
    echo "Comandos:"
    echo "  apply       Aplicar tema actual de pywal a Steam"
    echo "  update      Forzar actualizaci√≥n completa del tema"
    echo "  status      Mostrar estado de Steam y wal_steam"
    echo "  help        Mostrar esta ayuda"
    echo ""
    echo "Si no se especifica comando, se ejecuta 'apply'"
    echo ""
    echo "Requisitos:"
    echo "  - wal_steam instalado"
    echo "  - pywal con colores generados"
    echo ""
}

# Funci√≥n para mostrar estado
show_status() {
    echo "=== Estado del Sistema ==="
    echo ""
    
    # Verificar Steam
    if command -v steam > /dev/null 2>&1; then
        echo "‚úÖ Steam: Instalado"
        if pgrep -x "steam" > /dev/null; then
            echo "üîÑ Steam: Ejecut√°ndose"
        else
            echo "‚èπÔ∏è  Steam: Detenido"
        fi
    else
        echo "‚ùå Steam: No instalado"
    fi
    
    # Verificar wal_steam
    if command -v wal_steam > /dev/null 2>&1; then
        echo "‚úÖ wal_steam: Instalado"
        echo "üìç Ubicaci√≥n: $(which wal_steam)"
    else
        echo "‚ùå wal_steam: No instalado"
    fi
    
    # Verificar pywal
    if command -v wal > /dev/null 2>&1; then
        echo "‚úÖ pywal: Instalado"
        if [ -f "$HOME/.cache/wal/colors" ]; then
            echo "üé® Colores de pywal: Disponibles"
            echo "üñºÔ∏è  √öltima imagen: $(cat ~/.cache/wal/wal 2>/dev/null || echo 'No disponible')"
        else
            echo "‚ö†Ô∏è  Colores de pywal: No generados"
        fi
    else
        echo "‚ùå pywal: No instalado"
    fi
    
    # Verificar directorio de skins
    if [ -d "$HOME/.steam/skins" ]; then
        echo "üìÅ Directorio de skins de Steam: Existe"
        SKIN_COUNT=$(find "$HOME/.steam/skins" -maxdepth 1 -type d | wc -l)
        echo "üé≠ Skins instalados: $((SKIN_COUNT - 1))"
    else
        echo "üìÅ Directorio de skins de Steam: No existe"
    fi
    
    echo ""
}

# Funci√≥n para aplicar tema
apply_theme() {
    local FORCE_UPDATE=""
    if [[ "$1" == "force" ]]; then
        FORCE_UPDATE="--force-update"
    fi
    
    echo "üéÆ Aplicando tema de Steam..."
    log "Iniciando aplicaci√≥n de tema Steam"
    
    # Verificar prerrequisitos
    if ! command -v wal_steam > /dev/null 2>&1; then
        echo "‚ùå Error: wal_steam no est√° instalado"
        echo "Inst√°lalo con: yay -S python-wal-steam-git"
        exit 1
    fi
    
    if [ ! -f "$HOME/.cache/wal/colors" ]; then
        echo "‚ùå Error: No se encontraron colores de pywal"
        echo "Ejecuta primero: wal -i [imagen]"
        exit 1
    fi
    
    # Ejecutar el script de aplicaci√≥n de tema
    if [[ -f "$HOME/.local/bin/apply-steam-theme" ]]; then
        "$HOME/.local/bin/apply-steam-theme" $FORCE_UPDATE
        RESULT=$?
        
        if [ $RESULT -eq 0 ]; then
            echo "‚úÖ Tema aplicado exitosamente"
            if pgrep -x "steam" > /dev/null; then
                echo "üí° Reinicia Steam para ver los cambios"
            fi
        else
            echo "‚ùå Error al aplicar el tema (c√≥digo: $RESULT)"
        fi
    else
        echo "‚ùå Error: Script apply-steam-theme no encontrado"
        exit 1
    fi
}

# Procesar argumentos
case "${1:-apply}" in
    "apply")
        apply_theme
        ;;
    "update")
        apply_theme force
        ;;
    "status")
        show_status
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        echo "‚ùå Comando desconocido: $1"
        echo "Usa '$SCRIPT_NAME help' para ver los comandos disponibles"
        exit 1
        ;;
esac
