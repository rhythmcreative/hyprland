#!/bin/bash

# Script de sincronizaci√≥n SIMPLE de Waybar
# Evita m√∫ltiples recargas que causan p√©rdida del m√≥dulo de workspaces

set -euo pipefail

LOG_FILE="$HOME/.cache/simple-waybar-sync.log"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
    echo "$1" >&2
}

# Funci√≥n para verificar si waybar est√° corriendo
is_waybar_running() {
    pgrep -x waybar > /dev/null
}

# Funci√≥n para sincronizar waybar de forma segura
sync_waybar_safe() {
    if is_waybar_running; then
        log "üé® Recargando configuraci√≥n CSS de Waybar..."
        
        # Obtener PIDs de waybar y enviar se√±al directamente
        local waybar_pids=$(pgrep -x waybar)
        if [[ -n "$waybar_pids" ]]; then
            # Intentar recarga suave con SIGUSR2
            if kill -USR2 $waybar_pids 2>/dev/null; then
                log "‚úÖ Waybar CSS recargado exitosamente"
                sleep 2
                
                # Verificar que waybar sigue funcionando despu√©s de la recarga
                if is_waybar_running; then
                    log "‚úÖ Waybar verificado - funcionando correctamente"
                    return 0
                else
                    log "‚ö†Ô∏è Waybar se cerr√≥ despu√©s de la recarga, reiniciando..."
                    waybar > /dev/null 2>&1 &
                    sleep 2
                    return 0
                fi
            else
                log "‚ö†Ô∏è Recarga CSS con USR2 fall√≥, intentando reinicio controlado..."
                # Terminar waybar suavemente y reiniciar
                kill -TERM $waybar_pids 2>/dev/null || true
                sleep 2
                waybar > /dev/null 2>&1 &
                sleep 2
                log "‚úÖ Waybar reiniciado"
                return 0
            fi
        else
            log "‚ö†Ô∏è No se pudieron obtener PIDs de waybar, reiniciando..."
            pkill waybar 2>/dev/null || true
            sleep 1
            waybar > /dev/null 2>&1 &
            sleep 2
            log "‚úÖ Waybar reiniciado"
            return 0
        fi
    else
        log "üöÄ Waybar no est√° corriendo, inici√°ndolo..."
        waybar > /dev/null 2>&1 &
        sleep 2
        log "‚úÖ Waybar iniciado"
        return 0
    fi
}

# Funci√≥n principal
main() {
    log "=== Iniciando sincronizaci√≥n simple de Waybar ==="
    
    # Verificar que los archivos de pywal existen
    if [[ ! -f "$HOME/.cache/wal/colors.sh" ]]; then
        log "‚ö†Ô∏è Archivos de pywal no encontrados - aplicando pywal primero"
        # Si no hay colores de pywal, usar el wallpaper actual
        current_wallpaper=$(cat "$HOME/.cache/current-wallpaper" 2>/dev/null || echo "")
        if [[ -n "$current_wallpaper" && -f "$current_wallpaper" ]]; then
            log "üé® Aplicando pywal a wallpaper actual: $(basename "$current_wallpaper")"
            wal -i "$current_wallpaper" -n -q
            sleep 1
        fi
    fi
    
    # Sincronizar waybar
    sync_waybar_safe
    
    # Verificaci√≥n final
    if is_waybar_running; then
        log "üéâ Sincronizaci√≥n exitosa - Waybar funcionando correctamente"
        notify-send "‚úÖ Waybar Sincronizado" "Configuraci√≥n aplicada exitosamente" -t 2000 2>/dev/null || true
    else
        log "‚ùå Error: Waybar no est√° funcionando despu√©s de la sincronizaci√≥n"
        notify-send "‚ùå Error Waybar" "No se pudo sincronizar correctamente" -t 3000 2>/dev/null || true
        return 1
    fi
}

# Ejecutar funci√≥n principal
main "$@"
