#!/bin/bash

# Control script para Pywal Auto-Sync Service

SERVICE_NAME="pywal-auto-sync.service"
LOG_FILE="$HOME/.cache/pywal-auto-sync.log"

case "$1" in
    start)
        echo "üöÄ Iniciando servicio de sincronizaci√≥n autom√°tica de pywal..."
        systemctl --user daemon-reload
        systemctl --user start "$SERVICE_NAME"
        systemctl --user enable "$SERVICE_NAME"
        echo "‚úÖ Servicio iniciado y habilitado"
        ;;
    stop)
        echo "‚èπÔ∏è Deteniendo servicio de sincronizaci√≥n autom√°tica de pywal..."
        systemctl --user stop "$SERVICE_NAME"
        echo "‚úÖ Servicio detenido"
        ;;
    restart)
        echo "üîÑ Reiniciando servicio de sincronizaci√≥n autom√°tica de pywal..."
        systemctl --user restart "$SERVICE_NAME"
        echo "‚úÖ Servicio reiniciado"
        ;;
    status)
        echo "üìä Estado del servicio:"
        systemctl --user status "$SERVICE_NAME" --no-pager
        ;;
    enable)
        echo "üîß Habilitando servicio para inicio autom√°tico..."
        systemctl --user daemon-reload
        systemctl --user enable "$SERVICE_NAME"
        echo "‚úÖ Servicio habilitado"
        ;;
    disable)
        echo "üîß Deshabilitando servicio..."
        systemctl --user disable "$SERVICE_NAME"
        echo "‚úÖ Servicio deshabilitado"
        ;;
    logs)
        if [[ -f "$LOG_FILE" ]]; then
            echo "üìã √öltimos logs del daemon:"
            tail -n 20 "$LOG_FILE"
        else
            echo "üìã Logs del sistema:"
            journalctl --user -u "$SERVICE_NAME" -n 20 --no-pager
        fi
        ;;
    test)
        echo "üß™ Probando sincronizaci√≥n manual..."
        if [[ -f "$HOME/.cache/current-wallpaper" ]]; then
            current_wallpaper=$(cat "$HOME/.cache/current-wallpaper")
            echo "Wallpaper actual: $current_wallpaper"
            echo "Aplicando pywal..."
            wal -i "$current_wallpaper" -n
            echo "‚úÖ Pywal aplicado manualmente"
            
            # Recargar Hyprland
            if command -v hyprctl >/dev/null 2>&1; then
                hyprctl reload
                echo "‚úÖ Hyprland recargado"
            fi
        else
            echo "‚ùå No se encontr√≥ wallpaper actual en cache"
        fi
        ;;
    install)
        echo "üì¶ Instalando sistema completo de sincronizaci√≥n autom√°tica..."
        
        # Recargar systemd
        systemctl --user daemon-reload
        
        # Habilitar e iniciar servicio
        systemctl --user enable "$SERVICE_NAME"
        systemctl --user start "$SERVICE_NAME"
        
        # Agregar al inicio de Hyprland si no est√°
        hypr_config="$HOME/.config/hypr/hyprland.conf"
        if [[ -f "$hypr_config" ]] && ! grep -q "pywal-auto-sync.service" "$hypr_config"; then
            echo "# Servicio de sincronizaci√≥n autom√°tica de pywal" >> "$hypr_config"
            echo "exec-once = systemctl --user start pywal-auto-sync.service" >> "$hypr_config"
            echo "‚úÖ Agregado al autostart de Hyprland"
        fi
        
        echo "‚úÖ Sistema instalado completamente"
        echo "üé® Pywal ahora se sincronizar√° autom√°ticamente cuando cambies el wallpaper"
        ;;
    uninstall)
        echo "üóëÔ∏è Desinstalando sistema de sincronizaci√≥n autom√°tica..."
        systemctl --user stop "$SERVICE_NAME"
        systemctl --user disable "$SERVICE_NAME"
        
        # Remover del autostart de Hyprland
        hypr_config="$HOME/.config/hypr/hyprland.conf"
        if [[ -f "$hypr_config" ]]; then
            sed -i '/pywal-auto-sync.service/d' "$hypr_config"
            sed -i '/# Servicio de sincronizaci√≥n autom√°tica de pywal/d' "$hypr_config"
        fi
        
        echo "‚úÖ Sistema desinstalado"
        ;;
    *)
        echo "üé® Pywal Auto-Sync Control"
        echo ""
        echo "Uso: $0 {start|stop|restart|status|enable|disable|logs|test|install|uninstall}"
        echo ""
        echo "Comandos:"
        echo "  start     - Iniciar el servicio"
        echo "  stop      - Detener el servicio"
        echo "  restart   - Reiniciar el servicio"
        echo "  status    - Ver estado del servicio"
        echo "  enable    - Habilitar inicio autom√°tico"
        echo "  disable   - Deshabilitar inicio autom√°tico"
        echo "  logs      - Ver logs recientes"
        echo "  test      - Probar sincronizaci√≥n manual"
        echo "  install   - Instalar y configurar todo el sistema"
        echo "  uninstall - Desinstalar el sistema completo"
        exit 1
        ;;
esac
