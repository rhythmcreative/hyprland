#!/bin/bash

# Script de limpieza para waybar
# Resuelve problemas de mÃºltiples instancias y procesos colgados

# FunciÃ³n de logging
log() {
    echo "$(date '+%H:%M:%S') [CLEANUP] - $1"
}

log "ðŸ§¹ Iniciando limpieza de waybar..."

# Matar todos los procesos de waybar
log "ðŸ›‘ Deteniendo todos los procesos de waybar..."
if pgrep -x waybar > /dev/null; then
    # Intentar terminaciÃ³n suave primero
    pkill -TERM waybar
    sleep 2
    
    # Si aÃºn quedan procesos, forzar terminaciÃ³n
    if pgrep -x waybar > /dev/null; then
        log "âš¡ Forzando terminaciÃ³n de waybar..."
        pkill -KILL waybar
        sleep 1
    fi
fi

# Limpiar archivos de lock
log "ðŸ—‘ï¸ Limpiando archivos de lock..."
rm -f /tmp/waybar_*.lock
rm -f /tmp/waybar_master_sync.lock
rm -f /tmp/waybar_master.pid

# Matar scripts de waybar que puedan estar ejecutÃ¡ndose
log "ðŸ›‘ Deteniendo scripts de waybar en background..."
scripts=(
    "waybar-pywal-sync"
    "sync-waybar-pywal"
    "waybar-fix-wallpaper-sync"
    "waybar-pywal-universal-sync"
    "waybar-pywal-auto-sync"
    "waybar-master-sync"
)

for script in "${scripts[@]}"; do
    pids=$(pgrep -f "$script")
    if [[ -n "$pids" ]]; then
        log "âš¡ Deteniendo $script (PIDs: $pids)"
        echo "$pids" | xargs kill -TERM 2>/dev/null || true
        sleep 0.3
    fi
done

# Verificar que no queden procesos
remaining=$(pgrep -x waybar)
if [[ -n "$remaining" ]]; then
    log "âš ï¸ AÃºn quedan procesos de waybar: $remaining"
    log "ðŸ”¥ Aplicando terminaciÃ³n forzada final..."
    echo "$remaining" | xargs kill -KILL 2>/dev/null || true
    sleep 1
else
    log "âœ… Todos los procesos de waybar eliminados"
fi

# Iniciar waybar limpio
log "ðŸš€ Iniciando waybar limpio..."
waybar > /dev/null 2>&1 &
new_pid=$!

# Verificar que se iniciÃ³ correctamente
sleep 2
if kill -0 "$new_pid" 2>/dev/null; then
    log "âœ… Waybar iniciado correctamente (PID: $new_pid)"
    notify-send "ðŸ§¹ Waybar Limpiado" "Waybar reiniciado con instancia Ãºnica" -t 3000 2>/dev/null || true
else
    log "âŒ Error al iniciar waybar"
    notify-send "âŒ Error" "No se pudo iniciar waybar despuÃ©s de la limpieza" -u critical -t 5000 2>/dev/null || true
    exit 1
fi

log "ðŸŽ‰ Limpieza de waybar completada exitosamente"
