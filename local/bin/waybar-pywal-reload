#!/bin/bash

# Script simplificado para recargar Waybar con pywal
# Enfoque directo y eficiente

LOG_FILE="$HOME/.cache/waybar-pywal-reload.log"

# FunciÃ³n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "ðŸ”„ Iniciando recarga de Waybar con colores pywal..."

# 1. Actualizar colores de waybar desde pywal actual
log "ðŸ“„ Actualizando colores..."
if [[ -f "$HOME/.cache/wal/colors.sh" ]]; then
    source "$HOME/.cache/wal/colors.sh"
    
    # Crear archivo de colores para waybar
    cat > "$HOME/.config/waybar/colors-pywal.css" << EOF
/* Colores generados automÃ¡ticamente por pywal */
@define-color background ${background};
@define-color foreground ${foreground};
@define-color cursor ${cursor};
@define-color color0 ${color0};
@define-color color1 ${color1};
@define-color color2 ${color2};
@define-color color3 ${color3};
@define-color color4 ${color4};
@define-color color5 ${color5};
@define-color color6 ${color6};
@define-color color7 ${color7};
@define-color color8 ${color8};
@define-color color9 ${color9};
@define-color color10 ${color10};
@define-color color11 ${color11};
@define-color color12 ${color12};
@define-color color13 ${color13};
@define-color color14 ${color14};
@define-color color15 ${color15};
EOF
    log "âœ… Colores actualizados exitosamente"
else
    log "âŒ No se encontraron colores de pywal"
    exit 1
fi

# 2. Reiniciar waybar
log "ðŸ”„ Reiniciando Waybar..."

# Matar waybar actual con timeout
if pgrep waybar > /dev/null; then
    log "â¹ï¸ Cerrando Waybar..."
    pkill waybar
    sleep 2
    
    # Si aÃºn estÃ¡ corriendo, forzar
    if pgrep waybar > /dev/null; then
        pkill -9 waybar
        sleep 1
    fi
fi

# 3. Iniciar waybar en background
log "ðŸš€ Iniciando Waybar..."
waybar &
sleep 2

# Verificar que estÃ© funcionando
if pgrep waybar > /dev/null; then
    log "âœ… Waybar iniciado correctamente"
    notify-send "ðŸŽ¨ Waybar" "Colores actualizados" -t 2000 2>/dev/null || true
else
    log "âŒ Error: Waybar no se iniciÃ³"
    notify-send "âŒ Error" "No se pudo reiniciar Waybar" -u critical -t 3000 2>/dev/null || true
    exit 1
fi

log "ðŸŽ‰ Recarga completada"
exit 0
