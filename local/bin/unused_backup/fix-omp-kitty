#!/usr/bin/env bash

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” FIX OH MY POSH KITTY â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Script para optimizar la visualizaciÃ³n de Oh My Posh en Kitty
# Mejora la renderizaciÃ³n de fuentes y sÃ­mbolos

echo "ðŸŽ¨ Optimizando Oh My Posh para Kitty..."

# Verificar que Oh My Posh estÃ© instalado
if ! command -v oh-my-posh &> /dev/null; then
    echo "âŒ Oh My Posh no estÃ¡ instalado"
    exit 1
fi

# Verificar que Kitty estÃ© corriendo
if ! pgrep -f kitty > /dev/null; then
    echo "âŒ Kitty no estÃ¡ en ejecuciÃ³n"
    exit 1
fi

# Variables
KITTY_CONFIG="$HOME/.config/kitty/kitty.conf"
OMP_CONFIG="$HOME/.config/oh-my-posh/pywal-theme.omp.json"

# FunciÃ³n para aplicar configuraciones de fuente optimizadas
apply_font_fixes() {
    echo "ðŸ”§ Aplicando configuraciones de fuente optimizadas..."
    
    # Crear respaldo de la configuraciÃ³n actual
    if [[ -f "$KITTY_CONFIG" ]]; then
        cp "$KITTY_CONFIG" "$KITTY_CONFIG.backup.$(date +%Y%m%d_%H%M%S)"
        echo "âœ… Respaldo creado: $KITTY_CONFIG.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    
    # Configuraciones adicionales para mejor renderizado
    cat >> "$KITTY_CONFIG" << 'EOF'

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” OH MY POSH OPTIMIZATIONS â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Optimizaciones especÃ­ficas para Oh My Posh
text_composition_strategy platform
disable_ligatures never

# ConfiguraciÃ³n de sÃ­mbolos y Unicode para mejor compatibilidad
symbol_map U+23FB-U+23FE,U+2665,U+26A1,U+2B58,U+E000-U+E00A,U+E0A0-U+E0A3,U+E0B0-U+E0C8,U+E0CA,U+E0CC-U+E0D2,U+E0D4,U+E200-U+E2A9,U+E300-U+E3E3,U+E5FA-U+E62F,U+E700-U+E7C5,U+F000-U+F2E0,U+F300-U+F31C,U+F400-U+F4A9,U+F500-U+F8FF,U+F0001-U+F1AF0 FiraCode Nerd Font Mono

# ConfiguraciÃ³n adicional para iconos especÃ­ficos de Oh My Posh
symbol_map U+F101,U+F116,U+F31B,U+F413,U+F401,U+E602,U+E702,U+E203,U+E20A,U+E20E FiraCode Nerd Font Mono

# Mejoras de rendering para terminal moderno
clear_all_shortcuts yes
map ctrl+shift+equal change_font_size all +2.0
map ctrl+shift+minus change_font_size all -2.0
map ctrl+shift+backspace change_font_size all 0

EOF
    
    echo "âœ… Configuraciones aplicadas a Kitty"
}

# FunciÃ³n para verificar fuentes necesarias
check_fonts() {
    echo "ðŸ” Verificando fuentes disponibles..."
    
    REQUIRED_FONTS=(
        "FiraCode Nerd Font"
        "JetBrainsMono Nerd Font"
        "Hack Nerd Font"
    )
    
    AVAILABLE_FONTS=()
    
    for font in "${REQUIRED_FONTS[@]}"; do
        if fc-list : family | grep -i "$font" > /dev/null; then
            echo "âœ… $font disponible"
            AVAILABLE_FONTS+=("$font")
        else
            echo "âŒ $font no disponible"
        fi
    done
    
    if [[ ${#AVAILABLE_FONTS[@]} -eq 0 ]]; then
        echo "âŒ No hay fuentes Nerd Font disponibles"
        echo "ðŸ’¡ Instala fuentes Nerd Font con: yay -S nerd-fonts"
        return 1
    fi
    
    echo "âœ… ${#AVAILABLE_FONTS[@]} fuentes compatibles encontradas"
    return 0
}

# FunciÃ³n para optimizar el tema de Oh My Posh
optimize_omp_theme() {
    echo "ðŸŽ¨ Optimizando tema de Oh My Posh..."
    
    if [[ -f "$OMP_CONFIG" ]]; then
        # Crear respaldo del tema
        cp "$OMP_CONFIG" "$OMP_CONFIG.backup.$(date +%Y%m%d_%H%M%S)"
        
        # Actualizar algunos sÃ­mbolos para mejor compatibilidad
        sed -i 's/\\u276f/âž¤/g' "$OMP_CONFIG"
        sed -i 's/\\ud83d\\udca5/ðŸ’¥/g' "$OMP_CONFIG"
        sed -i 's/\\u2728/âœ¨/g' "$OMP_CONFIG"
        sed -i 's/\\ud83d\\udd50/ðŸ•/g' "$OMP_CONFIG"
        
        echo "âœ… Tema optimizado para mejor compatibilidad"
    else
        echo "âš ï¸ No se encontrÃ³ el tema personalizado de Oh My Posh"
    fi
}

# FunciÃ³n para aplicar variables de entorno
set_environment() {
    echo "ðŸ”§ Configurando variables de entorno..."
    
    # Variables para mejor renderizado de Oh My Posh
    export TERM=xterm-256color
    export COLORTERM=truecolor
    
    echo "âœ… Variables de entorno configuradas"
}

# FunciÃ³n para refrescar Kitty
refresh_kitty() {
    echo "ðŸ”„ Refrescando configuraciÃ³n de Kitty..."
    
    # Intentar recargar la configuraciÃ³n de Kitty
    if command -v kitty @ &> /dev/null; then
        kitty @ load-config || echo "âš ï¸ No se pudo recargar la configuraciÃ³n automÃ¡ticamente"
    fi
    
    echo "ðŸ’¡ Reinicia Kitty para aplicar todos los cambios"
}

# FunciÃ³n para mostrar informaciÃ³n Ãºtil
show_info() {
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” INFORMACIÃ“N ÃšTIL â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ðŸŽ¨ Fuente recomendada aplicada: FiraCode Nerd Font Mono"
    echo "ðŸ“ TamaÃ±o de fuente: 13.0"
    echo "ðŸŽ¯ Tema activo: pywal-theme.omp.json"
    echo ""
    echo "ðŸ”§ Comandos Ãºtiles:"
    echo "   fix-omp-kitty       - Ejecutar este script de nuevo"
    echo "   omp-sync           - Sincronizar tema con pywal"
    echo "   switch-prompt omp  - Activar Oh My Posh"
    echo ""
    echo "ðŸ’¡ Si los sÃ­mbolos no se ven bien:"
    echo "   1. Reinicia Kitty completamente"
    echo "   2. Verifica que la fuente sea correcta en Kitty > ConfiguraciÃ³n"
    echo "   3. Ejecuta: kitty +kitten unicode_input"
    echo ""
}

# FunciÃ³n principal
main() {
    echo "ðŸš€ Iniciando optimizaciÃ³n de Oh My Posh para Kitty..."
    echo ""
    
    check_fonts || exit 1
    apply_font_fixes
    optimize_omp_theme
    set_environment
    refresh_kitty
    
    echo ""
    echo "âœ… OptimizaciÃ³n completada!"
    show_info
}

# Verificar argumentos
case "${1:-}" in
    "--help"|"-h")
        echo "fix-omp-kitty - Optimiza Oh My Posh para Kitty"
        echo ""
        echo "Uso: fix-omp-kitty [opciones]"
        echo ""
        echo "Opciones:"
        echo "  --help, -h     Mostrar esta ayuda"
        echo "  --fonts        Solo verificar fuentes"
        echo "  --theme        Solo optimizar tema"
        echo ""
        exit 0
        ;;
    "--fonts")
        check_fonts
        exit 0
        ;;
    "--theme")
        optimize_omp_theme
        exit 0
        ;;
    *)
        main
        ;;
esac
