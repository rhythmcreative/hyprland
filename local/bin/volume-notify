#!/bin/bash

# Script moderno para controlar el volumen con notificaciones elegantes

# Funci√≥n para generar barra de progreso
generate_bar() {
    local percent=$1
    local bar_length=15
    local filled=$(( percent * bar_length / 100 ))
    local empty=$(( bar_length - filled ))
    
    local bar=""
    for ((i=0; i<filled; i++)); do
        bar+="‚ñà"
    done
    for ((i=0; i<empty; i++)); do
        bar+="‚ñë"
    done
    
    echo "$bar"
}

# Funci√≥n para obtener el volumen actual
get_volume() {
    wpctl get-volume @DEFAULT_AUDIO_SINK@ | awk '{print int($2 * 100)}'
}

# Funci√≥n para verificar si est√° muteado
is_muted() {
    wpctl get-volume @DEFAULT_AUDIO_SINK@ | grep -q "MUTED"
}

# Funci√≥n para obtener icono seg√∫n el volumen
get_volume_icon() {
    local volume=$1
    if [ "$volume" -eq 0 ]; then
        echo "üîá"
    elif [ "$volume" -lt 30 ]; then
        echo "üîà"
    elif [ "$volume" -lt 70 ]; then
        echo "üîâ"
    else
        echo "üîä"
    fi
}

# Funci√≥n para mostrar notificaci√≥n
show_notification() {
    local volume=$1
    local muted=$2
    
    if [ "$muted" = "true" ]; then
        local bar="$(generate_bar 0)"
        notify-send -a "volume" -u low -t 1200 \
                   -h string:x-canonical-private-synchronous:volume \
                   "üîá Audio" "<b>MUTED</b>\n$bar 0%"
    else
        local icon=$(get_volume_icon $volume)
        local bar="$(generate_bar $volume)"
        notify-send -a "volume" -u low -t 1200 \
                   -h string:x-canonical-private-synchronous:volume \
                   "$icon Audio" "<b>$volume%</b>\n$bar"
    fi
}

# Funci√≥n para actualizar Waybar (deshabilitada para evitar reinicios)
# update_waybar() {
#     # Enviar se√±al SIGUSR2 a Waybar para actualizar el m√≥dulo de audio
#     pkill -SIGUSR2 waybar 2>/dev/null || true
# }

# Procesar argumentos
case $1 in
    up)
        wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%+
        # Asegurar que no exceda 100%
        current=$(get_volume)
        if [ "$current" -gt 100 ]; then
            wpctl set-volume @DEFAULT_AUDIO_SINK@ 100%
        fi
        ;;
    down)
        wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%-
        ;;
    mute)
        wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
        ;;
    *)
        echo "Uso: $0 {up|down|mute}"
        exit 1
        ;;
esac

# Obtener estado actual
volume=$(get_volume)
muted=$(is_muted && echo "true" || echo "false")

# Mostrar notificaci√≥n
show_notification "$volume" "$muted"

# Actualizar Waybar (comentado para evitar reinicios)
# update_waybar

exit 0
