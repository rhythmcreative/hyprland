#!/bin/bash
# Dir Suggestions - Mejora el autocompletado de directorios en Kitty
# Uso: dir-suggestions [patr√≥n]

PATTERN="${1:-}"

# Colores para la salida
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${CYAN}Dir Suggestions - Autocompletado inteligente de directorios${NC}"
    echo ""
    echo -e "${YELLOW}Uso:${NC}"
    echo "  dir-suggestions [patr√≥n]"
    echo ""
    echo -e "${YELLOW}Caracter√≠sticas:${NC}"
    echo "  ‚Ä¢ Muestra directorios frecuentes (zoxide)"
    echo "  ‚Ä¢ Busca en CDPATH configurado"
    echo "  ‚Ä¢ Sugiere directorios con fuzzy matching"
    echo "  ‚Ä¢ Integraci√≥n con FZF"
    echo ""
    echo -e "${YELLOW}Comandos √∫tiles:${NC}"
    echo "  z [directorio]     # Saltar a directorio frecuente"
    echo "  zi                 # Navegaci√≥n interactiva con FZF"
    echo "  Alt+C              # FZF directory picker"
}

# Si no hay patr√≥n, mostrar ayuda y directorios frecuentes
if [ -z "$PATTERN" ]; then
    show_help
    echo ""
    echo -e "${GREEN}Directorios m√°s visitados (zoxide):${NC}"
    if command -v zoxide >/dev/null 2>&1; then
        zoxide query --list --score | head -10 | while read -r score path; do
            echo -e "  ${BLUE}$(printf "%3.0f" "$score")${NC} $path"
        done
    else
        echo "  zoxide no est√° instalado"
    fi
    echo ""
    echo -e "${GREEN}Directorios en CDPATH:${NC}"
    if [ -n "$CDPATH" ]; then
        IFS=':' read -ra PATHS <<< "$CDPATH"
        for path in "${PATHS[@]}"; do
            if [ -d "$path" ] && [ "$path" != "." ]; then
                echo -e "  ${MAGENTA}$path${NC}"
                # Mostrar subdirectorios del primer nivel
                find "$path" -maxdepth 1 -type d -name "*$PATTERN*" 2>/dev/null | head -5 | while read -r dir; do
                    [ "$dir" != "$path" ] && echo -e "    ${CYAN}$(basename "$dir")${NC}"
                done
            fi
        done
    fi
    exit 0
fi

# Buscar directorios que coincidan con el patr√≥n
echo -e "${GREEN}Sugerencias para '${YELLOW}$PATTERN${GREEN}':${NC}"
echo ""

# 1. Buscar en zoxide
if command -v zoxide >/dev/null 2>&1; then
    echo -e "${BLUE}üìÅ Directorios frecuentes:${NC}"
    zoxide query --list | grep -i "$PATTERN" | head -5 | while read -r path; do
        echo -e "  ${CYAN}z $(basename "$path")${NC} ‚Üí $path"
    done
    echo ""
fi

# 2. Buscar en directorio actual
echo -e "${BLUE}üìÇ En directorio actual:${NC}"
find . -maxdepth 2 -type d -name "*$PATTERN*" 2>/dev/null | head -5 | while read -r dir; do
    echo -e "  ${GREEN}$dir${NC}"
done
echo ""

# 3. Buscar en CDPATH
if [ -n "$CDPATH" ]; then
    echo -e "${BLUE}üîç En CDPATH:${NC}"
    IFS=':' read -ra PATHS <<< "$CDPATH"
    for path in "${PATHS[@]}"; do
        if [ -d "$path" ] && [ "$path" != "." ]; then
            find "$path" -maxdepth 2 -type d -name "*$PATTERN*" 2>/dev/null | head -3 | while read -r dir; do
                echo -e "  ${MAGENTA}$dir${NC}"
            done
        fi
    done
    echo ""
fi

echo -e "${YELLOW}üí° Consejo: Usa ${GREEN}zi${YELLOW} para navegaci√≥n interactiva con FZF${NC}"
