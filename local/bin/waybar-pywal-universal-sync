#!/bin/bash

# Script universal para sincronizar Waybar con pywal
# Funciona tanto con imÃ¡genes estÃ¡ticas como con GIFs

COLORS_CSS_SOURCE="$HOME/.cache/wal/colors.css"
WAYBAR_COLORS_TARGET="$HOME/.config/waybar/colors-pywal.css"
CURRENT_WALLPAPER_FILE="$HOME/.cache/current-wallpaper"
LOG_FILE="$HOME/.cache/waybar-pywal-sync.log"

# FunciÃ³n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

log "=== Iniciando sincronizaciÃ³n universal Waybar-Pywal ==="

# Verificar dependencias crÃ­ticas
missing_deps=()
for dep in wal swww waybar; do
    if ! command -v "$dep" > /dev/null 2>&1; then
        missing_deps+=("$dep")
    fi
done

if [[ ${#missing_deps[@]} -gt 0 ]]; then
    log "ERROR: Faltan dependencias: ${missing_deps[*]}"
    notify-send "âŒ Error de Dependencias" "Faltan: ${missing_deps[*]}"
    exit 1
fi

# Verificar que pywal ya se ejecutÃ³
if [[ ! -f "$COLORS_CSS_SOURCE" ]]; then
    log "ERROR: No se encontrÃ³ $COLORS_CSS_SOURCE. Pywal no se ha ejecutado."
    notify-send "âš ï¸ Advertencia" "Los colores de pywal no estÃ¡n disponibles"
    exit 1
fi

# FunciÃ³n para convertir CSS de pywal a formato Waybar
convert_pywal_to_waybar() {
    local input_file="$1"
    local output_file="$2"
    
    # Crear directorio si no existe
    mkdir -p "$(dirname "$output_file")"
    
    {
        echo "/* Waybar colors generated from pywal - $(date) */"
        
        # Extraer colores principales
        grep -E "^\s*--background:" "$input_file" | sed 's/--background: \(.*\);/@define-color background \1;/'
        grep -E "^\s*--foreground:" "$input_file" | sed 's/--foreground: \(.*\);/@define-color foreground \1;/'
        grep -E "^\s*--cursor:" "$input_file" | sed 's/--cursor: \(.*\);/@define-color cursor \1;/'
        
        # Extraer colores numerados (0-15)
        for i in {0..15}; do
            grep -E "^\s*--color$i:" "$input_file" | sed "s/--color$i: \(.*\);/@define-color color$i \1;/"
        done
        
    } > "$output_file"
    
    return $?
}

# Realizar conversiÃ³n de colores
log "Convirtiendo colores de pywal a formato Waybar..."
if convert_pywal_to_waybar "$COLORS_CSS_SOURCE" "$WAYBAR_COLORS_TARGET"; then
    log "âœ… Colores convertidos exitosamente"
else
    log "âŒ Error en conversiÃ³n de colores"
    notify-send "âŒ Error" "FallÃ³ la conversiÃ³n de colores"
    exit 1
fi

# FunciÃ³n para recargar/reiniciar Waybar de manera inteligente
reload_waybar() {
    log "Iniciando recarga de Waybar..."
    
    if pgrep -x waybar > /dev/null; then
        log "Waybar estÃ¡ corriendo, intentando recarga suave..."
        
        # Intentar recarga con seÃ±al USR2
        if pkill -USR2 waybar 2>/dev/null; then
            log "Recarga suave exitosa (USR2)"
            sleep 0.5
            
            # Verificar que waybar sigue corriendo despuÃ©s de la recarga
            if pgrep -x waybar > /dev/null; then
                log "âœ… Waybar recargado correctamente"
                return 0
            else
                log "âš ï¸ Waybar se cerrÃ³ despuÃ©s de la recarga suave, reiniciando..."
            fi
        else
            log "âš ï¸ Recarga suave fallÃ³, procediendo con reinicio..."
        fi
        
        # Si llegamos aquÃ­, necesitamos reiniciar
        log "Matando proceso de Waybar..."
        pkill waybar
        sleep 1
    else
        log "Waybar no estÃ¡ corriendo"
    fi
    
    # Iniciar Waybar
    log "Iniciando Waybar..."
    nohup waybar > /dev/null 2>&1 &
    
    # Esperar a que Waybar estÃ© completamente cargado
    local attempts=0
    while [[ $attempts -lt 15 ]] && ! pgrep -x waybar > /dev/null; do
        sleep 0.3
        ((attempts++))
    done
    
    if pgrep -x waybar > /dev/null; then
        log "âœ… Waybar iniciado exitosamente"
        return 0
    else
        log "âŒ Error: No se pudo iniciar Waybar"
        return 1
    fi
}

# Recargar Waybar
if reload_waybar; then
    log "Waybar sincronizado exitosamente"
    
    # Verificar tipo de wallpaper para optimizaciones adicionales
    if [[ -f "$CURRENT_WALLPAPER_FILE" ]]; then
        current_wallpaper=$(cat "$CURRENT_WALLPAPER_FILE")
        
        if [[ -f "$current_wallpaper" && "${current_wallpaper,,}" == *.gif ]]; then
            log "Wallpaper actual es GIF, aplicando optimizaciones adicionales..."
            
            # Para GIFs, asegurar que swww-daemon estÃ© corriendo
            if ! pgrep -x "swww-daemon" > /dev/null; then
                log "Iniciando swww-daemon para GIF..."
                swww-daemon --format xrgb &
                sleep 2
            fi
            
            # Reaplicar el GIF para asegurar animaciÃ³n
            {
                sleep 1
                swww img "$current_wallpaper" --transition-type none --transition-duration 0.1 > /dev/null 2>&1
                log "GIF re-aplicado para mantener animaciÃ³n"
            } &
            
            notify-send "ğŸ¨âœ¨ Waybar + GIF Sincronizado" "Colores y animaciÃ³n actualizados"
        else
            notify-send "ğŸ¨ Waybar Sincronizado" "Colores actualizados con pywal"
        fi
    else
        notify-send "ğŸ¨ Waybar Sincronizado" "Colores actualizados"
    fi
else
    log "âŒ Error en sincronizaciÃ³n de Waybar"
    notify-send "âŒ Error" "No se pudo sincronizar Waybar"
    exit 1
fi

log "=== SincronizaciÃ³n universal completada ==="
