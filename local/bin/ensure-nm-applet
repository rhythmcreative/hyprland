#!/bin/bash

# ensure-nm-applet - Garantiza que nm-applet estÃ© siempre corriendo
# Este script puede ser ejecutado despuÃ©s de sincronizaciones o como watchdog

LOG_FILE="$HOME/.cache/ensure-nm-applet.log"

# FunciÃ³n de logging
log() {
    echo "[$(date '+%H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# FunciÃ³n para verificar y iniciar nm-applet si es necesario
ensure_nm_applet() {
    if ! pgrep -x nm-applet > /dev/null; then
        log "ğŸ”„ nm-applet no estÃ¡ corriendo, iniciando..."
        
        # Iniciar con variables de entorno optimizadas
        env GTK_THEME="Arc-Dark" \
            GDK_BACKEND="wayland,x11" \
            nohup nm-applet > /dev/null 2>&1 &
        
        sleep 2
        
        if pgrep -x nm-applet > /dev/null; then
            log "âœ… nm-applet iniciado exitosamente"
            notify-send "ğŸ“¶ nm-applet" "Reiniciado automÃ¡ticamente" -t 2000 2>/dev/null || true
        else
            # Fallback: sin variables de entorno
            log "âš ï¸ Intentando fallback..."
            nohup nm-applet > /dev/null 2>&1 &
            sleep 2
            
            if pgrep -x nm-applet > /dev/null; then
                log "âœ… nm-applet iniciado en modo fallback"
                notify-send "ğŸ“¶ nm-applet" "Iniciado en modo fallback" -t 2000 2>/dev/null || true
            else
                log "âŒ ERROR: No se pudo iniciar nm-applet"
                notify-send "âŒ Error" "nm-applet no se pudo iniciar" -t 3000 2>/dev/null || true
                return 1
            fi
        fi
    else
        log "âœ… nm-applet ya estÃ¡ corriendo correctamente"
    fi
    return 0
}

# Ejecutar funciÃ³n principal
ensure_nm_applet
