#!/bin/bash

# Watcher para sincronizaci√≥n autom√°tica nm-applet ‚Üî waybar
# Monitorea cambios en los archivos de colores y sincroniza autom√°ticamente

LOG_FILE="$HOME/.cache/nm-applet-watcher.log"
WAYBAR_COLORS_FILE="$HOME/.config/waybar/colors-pywal.css"
PYWAL_COLORS_FILE="$HOME/.cache/wal/colors.sh"
SYNC_SCRIPT="$HOME/.local/bin/nm-applet-waybar-sync"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Funci√≥n para limpiar al salir
cleanup() {
    log "üõë Deteniendo watcher nm-applet-waybar..."
    exit 0
}

# Configurar se√±ales de salida
trap cleanup SIGTERM SIGINT

log "üëÅÔ∏è Iniciando watcher nm-applet-waybar..."
log "üìÅ Monitoreando: $WAYBAR_COLORS_FILE"
log "üìÅ Monitoreando: $PYWAL_COLORS_FILE"

# Verificar dependencias
if ! command -v inotifywait > /dev/null; then
    log "‚ùå ERROR: inotifywait no est√° instalado (paquete: inotify-tools)"
    notify-send "‚ùå Error Watcher" "inotify-tools no est√° instalado" -u critical
    exit 1
fi

if [[ ! -f "$SYNC_SCRIPT" ]]; then
    log "‚ùå ERROR: Script de sincronizaci√≥n no encontrado: $SYNC_SCRIPT"
    exit 1
fi

# Funci√≥n de sincronizaci√≥n con throttling
last_sync_time=0
sync_with_throttle() {
    local current_time=$(date +%s)
    local time_diff=$((current_time - last_sync_time))
    
    # Throttling: esperar al menos 2 segundos entre sincronizaciones
    if [[ $time_diff -lt 2 ]]; then
        log "‚è≥ Sincronizaci√≥n throttled (esperando ${time_diff}s m√°s...)"
        return
    fi
    
    log "üîÑ Ejecutando sincronizaci√≥n nm-applet..."
    last_sync_time=$current_time
    
    if bash "$SYNC_SCRIPT" >> "$LOG_FILE" 2>&1; then
        log "‚úÖ Sincronizaci√≥n completada exitosamente"
        notify-send "üé® Auto-Sync" "nm-applet sincronizado con waybar" -t 1500 || true
    else
        log "‚ùå Error en la sincronizaci√≥n"
        notify-send "‚ùå Error Auto-Sync" "Fallo en sincronizaci√≥n nm-applet" -u critical -t 3000 || true
    fi
}

# Ejecutar sincronizaci√≥n inicial
log "üöÄ Ejecutando sincronizaci√≥n inicial..."
sync_with_throttle

# Crear directorios si no existen
mkdir -p "$(dirname "$WAYBAR_COLORS_FILE")"
mkdir -p "$(dirname "$PYWAL_COLORS_FILE")"

# Funci√≥n principal de monitoreo
monitor_changes() {
    log "üëÅÔ∏è Iniciando monitoreo de archivos..."
    
    # Monitorear ambos archivos
    while true; do
        # Usar inotifywait para monitorear cambios
        if inotifywait -e modify,create,close_write -t 300 \
            "$WAYBAR_COLORS_FILE" "$PYWAL_COLORS_FILE" 2>/dev/null; then
            
            log "üìù Detectado cambio en archivos de colores"
            sleep 0.5  # Peque√±a pausa para evitar sincronizaciones m√∫ltiples
            sync_with_throttle
        else
            # Timeout - verificar cada 5 minutos si todo sigue funcionando
            local exit_code=$?
            if [[ $exit_code -eq 2 ]]; then  # Timeout
                log "‚è∞ Timeout de monitoreo (normal) - continuando..."
                continue
            else
                log "‚ö†Ô∏è Error en inotifywait (c√≥digo: $exit_code) - reintentando..."
                sleep 5
                continue
            fi
        fi
    done
}

# Iniciar monitoreo
monitor_changes &
MONITOR_PID=$!

log "‚úÖ Watcher iniciado (PID: $$, Monitor PID: $MONITOR_PID)"
log "üí° Para detener: kill $$"

# Mantenerse ejecutando y manejar se√±ales
while true; do
    sleep 30
    # Verificar que el proceso de monitoreo siga corriendo
    if ! kill -0 $MONITOR_PID 2>/dev/null; then
        log "‚ö†Ô∏è Proceso de monitoreo termin√≥ inesperadamente, reiniciando..."
        monitor_changes &
        MONITOR_PID=$!
    fi
done
