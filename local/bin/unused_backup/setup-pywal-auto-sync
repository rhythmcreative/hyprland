#!/bin/bash

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                    CONFIGURACI√ìN DE PYWAL AUTO-SYNC                         ‚ïë
# ‚ïë     Configurar sincronizaci√≥n autom√°tica completa de pywal con P10k/Kitty   ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

set -euo pipefail

echo "üöÄ Configurando sincronizaci√≥n autom√°tica de pywal..."

# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ CONFIGURACI√ìN DE TEMPLATES ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

# Crear directorio de templates si no existe
mkdir -p ~/.config/wal/templates

# Template mejorado para Kitty con configuraciones adicionales
cat > ~/.config/wal/templates/colors-kitty.conf << 'EOF'
# Kitty color scheme generated by 'wal' con configuraciones adicionales
foreground {foreground}
background {background}
selection_foreground {color0}
selection_background {color7}
url_color {color4}
cursor {foreground}
cursor_text_color {background}

# Bordes de ventana con colores din√°micos
active_border_color {color4}
inactive_border_color {color0}
bell_border_color {color1}

# Tabs con mejor integraci√≥n
active_tab_background {color4}
active_tab_foreground {background}
inactive_tab_background {color8}
inactive_tab_foreground {color15}
tab_bar_background {color0}

# Normal colors
color0 {color0}
color1 {color1}
color2 {color2}
color3 {color3}
color4 {color4}
color5 {color5}
color6 {color6}
color7 {color7}

# Bright colors
color8 {color8}
color9 {color9}
color10 {color10}
color11 {color11}
color12 {color12}
color13 {color13}
color14 {color14}
color15 {color15}
EOF

echo "‚úÖ Template de Kitty mejorado creado"

# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ CONFIGURAR HOOKS DE PYWAL ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

# Hook post-generation para ejecutar autom√°ticamente la sincronizaci√≥n
cat > ~/.cache/wal/post-script.sh << 'EOF'
#!/bin/bash

# Post-script ejecutado autom√°ticamente por pywal despu√©s de generar colores
# Ejecutar sincronizaci√≥n autom√°tica
if [[ -x "$HOME/.local/bin/pywal-auto-sync" ]]; then
    echo "üé® Ejecutando sincronizaci√≥n autom√°tica post-pywal..."
    "$HOME/.local/bin/pywal-auto-sync" &
    
    # Notificar a terminales activos despu√©s de un breve delay
    (
        sleep 1.5
        pkill -USR1 zsh 2>/dev/null || true
        pkill -USR1 kitty 2>/dev/null || true
        echo "üîÑ Terminales notificados para recarga"
    ) &
fi
EOF

chmod +x ~/.cache/wal/post-script.sh
echo "‚úÖ Hook post-script configurado"

# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ FUNCI√ìN CONVENIENTE EN ZSH ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

# Funci√≥n para cambiar wallpaper y sincronizar autom√°ticamente
cat >> ~/.zshrc << 'EOF'

# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ FUNCIONES PYWAL AUTO-SYNC ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

# Funci√≥n para cambiar wallpaper y sincronizar autom√°ticamente todo
pywal-set() {
    local image_path="$1"
    
    if [[ -z "$image_path" ]]; then
        echo "‚ùå Uso: pywal-set /ruta/a/imagen"
        echo "üí° Ejemplo: pywal-set ~/Pictures/wallpaper.jpg"
        return 1
    fi
    
    if [[ ! -f "$image_path" ]]; then
        echo "‚ùå Error: Archivo no encontrado: $image_path"
        return 1
    fi
    
    echo "üé® Aplicando wallpaper y sincronizando themes..."
    
    # Generar colores con pywal
    wal -i "$image_path" -q
    
    # La sincronizaci√≥n se ejecutar√° autom√°ticamente via hook
    echo "‚úÖ Wallpaper aplicado. Sincronizaci√≥n en progreso..."
    echo "üîÑ Los cambios se aplicar√°n autom√°ticamente en pocos segundos"
    
    # Opcional: recargar el prompt actual inmediatamente
    if [[ "${+functions[p10k]}" == 1 ]]; then
        (
            sleep 2
            [[ -f "$HOME/.cache/wal/p10k-colors.zsh" ]] && source "$HOME/.cache/wal/p10k-colors.zsh"
            p10k reload 2>/dev/null || true
            zle && zle reset-prompt 2>/dev/null || true
        ) &
    fi
}

# Funci√≥n para mostrar estado de sincronizaci√≥n
pywal-status() {
    echo "üìä Estado de PyWal Auto-Sync:"
    
    # Verificar archivos principales
    local files=(
        "$HOME/.cache/wal/colors.json:Colores de pywal"
        "$HOME/.cache/wal/colors-kitty.conf:Configuraci√≥n de Kitty"
        "$HOME/.cache/wal/p10k-colors.zsh:Colores de Powerlevel10k"
    )
    
    for file_info in "${files[@]}"; do
        local file="${file_info%:*}"
        local desc="${file_info#*:}"
        
        if [[ -f "$file" ]]; then
            local age=$(($(date +%s) - $(stat -c %Y "$file" 2>/dev/null || echo 0)))
            local age_text
            
            if (( age < 60 )); then
                age_text="${age}s"
            elif (( age < 3600 )); then
                age_text="$((age / 60))m"
            else
                age_text="$((age / 3600))h"
            fi
            
            echo "  ‚úÖ $desc (actualizado hace ${age_text})"
        else
            echo "  ‚ùå $desc (no encontrado)"
        fi
    done
    
    # Mostrar colores actuales
    if [[ -f "$HOME/.cache/wal/colors.sh" ]]; then
        echo ""
        echo "üé® Colores actuales:"
        source "$HOME/.cache/wal/colors.sh"
        echo "  Background: $background"
        echo "  Foreground: $foreground" 
        echo "  Accent: $color4"
    fi
}

# Aliases adicionales para comodidad
alias wal-set='pywal-set'        # Alias corto
alias theme-status='pywal-status' # Ver estado
alias wallpaper='pywal-set'       # Alias intuitivo

EOF

echo "‚úÖ Funciones a√±adidas a .zshrc"

# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ PRUEBA DE CONFIGURACI√ìN ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

echo ""
echo "üß™ Probando configuraci√≥n..."

# Verificar que pywal est√© instalado
if ! command -v wal >/dev/null 2>&1; then
    echo "‚ö†Ô∏è Advertencia: pywal no est√° instalado"
    echo "üí° Inst√°lalo con: pip install pywal"
fi

# Verificar que el script principal est√© disponible y ejecutable
if [[ -x "$HOME/.local/bin/pywal-auto-sync" ]]; then
    echo "‚úÖ Script principal disponible y ejecutable"
else
    echo "‚ùå Error: Script principal no disponible o no ejecutable"
    echo "üí° Ejecuta: chmod +x ~/.local/bin/pywal-auto-sync"
fi

# Verificar que kitty est√© instalado
if command -v kitty >/dev/null 2>&1; then
    echo "‚úÖ Kitty disponible"
else
    echo "‚ö†Ô∏è Advertencia: Kitty no est√° instalado"
fi

# Verificar que powerlevel10k est√© instalado
if [[ -d "$HOME/.oh-my-zsh/custom/themes/powerlevel10k" ]]; then
    echo "‚úÖ Powerlevel10k disponible"
else
    echo "‚ö†Ô∏è Advertencia: Powerlevel10k no encontrado"
fi

echo ""
echo "üéâ ¬°Configuraci√≥n completada!"
echo ""
echo "üìã C√ìMO USAR:"
echo "  ‚Ä¢ pywal-set /ruta/a/imagen    - Cambiar wallpaper y sincronizar todo"
echo "  ‚Ä¢ pywal-sync                  - Sincronizar manualmente" 
echo "  ‚Ä¢ pywal-status                - Ver estado de sincronizaci√≥n"
echo "  ‚Ä¢ theme-sync                  - Sincronizar y recargar terminal"
echo ""
echo "üîÑ PARA APLICAR CAMBIOS:"
echo "  ‚Ä¢ Ejecuta: source ~/.zshrc"
echo "  ‚Ä¢ O reinicia tu terminal"
echo ""
echo "üí° NOTA: La sincronizaci√≥n ahora es completamente autom√°tica."
echo "   Cada vez que uses 'wal -i imagen', se sincronizar√°n autom√°ticamente"
echo "   Powerlevel10k y Kitty sin intervenci√≥n manual."
