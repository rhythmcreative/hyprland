#!/bin/bash

# Script completo para sincronizaciÃ³n de wallpaper con SDDM automÃ¡tico
# Ejecutado por: Super + Shift + W en Hyprland
# Autor: rhythmcreative

LOG_FILE="/tmp/wallpaper-sync-complete.log"
USER_HOME="/home/rhythmcreative"
SDDM_THEME_PATH="/usr/share/sddm/themes/sddm-astronaut-theme"

# FunciÃ³n de logging
log() {
    echo "[$(date '+%H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# FunciÃ³n para mostrar notificaciones
notify() {
    if command -v notify-send > /dev/null 2>&1; then
        notify-send "Wallpaper Sync" "$1" -i preferences-desktop-wallpaper
    fi
}

log "ğŸ¨ Iniciando sincronizaciÃ³n completa: Wallpaper + Waybar + P10k/OMP + SDDM"
notify "Iniciando sincronizaciÃ³n completa..."

# Paso 1: Selector de wallpaper con sincronizaciÃ³n de Waybar
log "ğŸ–¼ï¸ Paso 1: Ejecutando selector de wallpaper..."
if ~/.local/bin/wallpaper-changer-with-waybar-sync; then
    log "âœ… Wallpaper y Waybar sincronizados correctamente"
    
    # Esperar un momento para que pywal complete
    sleep 2
    
    # Paso 2: SincronizaciÃ³n de shell prompt (P10k o OMP)
    log "ğŸ¨ Paso 2: Sincronizando shell prompt..."
    
    # Intentar P10k primero, luego OMP
    if ~/.local/bin/p10k-pywal-sync > /dev/null 2>&1; then
        log "âœ… Powerlevel10k sincronizado"
    elif ~/.local/bin/sync-omp-pywal > /dev/null 2>&1; then
        log "âœ… Oh My Posh sincronizado"
    else
        log "âš ï¸ No se encontrÃ³ P10k ni OMP, continuando..."
    fi
    
    # Paso 3: SincronizaciÃ³n automÃ¡tica de SDDM
    log "ğŸ” Paso 3: Sincronizando SDDM wallpaper automÃ¡ticamente..."
    
    # Usar nuestro script mejorado de sincronizaciÃ³n SDDM
    if ~/.local/bin/sddm-auto-sync 2>/dev/null; then
        log "âœ… SDDM sincronizado automÃ¡ticamente"
    else
        log "âš ï¸ Error en sincronizaciÃ³n automÃ¡tica de SDDM, intentando mÃ©todos alternativos..."
        
        # Fallback: intentar mÃ©todos alternativos
        CURRENT_WALLPAPER=$(cat ~/.cache/wal/wal 2>/dev/null || echo "")
        if [[ -n "$CURRENT_WALLPAPER" ]] && [[ -f "$CURRENT_WALLPAPER" ]]; then
            log "ğŸ“¸ Wallpaper detectado: $(basename "$CURRENT_WALLPAPER")"
            
            # Fallback con el script del tema astronaut
            if [[ -f "$SDDM_THEME_PATH/pywal-sync.sh" ]]; then
                if sudo "$SDDM_THEME_PATH/pywal-sync.sh" 2>/dev/null; then
                    log "âœ… SDDM sincronizado usando tema astronaut"
                else
                    log "âŒ Fallo al sincronizar SDDM - permisos insuficientes"
                fi
            else
                log "âš ï¸ No se encontrÃ³ script de SDDM, saltando sincronizaciÃ³n"
            fi
        else
            log "âš ï¸ No se pudo detectar wallpaper actual, saltando sincronizaciÃ³n de SDDM"
        fi
    fi
    
    # Paso 4: Aplicar colores adicionales si hay scripts disponibles
    log "ğŸ¨ Paso 4: Aplicando colores adicionales..."
    
    # Sincronizar otros componentes si existen
    ~/.local/bin/sync-kitty-pywal > /dev/null 2>&1 || true
    ~/.local/bin/dunst-pywal-sync > /dev/null 2>&1 || true
    ~/.local/bin/vesktop-pywal-sync > /dev/null 2>&1 || true
    
    log "ğŸ‰ Â¡SincronizaciÃ³n completa exitosa!"
    log "ğŸ’¡ Todos los componentes sincronizados con el nuevo wallpaper"
    
    notify "âœ… SincronizaciÃ³n completa exitosa! Wallpaper, temas y SDDM actualizados"
    
else
    log "âŒ Error al ejecutar selector de wallpaper"
    notify "âŒ Error al cambiar wallpaper"
    exit 1
fi
