#!/bin/bash

# Script interactivo para ajustar la intensidad de los colores pywal
# Permite elegir diferentes niveles de suavidad

HYPRLAND_COLORS="$HOME/.cache/wal/colors-hyprland.conf"
ENHANCED_COLORS="$HOME/.cache/wal/colors-hyprland-enhanced.conf"

# Obtener colores originales de pywal
if [ -f "$HOME/.cache/wal/colors.sh" ]; then
    source "$HOME/.cache/wal/colors.sh"
else
    echo "‚ùå Error: No se encontraron colores de pywal"
    echo "   Ejecuta 'wal -i <imagen>' primero"
    exit 1
fi

# Funci√≥n para reducir la intensidad de un color hexadecimal
reduce_intensity() {
    local color="$1"
    local factor="$2"
    
    # Remover el # si existe
    color="${color#\#}"
    
    # Extraer componentes RGB
    local r=$((16#${color:0:2}))
    local g=$((16#${color:2:2}))
    local b=$((16#${color:4:2}))
    
    # Reducir intensidad (mezclar con gris medio)
    local gray=80  # Valor base para mezclar
    r=$(( (r * (100 - factor) + gray * factor) / 100 ))
    g=$(( (g * (100 - factor) + gray * factor) / 100 ))
    b=$(( (b * (100 - factor) + gray * factor) / 100 ))
    
    # Asegurar que no exceda 255
    [ $r -gt 255 ] && r=255
    [ $g -gt 255 ] && g=255  
    [ $b -gt 255 ] && b=255
    
    # Convertir de vuelta a hex
    printf "%02x%02x%02x" $r $g $b
}

# Funci√≥n para aplicar configuraci√≥n con el factor dado
apply_colors() {
    local factor=$1
    local description="$2"
    
    echo "üé® Aplicando colores $description (${factor}% reducci√≥n)..."
    
    # Generar archivo principal para hyprland
    cat > "$HYPRLAND_COLORS" << EOF
# Hyprland colors generated by pywal - $description
# Colors are defined as variables for use in main config

# $description for gentle appearance
\$color0 = rgb($(reduce_intensity "$color0" $factor))
\$color1 = rgb($(reduce_intensity "$color1" $factor))  # Primary accent
\$color2 = rgb($(reduce_intensity "$color2" $factor))  # Secondary accent
\$color3 = rgb($(reduce_intensity "$color3" $factor))  # Tertiary accent
\$color4 = rgb($(reduce_intensity "$color4" $factor))  # Quaternary accent
\$color5 = rgb($(reduce_intensity "$color5" $factor))  # Quinary accent
\$color6 = rgb($(reduce_intensity "$color6" $factor))  # Senary accent
\$color7 = rgb($(reduce_intensity "$color7" $factor))  # Light foreground
\$color8 = rgb($(reduce_intensity "$color8" $factor))  # Dark accent
\$color9 = rgb($(reduce_intensity "$color9" $factor))
\$color10 = rgb($(reduce_intensity "$color10" $factor))
\$color11 = rgb($(reduce_intensity "$color11" $factor))
\$color12 = rgb($(reduce_intensity "$color12" $factor))
\$color13 = rgb($(reduce_intensity "$color13" $factor))
\$color14 = rgb($(reduce_intensity "$color14" $factor))
\$color15 = rgb($(reduce_intensity "$color15" $factor))
\$background = rgb($(reduce_intensity "$color0" $factor))
\$foreground = rgb($(reduce_intensity "$color7" $factor))  # Soft foreground
EOF

    # Generar archivo enhanced (id√©ntico) para hyprlock
    cat > "$ENHANCED_COLORS" << EOF
# Hyprland colors enhanced for hyprlock - $description
# Generated automatically by pywal with reduced saturation

\$color0 = rgb($(reduce_intensity "$color0" $factor))
\$color1 = rgb($(reduce_intensity "$color1" $factor))  # Primary accent
\$color2 = rgb($(reduce_intensity "$color2" $factor))  # Secondary accent  
\$color3 = rgb($(reduce_intensity "$color3" $factor))  # Tertiary accent
\$color4 = rgb($(reduce_intensity "$color4" $factor))  # Quaternary accent
\$color5 = rgb($(reduce_intensity "$color5" $factor))  # Quinary accent
\$color6 = rgb($(reduce_intensity "$color6" $factor))  # Senary accent
\$color7 = rgb($(reduce_intensity "$color7" $factor))  # Light foreground
\$color8 = rgb($(reduce_intensity "$color8" $factor))  # Dark accent
\$color9 = rgb($(reduce_intensity "$color9" $factor))
\$color10 = rgb($(reduce_intensity "$color10" $factor))
\$color11 = rgb($(reduce_intensity "$color11" $factor))
\$color12 = rgb($(reduce_intensity "$color12" $factor))
\$color13 = rgb($(reduce_intensity "$color13" $factor))
\$color14 = rgb($(reduce_intensity "$color14" $factor))
\$color15 = rgb($(reduce_intensity "$color15" $factor))

# Special colors with soft appearance
\$background = rgb($(reduce_intensity "$color0" $factor))
\$foreground = rgb($(reduce_intensity "$color7" $factor))  # Soft foreground

# Enhanced colors with gentle appearance  
\$accent_bright = rgb($(reduce_intensity "$color1" $factor))   # Soft primary
\$success = rgb($(reduce_intensity "$color2" $factor))         # Soft green
\$warning = rgb($(reduce_intensity "$color3" $factor))         # Soft yellow
\$error = rgb($(reduce_intensity "$color1" $factor))           # Soft red
\$text_bright = rgb($(reduce_intensity "$color7" $factor))     # Soft text
EOF

    # Recargar configuraci√≥n de Hyprland
    hyprctl reload > /dev/null 2>&1
    
    echo "‚úÖ $description aplicados correctamente!"
}

# Mostrar men√∫ interactivo
echo "üé® Ajustador de Intensidad de Colores Pywal"
echo "=========================================="
echo ""
echo "Elige el nivel de intensidad deseado:"
echo ""
echo "1) üî• Colores originales (0% reducci√≥n)"
echo "2) üåü Ligeramente suaves (20% reducci√≥n)"  
echo "3) üåô Moderadamente suaves (30% reducci√≥n)"
echo "4) üå∏ Muy suaves (45% reducci√≥n) [RECOMENDADO]"
echo "5) üïäÔ∏è  Ultra suaves (60% reducci√≥n)"
echo "6) üí´ Extremadamente suaves (75% reducci√≥n)"
echo "7) üé≠ Modo personalizado"
echo ""
read -p "Selecciona una opci√≥n (1-7): " choice

case $choice in
    1)
        # Restaurar colores originales
        echo "üî• Restaurando colores originales..."
        wal -R > /dev/null 2>&1
        echo "‚úÖ Colores originales restaurados!"
        ;;
    2)
        apply_colors 20 "Colores ligeramente suaves"
        ;;
    3)
        apply_colors 30 "Colores moderadamente suaves"
        ;;
    4)
        apply_colors 45 "Colores muy suaves"
        ;;
    5)
        apply_colors 60 "Colores ultra suaves"
        ;;
    6)
        apply_colors 75 "Colores extremadamente suaves"
        ;;
    7)
        echo ""
        read -p "Introduce el porcentaje de reducci√≥n (0-90): " custom_factor
        if [[ "$custom_factor" =~ ^[0-9]+$ ]] && [ "$custom_factor" -ge 0 ] && [ "$custom_factor" -le 90 ]; then
            apply_colors $custom_factor "Colores personalizados"
        else
            echo "‚ùå Error: Introduce un n√∫mero v√°lido entre 0 y 90"
            exit 1
        fi
        ;;
    *)
        echo "‚ùå Error: Opci√≥n no v√°lida"
        exit 1
        ;;
esac

echo ""
echo "üí° Tips:"
echo "   ‚Ä¢ Prueba el powermenu: Super + BackSpace"
echo "   ‚Ä¢ Prueba hyprlock: Super + L" 
echo "   ‚Ä¢ Aplica r√°pidamente ultra suaves: Super + Shift + C"
echo "   ‚Ä¢ Para cambiar de nuevo: $(basename "$0")"
