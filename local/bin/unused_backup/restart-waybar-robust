#!/bin/bash

# Script para reiniciar Waybar de forma robusta
# Ãštil cuando Waybar se queda colgado o no responde

LOG_FILE="$HOME/.cache/waybar-restart.log"

# FunciÃ³n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
    echo "$1"
}

log "=== Iniciando reinicio robusto de Waybar ==="

# Paso 1: Matar todos los procesos de waybar
log "Deteniendo todos los procesos de Waybar..."
pkill -TERM waybar

# Esperar 3 segundos
sleep 3

# Si siguen corriendo, forzar cierre
if pgrep -x waybar > /dev/null; then
    log "Forzando cierre de procesos persistentes..."
    pkill -KILL waybar
    sleep 2
fi

# Verificar que no hay procesos waybar corriendo
if pgrep -x waybar > /dev/null; then
    log "ERROR: Algunos procesos waybar siguen activos"
    notify-send "âŒ Error" "No se pudieron cerrar todos los procesos waybar"
    exit 1
fi

log "Todos los procesos waybar han sido cerrados"

# Paso 2: Verificar configuraciÃ³n
log "Verificando configuraciÃ³n de Waybar..."
if [[ ! -f ~/.config/waybar/config.json ]] && [[ ! -f ~/.config/waybar/config ]]; then
    log "ERROR: No se encontrÃ³ configuraciÃ³n de waybar"
    notify-send "âŒ Error" "ConfiguraciÃ³n de waybar no encontrada"
    exit 1
fi

# Paso 3: Iniciar waybar
log "Iniciando Waybar..."
notify-send "ğŸ”„ Waybar" "Reiniciando..." -t 2000

if nohup waybar > /dev/null 2>&1 & then
    local waybar_pid=$!
    sleep 3
    
    # Verificar que waybar estÃ¡ corriendo
    if kill -0 $waybar_pid 2>/dev/null && pgrep -x waybar > /dev/null; then
        log "âœ… Waybar reiniciado correctamente (PID: $waybar_pid)"
        notify-send "âœ… Waybar" "Reiniciado exitosamente" -t 3000
        exit 0
    else
        log "âŒ Waybar fallÃ³ al iniciar"
        notify-send "âŒ Error" "Waybar no pudo iniciarse"
        exit 1
    fi
else
    log "âŒ Error al ejecutar waybar"
    notify-send "âŒ Error" "No se pudo ejecutar waybar"
    exit 1
fi
