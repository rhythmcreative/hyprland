#!/bin/bash

# Script combinado para alternar Waybar Y cambiar wallpaper
# MÃ©todo mejorado que maneja ambas funciones sin conflictos

set -euo pipefail

LOG_FILE="$HOME/.cache/waybar-toggle-wallpaper.log"
LOCK_FILE="/tmp/waybar-toggle-wallpaper.lock"

# FunciÃ³n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Verificar si ya estÃ¡ ejecutÃ¡ndose
if [[ -f "$LOCK_FILE" ]]; then
    lock_pid=$(cat "$LOCK_FILE" 2>/dev/null || echo "")
    if [[ -n "$lock_pid" ]] && kill -0 "$lock_pid" 2>/dev/null; then
        log "â³ Script ya en ejecuciÃ³n (PID: $lock_pid)"
        exit 0
    fi
fi

# Crear lock
echo $$ > "$LOCK_FILE"

# FunciÃ³n de limpieza
cleanup() {
    rm -f "$LOCK_FILE"
}
trap cleanup EXIT INT TERM

log "ğŸš€ === INICIANDO TOGGLE WAYBAR + WALLPAPER ==="

# 1. PRIMERO: Alternar waybar (mostrar/ocultar)
waybar_was_running=false
if pgrep -x "waybar" > /dev/null; then
    waybar_was_running=true
    log "ğŸ“Š Waybar detectado - ocultando..."
    pkill waybar
    notify-send "ğŸ“Š Waybar" "Waybar oculto" --icon=window-close --timeout=2000 &
    # Esperar a que waybar se cierre completamente
    sleep 1
else
    log "ğŸ“Š Waybar no detectado - mostrando..."
    nohup waybar > /dev/null 2>&1 &
    notify-send "ğŸ“Š Waybar" "Waybar mostrado" --icon=window-new --timeout=2000 &
    sleep 1
fi

# 2. SEGUNDO: Ejecutar cambio de wallpaper
log "ğŸ–¼ï¸ Iniciando cambio de wallpaper..."

# Ejecutar el script de wallpaper en el background para no bloquear
"$HOME/.local/bin/wallpaper-change-fixed" &
wallpaper_pid=$!

log "ğŸ–¼ï¸ Script de wallpaper iniciado (PID: $wallpaper_pid)"

# Esperar un poco y verificar si el proceso sigue corriendo
sleep 2

if kill -0 "$wallpaper_pid" 2>/dev/null; then
    log "âœ… Script de wallpaper ejecutÃ¡ndose correctamente"
else
    log "âš ï¸ Script de wallpaper terminÃ³ rÃ¡pidamente"
fi

log "ğŸ‰ Toggle waybar + wallpaper completado"
exit 0
