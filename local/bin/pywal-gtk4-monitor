#!/bin/bash

# Monitor para ejecutar pywal-gtk4 generate cuando cambien los temas GTK
# Este script usa inotifywait para monitorear cambios en configuraciones GTK

SCRIPT_NAME="pywal-gtk4-monitor"
PID_FILE="$HOME/.cache/${SCRIPT_NAME}.pid"
LOG_FILE="$HOME/.cache/${SCRIPT_NAME}.log"

# FunciÃ³n de logging
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [${SCRIPT_NAME}] $1" | tee -a "$LOG_FILE"
}

# FunciÃ³n para mostrar ayuda
show_help() {
    echo "ğŸ” pywal-gtk4-monitor - Monitor automÃ¡tico para temas GTK"
    echo ""
    echo "COMANDOS:"
    echo "  start    - Iniciar el monitor en segundo plano"
    echo "  stop     - Detener el monitor"
    echo "  status   - Mostrar estado del monitor"
    echo "  logs     - Mostrar logs del monitor"
    echo "  run      - Ejecutar en primer plano (debug)"
    echo ""
    echo "Este monitor observa cambios en:"
    echo "  â€¢ ~/.config/gtk-3.0/settings.ini"
    echo "  â€¢ ~/.config/gtk-4.0/settings.ini"
    echo "  â€¢ ~/.gtkrc-2.0"
    echo ""
    echo "Y ejecuta automÃ¡ticamente 'pywal-gtk4 generate' cuando detecta cambios."
}

# FunciÃ³n para verificar dependencias
check_dependencies() {
    if ! command -v inotifywait >/dev/null 2>&1; then
        echo "âŒ Error: inotifywait no estÃ¡ instalado"
        echo "   Instalar con: sudo pacman -S inotify-tools"
        exit 1
    fi
    
    if [[ ! -x "$HOME/.local/bin/pywal-gtk4" ]]; then
        echo "âŒ Error: pywal-gtk4 no encontrado en ~/.local/bin/pywal-gtk4"
        exit 1
    fi
}

# FunciÃ³n principal de monitoreo
monitor_gtk_changes() {
    log "ğŸš€ Iniciando monitor de temas GTK"
    
    # Crear directorios si no existen
    mkdir -p ~/.config/gtk-3.0 ~/.config/gtk-4.0
    touch ~/.gtkrc-2.0 ~/.config/gtk-3.0/settings.ini ~/.config/gtk-4.0/settings.ini
    
    # Archivos a monitorear
    local files=(
        "$HOME/.config/gtk-3.0/settings.ini"
        "$HOME/.config/gtk-4.0/settings.ini"
        "$HOME/.gtkrc-2.0"
        "$HOME/.config/nwg-look/config"
    )
    
    log "ğŸ“ Monitoreando: ${files[*]}"
    
    # Monitorear cambios
    inotifywait -m -e modify,create,delete "${files[@]}" 2>/dev/null |
    while read -r directory events filename; do
        log "ğŸ”„ Cambio detectado: $directory$filename ($events)"
        
        # Esperar un poco para evitar mÃºltiples ejecuciones
        sleep 1
        
        # Ejecutar pywal-gtk4 generate
        log "ğŸ¨ Ejecutando pywal-gtk4 generate..."
        if ~/.local/bin/pywal-gtk4 generate >>"$LOG_FILE" 2>&1; then
            log "âœ… Tema GTK4 regenerado exitosamente"
        else
            log "âš ï¸  Error al regenerar tema GTK4"
        fi
    done
}

# FunciÃ³n para iniciar como daemon
start_monitor() {
    if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        echo "âš ï¸  Monitor ya estÃ¡ ejecutÃ¡ndose (PID: $(cat "$PID_FILE"))"
        exit 1
    fi
    
    check_dependencies
    
    echo "ğŸš€ Iniciando monitor en segundo plano..."
    monitor_gtk_changes &
    echo $! > "$PID_FILE"
    echo "âœ… Monitor iniciado (PID: $(cat "$PID_FILE"))"
    echo "ğŸ“ Logs en: $LOG_FILE"
}

# FunciÃ³n para detener el monitor
stop_monitor() {
    if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        local pid=$(cat "$PID_FILE")
        kill "$pid"
        rm -f "$PID_FILE"
        echo "ğŸ›‘ Monitor detenido (PID: $pid)"
    else
        echo "â„¹ï¸  Monitor no estÃ¡ ejecutÃ¡ndose"
    fi
}

# FunciÃ³n para mostrar estado
show_status() {
    if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        echo "âœ… Monitor ejecutÃ¡ndose (PID: $(cat "$PID_FILE"))"
        echo "ğŸ“ Log: $LOG_FILE"
        echo "ğŸ•’ Ãšltimo log:"
        tail -n 3 "$LOG_FILE" 2>/dev/null || echo "   (sin logs recientes)"
    else
        echo "âŒ Monitor no estÃ¡ ejecutÃ¡ndose"
        rm -f "$PID_FILE" 2>/dev/null
    fi
}

# FunciÃ³n para mostrar logs
show_logs() {
    if [[ -f "$LOG_FILE" ]]; then
        echo "ğŸ“ Logs del monitor (Ãºltimas 20 lÃ­neas):"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        tail -n 20 "$LOG_FILE"
    else
        echo "ğŸ“ No hay logs disponibles"
    fi
}

# Procesar argumentos
case "${1:-}" in
    "start")
        start_monitor
        ;;
    "stop")
        stop_monitor
        ;;
    "status")
        show_status
        ;;
    "logs")
        show_logs
        ;;
    "run")
        check_dependencies
        echo "ğŸ” Ejecutando monitor en primer plano (Ctrl+C para detener)"
        monitor_gtk_changes
        ;;
    "--help"|"help"|"")
        show_help
        ;;
    *)
        echo "âŒ Comando desconocido: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
