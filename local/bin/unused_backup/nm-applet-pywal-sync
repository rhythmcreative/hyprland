#!/bin/bash

# nm-applet pywal synchronizer - Enhanced version
# Sincroniza automÃ¡ticamente nm-applet con los colores de pywal
# Compatible con Hyprland y Waybar

set -euo pipefail

SCRIPT_NAME="nm-applet-pywal-sync"
LOG_FILE="$HOME/.cache/${SCRIPT_NAME}.log"
LOCK_FILE="/tmp/${SCRIPT_NAME}.lock"

# FunciÃ³n de logging con timestamp
log() {
    local message="[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    echo "$message" | tee -a "$LOG_FILE"
}

# FunciÃ³n de notificaciÃ³n silenciosa
notify() {
    notify-send "ðŸ“¶ nm-applet" "$1" -t 2000 -i network-wireless 2>/dev/null || true
}

# Verificar si ya estÃ¡ ejecutÃ¡ndose
if [[ -f "$LOCK_FILE" ]]; then
    lock_pid=$(cat "$LOCK_FILE" 2>/dev/null || echo "")
    if [[ -n "$lock_pid" ]] && kill -0 "$lock_pid" 2>/dev/null; then
        log "â³ SincronizaciÃ³n ya en progreso (PID: $lock_pid), saliendo..."
        exit 0
    fi
fi

# Crear lock
echo $$ > "$LOCK_FILE"

# Cleanup function
cleanup() {
    rm -f "$LOCK_FILE"
}
trap cleanup EXIT

log "ðŸš€ Iniciando sincronizaciÃ³n nm-applet con pywal..."

# Verificar que pywal estÃ© instalado y configurado
if ! command -v wal >/dev/null 2>&1; then
    log "âŒ pywal no estÃ¡ instalado"
    exit 1
fi

if [[ ! -f "$HOME/.cache/wal/colors.sh" ]]; then
    log "âŒ No se encontraron colores de pywal generados"
    exit 1
fi

# Cargar colores de pywal
log "ðŸŽ¨ Cargando colores de pywal..."
source "$HOME/.cache/wal/colors.sh"

# Validar que los colores sean vÃ¡lidos
if [[ ! "$background" =~ ^#[0-9A-Fa-f]{6}$ ]] || [[ ! "$foreground" =~ ^#[0-9A-Fa-f]{6}$ ]]; then
    log "âŒ Colores de pywal no vÃ¡lidos: bg=$background, fg=$foreground"
    exit 1
fi

log "âœ… Colores pywal cargados: bg=$background, fg=$foreground"

# FunciÃ³n para crear tema GTK personalizado para nm-applet
create_nm_applet_gtk_theme() {
    local gtk3_dir="$HOME/.config/gtk-3.0"
    local gtk4_dir="$HOME/.config/gtk-4.0" 
    
    mkdir -p "$gtk3_dir" "$gtk4_dir"
    
    log "ðŸŽ¨ Creando tema GTK personalizado para nm-applet..."
    
    # Crear CSS para GTK3
    cat > "$gtk3_dir/nm-applet-pywal.css" << EOF
/* nm-applet pywal theme - Generated $(date) */
/* Colors: bg=$background, fg=$foreground, accent=$color4 */

/* NetworkManager applet styling */
.nm-applet,
.nm-applet-window,
#nm-applet {
    background-color: $background;
    color: $foreground;
    border-radius: 8px;
    border: 1px solid $color4;
}

/* Menu items */
.nm-applet menuitem,
.nm-applet-window menuitem {
    background-color: $background;
    color: $foreground;
    padding: 8px 12px;
    border-radius: 4px;
}

.nm-applet menuitem:hover,
.nm-applet-window menuitem:hover {
    background-color: $color4;
    color: $background;
}

/* Active connections */
.nm-applet .connection-active {
    color: $color2;
    font-weight: bold;
}

/* Entry fields */
.nm-applet entry {
    background-color: $background;
    color: $foreground;
    border: 1px solid $color4;
    border-radius: 4px;
    padding: 6px;
}

/* Buttons */
.nm-applet button {
    background-color: $color4;
    color: $background;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
}

.nm-applet button:hover {
    background-color: $color6;
    opacity: 0.9;
}

/* Separators */
.nm-applet separator {
    background-color: $color8;
    opacity: 0.5;
}

/* Popover/Dialog styling */
popover,
dialog {
    background-color: $background;
    color: $foreground;
    border: 1px solid $color4;
    border-radius: 8px;
}

/* List styling */
list,
listbox {
    background-color: $background;
    color: $foreground;
}

list row,
listbox row {
    padding: 4px 8px;
    border-radius: 4px;
}

list row:hover,
listbox row:hover {
    background-color: $color4;
    color: $background;
}

/* Scrollbars */
scrollbar {
    background-color: $background;
    border-radius: 10px;
}

scrollbar slider {
    background-color: $color4;
    border-radius: 10px;
    min-width: 10px;
    min-height: 10px;
}

/* System tray specific */
.system-tray .nm-applet {
    color: $foreground;
    padding: 4px;
}
EOF

    # Copiar para GTK4
    cp "$gtk3_dir/nm-applet-pywal.css" "$gtk4_dir/nm-applet-pywal.css"
    
    # Actualizar/crear archivo gtk.css principal para importar el tema
    local gtk3_main="$gtk3_dir/gtk.css"
    local gtk4_main="$gtk4_dir/gtk.css"
    
    for gtk_main in "$gtk3_main" "$gtk4_main"; do
        if [[ -f "$gtk_main" ]]; then
            if ! grep -q "nm-applet-pywal.css" "$gtk_main"; then
                echo '@import "nm-applet-pywal.css";' | cat - "$gtk_main" > temp && mv temp "$gtk_main"
            fi
        else
            echo '@import "nm-applet-pywal.css";' > "$gtk_main"
        fi
    done
    
    log "âœ… Tema GTK personalizado creado y configurado"
}

# FunciÃ³n para configurar variables de entorno
setup_environment() {
    log "ðŸ”§ Configurando variables de entorno..."
    
    # Crear script de entorno para nm-applet
    cat > "/tmp/nm-applet-env.sh" << EOF
#!/bin/bash
# nm-applet environment setup with pywal colors

# Basic environment
export HOME="$HOME"
export USER="$USER"
export XDG_SESSION_TYPE="${XDG_SESSION_TYPE:-wayland}"
export WAYLAND_DISPLAY="${WAYLAND_DISPLAY:-wayland-0}"
export DISPLAY="${DISPLAY:-}"

# GTK theming
export GTK_THEME="Adwaita:dark"
export GDK_BACKEND="wayland,x11"
export GTK_CSD=0
export GTK_OVERLAY_SCROLLING=0

# Apply pywal colors to environment
export PYWAL_BACKGROUND="$background"
export PYWAL_FOREGROUND="$foreground"
export PYWAL_ACCENT="$color4"

# Start nm-applet
exec nm-applet "\$@"
EOF
    
    chmod +x "/tmp/nm-applet-env.sh"
    log "âœ… Variables de entorno configuradas"
}

# FunciÃ³n para reiniciar nm-applet
restart_nm_applet() {
    log "ðŸ”„ Reiniciando nm-applet con tema pywal..."
    
    # Matar procesos existentes
    pkill -f nm-applet 2>/dev/null || true
    sleep 2
    
    # Forzar cierre si sigue corriendo
    if pgrep -x nm-applet >/dev/null; then
        pkill -9 nm-applet 2>/dev/null || true
        sleep 1
    fi
    
    # Iniciar nm-applet con el nuevo entorno
    nohup /tmp/nm-applet-env.sh >/dev/null 2>&1 &
    
    # Verificar que iniciÃ³ correctamente
    local attempts=0
    while [[ $attempts -lt 8 ]]; do
        if pgrep -x nm-applet >/dev/null; then
            log "âœ… nm-applet reiniciado exitosamente"
            notify "Sincronizado con pywal"
            rm -f "/tmp/nm-applet-env.sh"
            return 0
        fi
        sleep 1
        ((attempts++))
    done
    
    log "âš ï¸ nm-applet tardÃ³ en iniciar, pero puede estar funcionando"
    rm -f "/tmp/nm-applet-env.sh"
    return 0
}

# FunciÃ³n para aplicar cambios de tema a nivel sistema
apply_system_theme() {
    log "ðŸ–¥ï¸ Aplicando cambios de tema a nivel sistema..."
    
    # Actualizar gsettings si estÃ¡ disponible
    if command -v gsettings >/dev/null 2>&1; then
        gsettings set org.gnome.desktop.interface gtk-theme "Adwaita:dark" 2>/dev/null || true
        gsettings set org.gnome.desktop.interface color-scheme "prefer-dark" 2>/dev/null || true
    fi
    
    # Enviar seÃ±ales D-Bus para actualizar temas
    if command -v dbus-send >/dev/null 2>&1; then
        dbus-send --type=signal /org/gtk/Settings org.gtk.Settings.SettingChanged \
            string:"gtk-theme-name" 2>/dev/null || true
        dbus-send --type=signal /org/gtk/Settings org.gtk.Settings.StyleUpdated \
            2>/dev/null || true
    fi
    
    log "âœ… Cambios de tema aplicados"
}

# FunciÃ³n principal
main() {
    log "=== Iniciando sincronizaciÃ³n nm-applet â†” pywal ==="
    
    # Crear tema personalizado
    create_nm_applet_gtk_theme
    
    # Configurar entorno
    setup_environment
    
    # Aplicar cambios de tema
    apply_system_theme
    
    # Reiniciar nm-applet
    restart_nm_applet
    
    log "ðŸŽ‰ SincronizaciÃ³n completada exitosamente!"
    log "ðŸ“‹ Log disponible en: $LOG_FILE"
}

# Verificar argumentos
if [[ "${1:-}" == "--force" ]]; then
    log "ðŸ”¥ Modo forzado activado"
fi

# Ejecutar funciÃ³n principal
main

exit 0
