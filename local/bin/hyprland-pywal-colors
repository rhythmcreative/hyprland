#!/bin/bash

# Script para aplicar colores de pywal a Hyprland
# √ötil cuando cambias configuraciones de pywal sin cambiar wallpaper

LOG_FILE="$HOME/.cache/hyprland-pywal.log"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

log "Iniciando aplicaci√≥n de colores pywal a Hyprland"

# Verificar si pywal est√° instalado y ha generado colores
if ! command -v wal > /dev/null 2>&1; then
    echo "ERROR: pywal no est√° instalado"
    log "ERROR: pywal no est√° instalado"
    exit 1
fi

if [[ ! -f ~/.cache/wal/colors ]]; then
    echo "ERROR: No se encontraron colores de pywal. Ejecuta 'wal -i [imagen]' primero"
    log "ERROR: No se encontraron colores de pywal"
    exit 1
fi

# Verificar si Hyprland est√° corriendo
if ! pgrep -x "Hyprland" > /dev/null; then
    echo "WARNING: Hyprland no est√° corriendo"
    log "WARNING: Hyprland no est√° corriendo"
fi

# Obtener colores de pywal
ACTIVE_COLOR=$(cat ~/.cache/wal/colors | sed -n '2p' | sed 's/#//')    # color1 para borde activo
INACTIVE_COLOR=$(cat ~/.cache/wal/colors | sed -n '9p' | sed 's/#//')  # color8 para borde inactivo
SHADOW_COLOR=$(cat ~/.cache/wal/colors | sed -n '1p' | sed 's/#//')    # background para sombra

log "Colores detectados - Active: #$ACTIVE_COLOR, Inactive: #$INACTIVE_COLOR, Shadow: #$SHADOW_COLOR"

echo "üé® Aplicando colores a Hyprland:"
echo "   Borde activo: #$ACTIVE_COLOR"
echo "   Borde inactivo: #$INACTIVE_COLOR"
echo "   Sombra: #$SHADOW_COLOR"

# Verificar si el archivo de configuraci√≥n de Hyprland existe
if [[ ! -f ~/.config/hypr/hyprland.conf ]]; then
    echo "ERROR: No se encontr√≥ el archivo de configuraci√≥n de Hyprland"
    log "ERROR: No se encontr√≥ ~/.config/hypr/hyprland.conf"
    exit 1
fi

# Verificar si el template de colores enhanced existe
if [[ ! -f ~/.config/wal/templates/colors-hyprland-enhanced.conf ]]; then
    echo "‚úÖ Template colors-hyprland-enhanced.conf ya existe"
    log "Template colors-hyprland-enhanced.conf encontrado"
else
    echo "‚úÖ Template colors-hyprland-enhanced.conf est√° disponible"
    log "Template colors-hyprland-enhanced.conf disponible"
fi

# Regenerar colores con el template
echo "üîÑ Regenerando colores de Hyprland..."
log "Regenerando template de colores"

# Obtener la imagen actual de pywal
CURRENT_WALLPAPER=$(cat ~/.cache/wal/wal 2>/dev/null || echo "")

if [[ -n "$CURRENT_WALLPAPER" && -f "$CURRENT_WALLPAPER" ]]; then
    # Regenerar colores usando la imagen actual
    wal -i "$CURRENT_WALLPAPER" > /dev/null 2>&1
    log "Colores regenerados usando wallpaper: $CURRENT_WALLPAPER"
else
    echo "WARNING: No se pudo obtener el wallpaper atual, usando colores existentes"
    log "WARNING: Wallpaper actual no encontrado"
fi

# Verificar y generar archivos de colores
echo "üé® Generando archivos de colores mejorados..."

# Verificar si se gener√≥ colors-hyprland-enhanced.conf (para hyprlock)
if [[ -f ~/.cache/wal/colors-hyprland-enhanced.conf ]]; then
    echo "‚úÖ Archivo colors-hyprland-enhanced.conf generado exitosamente"
    log "Archivo colors-hyprland-enhanced.conf generado exitosamente"
    
    # Mostrar contenido para verificaci√≥n
    echo "üìÑ Contenido del archivo enhanced (para hyprlock):"
    head -n 15 ~/.cache/wal/colors-hyprland-enhanced.conf
    echo "..."
else
    echo "‚ùå ERROR: No se pudo generar el archivo colors-hyprland-enhanced.conf"
    log "ERROR: No se pudo generar colors-hyprland-enhanced.conf"
    exit 1
fi

# Verificar archivo regular (para compatibilidad)
if [[ -f ~/.cache/wal/colors-hyprland.conf ]]; then
    echo "‚úÖ Archivo colors-hyprland.conf tambi√©n disponible (compatibilidad)"
    log "Archivo colors-hyprland.conf generado exitosamente"
else
    echo "‚ö†Ô∏è Archivo colors-hyprland.conf no encontrado (no es cr√≠tico)"
    log "WARNING: colors-hyprland.conf no encontrado"
fi

# Recargar Hyprland si est√° corriendo
if pgrep -x "Hyprland" > /dev/null; then
    echo "üîÑ Recargando configuraci√≥n de Hyprland..."
    log "Recargando Hyprland"
    
    if hyprctl reload > /dev/null 2>&1; then
        echo "‚úÖ Hyprland recargado exitosamente"
        log "Hyprland recargado exitosamente"
    else
        echo "‚ùå ERROR: Fallo al recargar Hyprland"
        log "ERROR: Fallo al recargar Hyprland"
        
        # Intentar comando alternativo
        echo "üîÑ Intentando comando alternativo..."
        if hyprctl dispatch exec "hyprctl reload" > /dev/null 2>&1; then
            echo "‚úÖ Hyprland recargado con comando alternativo"
            log "Hyprland recargado con comando alternativo"
        else
            echo "‚ùå No se pudo recargar Hyprland autom√°ticamente"
            echo "   Puedes intentar manualmente: hyprctl reload"
            log "ERROR: No se pudo recargar Hyprland"
        fi
    fi
else
    echo "‚ÑπÔ∏è  Hyprland no est√° corriendo, configuraci√≥n aplicada para el pr√≥ximo inicio"
    log "Hyprland no est√° corriendo"
fi

echo "üéâ Proceso completado. Los bordes de las ventanas deber√≠an usar los nuevos colores."
log "Aplicaci√≥n de colores completada exitosamente"
