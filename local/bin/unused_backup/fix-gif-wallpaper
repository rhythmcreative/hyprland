#!/bin/bash

LOG_FILE="$HOME/.cache/wallpaper-theme.log"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

log "Iniciando script de reparaci√≥n de GIF wallpaper"

# Limpiar archivos temporales que puedan estar interfiriendo
log "Limpiando archivos temporales de GIFs"
rm -f /tmp/gif_frame_for_wal*.png 2>/dev/null || true
rm -f "$HOME/.cache/gif_frame_for_wal"*.png 2>/dev/null || true

# Verificar si hay un GIF configurado como wallpaper actual
if [[ -f "$HOME/.cache/current-wallpaper" ]]; then
    CURRENT_WALLPAPER=$(cat "$HOME/.cache/current-wallpaper")
    
    if [[ -f "$CURRENT_WALLPAPER" && "${CURRENT_WALLPAPER,,}" == *.gif ]]; then
        log "Detectado GIF como wallpaper actual: $CURRENT_WALLPAPER"
        
        # Verificar que swww-daemon est√° corriendo
        if ! pgrep -x "swww-daemon" > /dev/null; then
            log "Iniciando swww-daemon"
            swww-daemon --format xrgb &
            sleep 2
        fi
        
        # Reaplicar el GIF con configuraciones optimizadas
        log "Reaplicando GIF wallpaper con configuraciones optimizadas"
        swww img "$CURRENT_WALLPAPER" --transition-type none --transition-duration 0.1 2>/dev/null
        
        if [ $? -eq 0 ]; then
            log "GIF wallpaper reaplicado exitosamente"
            
            # Tambi√©n resincronizar pywal si est√° disponible
            if command -v wal > /dev/null 2>&1; then
                log "Resincronizando pywal con GIF"
                # Extraer primer frame para pywal
                gif_frame_temp="/tmp/gif_frame_for_wal_fix_$$.png"
                
                convert_cmd="magick"
                if ! command -v magick &> /dev/null; then
                    convert_cmd="convert"
                fi

                if $convert_cmd "$CURRENT_WALLPAPER[0]" "$gif_frame_temp" 2>/dev/null; then
                    wal -i "$gif_frame_temp" -n
                    rm -f "$gif_frame_temp" 2>/dev/null || true
                    
                    # Recargar hyprland para aplicar colores
                    hyprctl reload > /dev/null 2>&1 || true
                    sleep 0.5
                    
                    # Reconfirmar el GIF despu√©s de recargar
                    swww img "$CURRENT_WALLPAPER" --transition-type none --transition-duration 0.1 > /dev/null 2>&1 || true
                    
                    log "Pywal resincronizado con √©xito"
                fi
            fi
            
            notify-send "üé¨ GIF + Pywal Reparado" "$(basename "$CURRENT_WALLPAPER") animado y sincronizado correctamente"
        else
            log "ERROR: Fallo al reaplicar GIF wallpaper"
            notify-send "‚ùå Error" "No se pudo reaplicar el GIF wallpaper"
        fi
        
        # Verificar el estado actual
        swww query
    else
        log "El wallpaper actual no es un GIF o no existe"
        notify-send "‚ÑπÔ∏è Info" "No se detect√≥ un GIF como wallpaper actual"
    fi
else
    log "No se encontr√≥ archivo de wallpaper actual"
    notify-send "‚ö†Ô∏è Advertencia" "No se encontr√≥ informaci√≥n del wallpaper actual"
fi

log "Script de reparaci√≥n de GIF wallpaper completado"
