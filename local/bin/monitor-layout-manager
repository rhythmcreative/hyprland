#!/bin/bash

# Monitor Layout Manager para Hyprland con Rofi
# Detecta configuraciones disponibles y permite cambiar entre ellas

MONITORS_CONF="$HOME/.config/hypr/monitors.conf"
TEMP_CONFIG="/tmp/monitor_layouts.tmp"

# Colores para la salida
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Funci√≥n para detectar monitores conectados
detect_monitors() {
    hyprctl monitors -j | jq -r '.[] | "\(.name):\(.width)x\(.height)@\(.refreshRate):\(.x),\(.y)"'
}

# Funci√≥n para obtener el layout actual
get_current_layout() {
    local current=$(hyprctl monitors -j | jq -r '.[] | "\(.name):\(.width)x\(.height)@\(.refreshRate):\(.x),\(.y)"' | sort)
    echo "$current"
}

# Funci√≥n para generar layouts predefinidos basados en los monitores disponibles
generate_layouts() {
    local monitors=($(hyprctl monitors -j | jq -r '.[].name'))
    local primary_monitor="${monitors[0]}"
    local secondary_monitor="${monitors[1]:-}"
    
    cat > "$TEMP_CONFIG" << EOF
# Layout 1: Solo Monitor Principal
üñ•Ô∏è  Solo $primary_monitor
monitor=$primary_monitor,preferred,auto,1.0
$([ -n "$secondary_monitor" ] && echo "monitor=$secondary_monitor,disable")

# Layout 2: Solo Monitor Secundario
$([ -n "$secondary_monitor" ] && cat << INNER
üñ•Ô∏è  Solo $secondary_monitor  
monitor=$secondary_monitor,preferred,auto,1.0
monitor=$primary_monitor,disable

# Layout 3: Dual Monitor - Extendido (Izquierda-Derecha)
üñ•Ô∏èüñ•Ô∏è Dual Extendido (L-R)
monitor=$primary_monitor,preferred,0x0,1.0
monitor=$secondary_monitor,preferred,2560x0,1.0

# Layout 4: Dual Monitor - Extendido (Derecha-Izquierda) 
üñ•Ô∏èüñ•Ô∏è Dual Extendido (R-L)
monitor=$secondary_monitor,preferred,0x0,1.0
monitor=$primary_monitor,preferred,2560x0,1.0

# Layout 5: Dual Monitor - Espejo
üñ•Ô∏è=üñ•Ô∏è Dual Espejo
monitor=$primary_monitor,preferred,auto,1.0
monitor=$secondary_monitor,preferred,auto,1.0,mirror,$primary_monitor

# Layout 6: Configuraci√≥n Actual
‚úÖ Configuraci√≥n Actual
$(get_current_monitors_config)
INNER
)
EOF
}

# Funci√≥n para obtener configuraci√≥n actual de monitores
get_current_monitors_config() {
    hyprctl monitors -j | jq -r '.[] | "monitor=\(.name),\(.width)x\(.height)@\(.refreshRate),\(.x)x\(.y),\(.scale)"'
}

# Funci√≥n para aplicar un layout
apply_layout() {
    local layout_name="$1"
    local config=""
    
    case "$layout_name" in
        *"Solo eDP-1"*)
            config="monitor=eDP-1,preferred,auto,1.0\nmonitor=DP-6,disable"
            ;;
        *"Solo DP-6"*)
            config="monitor=DP-6,preferred,auto,1.0\nmonitor=eDP-1,disable"
            ;;
        *"Dual Extendido (L-R)"*)
            config="monitor=eDP-1,1920x1080@144.0,2560x0,1.0\nmonitor=DP-6,2560x1440@239.97,0x0,1.0"
            ;;
        *"Dual Extendido (R-L)"*)
            config="monitor=DP-6,2560x1440@239.97,2560x0,1.0\nmonitor=eDP-1,1920x1080@144.0,0x0,1.0"
            ;;
        *"Dual Espejo"*)
            config="monitor=eDP-1,1920x1080@144.0,auto,1.0\nmonitor=DP-6,1920x1080@144.0,auto,1.0,mirror,eDP-1"
            ;;
        *"Configuraci√≥n Actual"*)
            echo "Ya est√° usando la configuraci√≥n actual"
            return 0
            ;;
    esac
    
    # Aplicar configuraci√≥n
    if [ -n "$config" ]; then
        echo -e "$config" > "$HOME/.config/hypr/monitors.conf"
        echo "# Generated by monitor-layout-manager on $(date). Do not edit manually." >> "$HOME/.config/hypr/monitors.conf"
        
        # Recargar Hyprland
        hyprctl reload
        
        # Notificaci√≥n
        notify-send "Monitor Layout" "Aplicado: $layout_name" -i display
    fi
}

# Funci√≥n principal para mostrar el men√∫ Rofi
show_layout_menu() {
    local monitors=($(hyprctl monitors -j | jq -r '.[].name'))
    local current_layout=$(get_current_layout)
    
    # Generar opciones del men√∫
    local options=""
    
    # Solo si hay m√°s de un monitor
    if [ ${#monitors[@]} -gt 1 ]; then
        options+="üñ•Ô∏è  Solo ${monitors[0]}\n"
        options+="üñ•Ô∏è  Solo ${monitors[1]}\n"
        options+="üñ•Ô∏èüñ•Ô∏è Dual Extendido (L-R)\n"
        options+="üñ•Ô∏èüñ•Ô∏è Dual Extendido (R-L)\n" 
        options+="üñ•Ô∏è=üñ•Ô∏è Dual Espejo\n"
    else
        options+="üñ•Ô∏è  Solo ${monitors[0]}\n"
    fi
    
    options+="‚úÖ Configuraci√≥n Actual\n"
    options+="‚ÑπÔ∏è  Info de Monitores\n"
    options+="üîÑ Recargar Hyprland"
    
    # Mostrar men√∫ con Rofi
    local selection=$(echo -e "$options" | rofi -dmenu -i -p "Monitor Layout" \
        -theme ~/.config/rofi/style-3.rasi \
        -mesg "Monitor actual: $(hyprctl monitors -j | jq -r '.[] | select(.focused) | .name')")
    
    case "$selection" in
        *"Info de Monitores"*)
            show_monitor_info
            ;;
        *"Recargar Hyprland"*)
            hyprctl reload
            notify-send "Hyprland" "Configuraci√≥n recargada" -i display
            ;;
        "")
            exit 0
            ;;
        *)
            apply_layout "$selection"
            ;;
    esac
}

# Funci√≥n para mostrar informaci√≥n de monitores
show_monitor_info() {
    local info=$(hyprctl monitors -j | jq -r '.[] | "üñ•Ô∏è \(.name): \(.width)x\(.height)@\(.refreshRate)Hz - Pos: \(.x),\(.y) - Escala: \(.scale)x\(if .focused then " [ACTIVO]" else "" end)"')
    
    echo "$info" | rofi -dmenu -i -p "Informaci√≥n de Monitores" \
        -theme ~/.config/rofi/style-3.rasi \
        -mesg "Presiona Esc para volver"
}

# Funci√≥n de ayuda
show_help() {
    echo "Monitor Layout Manager para Hyprland"
    echo ""
    echo "Uso: $0 [opci√≥n]"
    echo ""
    echo "Opciones:"
    echo "  menu    - Mostrar men√∫ de layouts (por defecto)"
    echo "  info    - Mostrar informaci√≥n de monitores"
    echo "  reload  - Recargar configuraci√≥n de Hyprland"
    echo "  help    - Mostrar esta ayuda"
}

# Funci√≥n principal
main() {
    case "${1:-menu}" in
        "menu"|"")
            show_layout_menu
            ;;
        "info")
            show_monitor_info
            ;;
        "reload")
            hyprctl reload
            notify-send "Hyprland" "Configuraci√≥n recargada" -i display
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        *)
            echo "Opci√≥n no v√°lida. Use '$0 help' para ver las opciones disponibles."
            exit 1
            ;;
    esac
}

# Verificar dependencias
if ! command -v rofi &> /dev/null; then
    echo "Error: Rofi no est√° instalado"
    exit 1
fi

if ! command -v hyprctl &> /dev/null; then
    echo "Error: hyprctl no est√° disponible (¬øHyprland ejecut√°ndose?)"
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "Error: jq no est√° instalado"
    exit 1
fi

# Ejecutar funci√≥n principal
main "$@"
