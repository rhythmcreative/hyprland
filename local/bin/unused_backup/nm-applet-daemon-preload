#!/bin/bash

# Daemon que mantiene nm-applet pre-cargado para inicio INSTANTÃNEO
# Se ejecuta en background y mantiene nm-applet siempre listo

set -euo pipefail

LOG_FILE="$HOME/.cache/nm-applet-daemon.log"
PID_FILE="/tmp/nm-applet-daemon.pid"

log() {
    echo "[$(date '+%H:%M:%S')] DAEMON: $1" | tee -a "$LOG_FILE"
}

# Verificar si el daemon ya estÃ¡ ejecutÃ¡ndose
if [[ -f "$PID_FILE" ]]; then
    daemon_pid=$(cat "$PID_FILE" 2>/dev/null || echo "")
    if [[ -n "$daemon_pid" ]] && kill -0 "$daemon_pid" 2>/dev/null; then
        log "âš ï¸ Daemon ya ejecutÃ¡ndose (PID: $daemon_pid)"
        exit 0
    fi
fi

# Crear PID file
echo $$ > "$PID_FILE"

# FunciÃ³n de limpieza
cleanup() {
    rm -f "$PID_FILE"
    log "ğŸ›‘ Daemon terminado"
    exit 0
}
trap cleanup EXIT INT TERM

log "ğŸš€ === INICIANDO DAEMON NM-APPLET PRELOAD ==="

# FunciÃ³n para mantener nm-applet activo y optimizado
maintain_nm_applet() {
    while true; do
        # Verificar si nm-applet estÃ¡ ejecutÃ¡ndose
        if ! pgrep -x nm-applet > /dev/null; then
            log "ğŸ”„ nm-applet no detectado, iniciando..."
            
            # Pre-configurar entorno para mÃ¡xima velocidad
            export GDK_BACKEND=x11
            export QT_QPA_PLATFORM=xcb
            export NO_AT_BRIDGE=1
            
            # Iniciar con mÃ¡xima prioridad
            nice -n -15 nm-applet --indicator > /dev/null 2>&1 &
            local nm_pid=$!
            
            # VerificaciÃ³n rÃ¡pida
            sleep 0.1
            if pgrep -x nm-applet > /dev/null; then
                log "âœ… nm-applet iniciado (PID: $nm_pid)"
            else
                log "âš ï¸ Reintentar nm-applet..."
                nm-applet --indicator & disown
            fi
        fi
        
        # Verificar cada 5 segundos
        sleep 5
    done
}

log "ğŸ’« Iniciando monitoreo continuo de nm-applet..."

# Ejecutar funciÃ³n de mantenimiento
maintain_nm_applet
