#!/bin/bash

# Script para configurar VSCode con la extensi√≥n wal-theme de pywal
# Este script asegura que VSCode est√© configurado correctamente para usar el tema pywal

LOG_FILE="$HOME/.cache/wallpaper-theme.log"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [VSCode-Wal] $1" >> "$LOG_FILE"
}

log "Iniciando configuraci√≥n de VSCode con wal-theme"

# Verificar si VSCode est√° instalado
if ! command -v code > /dev/null 2>&1; then
    log "ERROR: VSCode no est√° instalado"
    notify-send "Error" "VSCode no est√° instalado"
    exit 1
fi

# Verificar si la extensi√≥n wal-theme est√° instalada
if ! code --list-extensions | grep -q "dlasagno.wal-theme"; then
    log "Instalando extensi√≥n wal-theme"
    notify-send "VSCode Wal" "Instalando extensi√≥n wal-theme..."
    code --install-extension dlasagno.wal-theme
    if [ $? -eq 0 ]; then
        log "Extensi√≥n wal-theme instalada exitosamente"
        notify-send "VSCode Wal" "‚úÖ Extensi√≥n wal-theme instalada"
    else
        log "ERROR: Fallo al instalar extensi√≥n wal-theme"
        notify-send "Error" "No se pudo instalar la extensi√≥n wal-theme"
        exit 1
    fi
fi

# Configurar VSCode para usar el tema wal autom√°ticamente
VSCODE_SETTINGS_DIR="$HOME/.config/Code/User"
SETTINGS_FILE="$VSCODE_SETTINGS_DIR/settings.json"

# Crear directorio de configuraci√≥n si no existe
mkdir -p "$VSCODE_SETTINGS_DIR"

log "Configurando settings.json de VSCode"

# Crear o modificar settings.json
if [ -f "$SETTINGS_FILE" ]; then
    # Hacer backup del archivo original
    cp "$SETTINGS_FILE" "$SETTINGS_FILE.backup.$(date +%Y%m%d_%H%M%S)"
    log "Backup de settings.json creado"
fi

# Funci√≥n para actualizar configuraci√≥n JSON
update_vscode_settings() {
    local temp_file=$(mktemp)
    
    # Si el archivo existe y no est√° vac√≠o
    if [ -s "$SETTINGS_FILE" ]; then
        # Usar jq para actualizar la configuraci√≥n si est√° disponible
        if command -v jq > /dev/null 2>&1; then
            jq '. += {
                "workbench.colorTheme": "Wal",
                "walTheme.autoUpdate": true
            }' "$SETTINGS_FILE" > "$temp_file"
            
            if [ $? -eq 0 ]; then
                mv "$temp_file" "$SETTINGS_FILE"
                log "Configuraci√≥n actualizada usando jq"
                return 0
            else
                log "WARNING: Error usando jq, aplicando m√©todo alternativo"
                rm -f "$temp_file"
            fi
        fi
        
        # M√©todo alternativo sin jq
        log "Actualizando configuraci√≥n manualmente"
        
        # Remover la √∫ltima llave de cierre y a√±adir nuevas configuraciones
        sed '$s/}$//' "$SETTINGS_FILE" > "$temp_file"
        
        # Verificar si ya hay configuraciones (no est√° vac√≠o despu√©s de quitar la llave)
        if [ -s "$temp_file" ] && ! grep -q "^{$" "$temp_file"; then
            echo ',' >> "$temp_file"
        fi
        
        # A√±adir configuraciones de wal-theme
        cat >> "$temp_file" << 'EOF'
    "workbench.colorTheme": "Wal",
    "walTheme.autoUpdate": true
}
EOF
    else
        # Crear archivo nuevo
        log "Creando nuevo archivo settings.json"
        cat > "$temp_file" << 'EOF'
{
    "workbench.colorTheme": "Wal",
    "walTheme.autoUpdate": true
}
EOF
    fi
    
    # Validar JSON antes de aplicar
    if command -v jq > /dev/null 2>&1; then
        if jq . "$temp_file" > /dev/null 2>&1; then
            mv "$temp_file" "$SETTINGS_FILE"
            log "Configuraci√≥n aplicada exitosamente"
        else
            log "ERROR: JSON inv√°lido generado"
            rm -f "$temp_file"
            return 1
        fi
    else
        mv "$temp_file" "$SETTINGS_FILE"
        log "Configuraci√≥n aplicada (sin validaci√≥n JSON)"
    fi
}

# Aplicar configuraciones
update_vscode_settings

if [ $? -eq 0 ]; then
    log "VSCode configurado exitosamente para usar wal-theme"
    notify-send "VSCode Wal" "‚úÖ VSCode configurado con tema pywal\nüé® El tema se actualizar√° autom√°ticamente"
else
    log "ERROR: Fallo al configurar VSCode"
    notify-send "Error" "No se pudo configurar VSCode con wal-theme"
    exit 1
fi

# Si pywal ya fue ejecutado anteriormente, aplicar el tema ahora
if [ -f "$HOME/.cache/wal/colors.json" ]; then
    log "Detectada configuraci√≥n pywal existente, aplicando tema"
    
    # Si VSCode est√° corriendo, enviar comando de actualizaci√≥n
    if pgrep -x "code" > /dev/null || pgrep -f "code.*--" > /dev/null; then
        log "VSCode est√° corriendo, enviando comando de actualizaci√≥n"
        code --command "walTheme.update" > /dev/null 2>&1 &
    fi
fi

log "Configuraci√≥n de VSCode wal-theme completada"
