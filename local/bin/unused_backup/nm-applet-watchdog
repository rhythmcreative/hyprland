#!/bin/bash

# nm-applet watchdog - Monitorea y reinicia nm-applet autom√°ticamente
# Usa este script para asegurar que nm-applet siempre est√© corriendo

LOG_FILE="$HOME/.cache/nm-applet-watchdog.log"
INTERVAL=5  # Verificar cada 5 segundos

# Funci√≥n de logging
log() {
    echo "[$(date '+%H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Funci√≥n para iniciar nm-applet
start_nm_applet() {
    log "üöÄ Iniciando nm-applet..."
    
    # Iniciar con variables de entorno apropiadas para Wayland
    env GTK_THEME="Arc-Dark" \
        GDK_BACKEND="wayland,x11" \
        nohup nm-applet > /dev/null 2>&1 &
    
    sleep 2
    
    if pgrep -x nm-applet > /dev/null; then
        log "‚úÖ nm-applet iniciado exitosamente"
        return 0
    else
        log "‚ö†Ô∏è Intento fallback sin variables de entorno..."
        nohup nm-applet > /dev/null 2>&1 &
        sleep 2
        
        if pgrep -x nm-applet > /dev/null; then
            log "‚úÖ nm-applet iniciado en modo fallback"
            return 0
        else
            log "‚ùå ERROR: No se pudo iniciar nm-applet"
            return 1
        fi
    fi
}

# Funci√≥n principal de monitoreo
monitor_nm_applet() {
    log "üì° Iniciando monitoreo de nm-applet (intervalo: ${INTERVAL}s)"
    
    while true; do
        if ! pgrep -x nm-applet > /dev/null; then
            log "‚ö†Ô∏è nm-applet no est√° corriendo, reiniciando..."
            start_nm_applet
        fi
        
        sleep $INTERVAL
    done
}

# Funci√≥n para ejecutar una verificaci√≥n √∫nica
check_once() {
    if ! pgrep -x nm-applet > /dev/null; then
        log "‚ö†Ô∏è nm-applet no est√° corriendo"
        start_nm_applet
    else
        log "‚úÖ nm-applet est√° funcionando correctamente"
    fi
}

# Funci√≥n para matar nm-applet de forma segura
kill_nm_applet() {
    log "üõë Cerrando nm-applet de forma segura..."
    
    local nm_pids=$(pgrep -x nm-applet 2>/dev/null || true)
    
    if [[ -n "$nm_pids" ]]; then
        # Cerrar suavemente primero
        pkill -TERM nm-applet 2>/dev/null || true
        sleep 2
        
        # Verificar si siguen corriendo
        local remaining=$(pgrep -x nm-applet 2>/dev/null || true)
        if [[ -n "$remaining" ]]; then
            log "‚ö†Ô∏è Forzando cierre de nm-applet..."
            pkill -9 nm-applet 2>/dev/null || true
            sleep 1
        fi
        
        log "‚úÖ nm-applet cerrado correctamente"
    else
        log "‚ÑπÔ∏è nm-applet no estaba corriendo"
    fi
}

# Funci√≥n para restart completo
restart_nm_applet() {
    log "üîÑ Reiniciando nm-applet completamente..."
    kill_nm_applet
    sleep 1
    start_nm_applet
}

# Mostrar ayuda
show_help() {
    cat << EOF
nm-applet-watchdog - Monitor y controlador de nm-applet

USO:
    $0 [COMANDO]

COMANDOS:
    monitor     Monitorea nm-applet continuamente y lo reinicia si se cae (por defecto)
    check       Verifica una vez si nm-applet est√° corriendo y lo inicia si es necesario
    start       Inicia nm-applet si no est√° corriendo
    stop        Detiene nm-applet de forma segura
    restart     Reinicia nm-applet (lo mata y lo vuelve a iniciar)
    status      Muestra el estado actual de nm-applet
    help        Muestra esta ayuda

EJEMPLOS:
    $0                  # Monitoreo continuo
    $0 check           # Verificaci√≥n √∫nica
    $0 restart         # Reiniciar nm-applet
    $0 status          # Ver estado

EOF
}

# Funci√≥n para mostrar status
show_status() {
    if pgrep -x nm-applet > /dev/null; then
        local pid=$(pgrep -x nm-applet)
        log "‚úÖ nm-applet est√° corriendo (PID: $pid)"
        
        # Mostrar informaci√≥n adicional si est√° disponible
        if command -v ps > /dev/null; then
            log "üìã Informaci√≥n del proceso:"
            ps -p $pid -o pid,ppid,cmd,etime 2>/dev/null || true
        fi
    else
        log "‚ùå nm-applet NO est√° corriendo"
    fi
}

# Main
case "${1:-monitor}" in
    monitor)
        monitor_nm_applet
        ;;
    check)
        check_once
        ;;
    start)
        start_nm_applet
        ;;
    stop)
        kill_nm_applet
        ;;
    restart)
        restart_nm_applet
        ;;
    status)
        show_status
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "‚ùå Comando desconocido: $1"
        echo "Usa '$0 help' para ver los comandos disponibles."
        exit 1
        ;;
esac
