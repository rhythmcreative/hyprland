#!/bin/bash

# Script de gesti√≥n para el daemon de sincronizaci√≥n P10k-Pywal
# Facilita el control del daemon con comandos simples

SERVICE_NAME="p10k-pywal-sync"
LOG_FILE="$HOME/.cache/p10k-pywal-daemon.log"
PID_FILE="$HOME/.cache/p10k-pywal-daemon.pid"

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Funci√≥n para mostrar el estado del daemon
show_status() {
    echo -e "${CYAN}üîç Estado del daemon P10k-Pywal:${NC}\n"
    
    # Estado del servicio systemd
    if systemctl --user is-active "$SERVICE_NAME" >/dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ Servicio systemd: ACTIVO${NC}"
        if systemctl --user is-enabled "$SERVICE_NAME" >/dev/null 2>&1; then
            echo -e "${GREEN}   üìå Habilitado para inicio autom√°tico${NC}"
        else
            echo -e "${YELLOW}   ‚ö†Ô∏è  No habilitado para inicio autom√°tico${NC}"
        fi
    else
        echo -e "${RED}‚ùå Servicio systemd: INACTIVO${NC}"
    fi
    
    # Estado del proceso
    if [[ -f "$PID_FILE" ]]; then
        local pid=$(cat "$PID_FILE" 2>/dev/null)
        if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
            echo -e "${GREEN}‚úÖ Proceso daemon: EJECUT√ÅNDOSE (PID: $pid)${NC}"
            
            # Mostrar tiempo de funcionamiento
            local start_time=$(ps -o lstart= -p "$pid" 2>/dev/null | head -n1)
            if [[ -n "$start_time" ]]; then
                echo -e "${BLUE}   üïí Iniciado: $start_time${NC}"
            fi
            
            # Mostrar uso de recursos
            local cpu_mem=$(ps -o %cpu,%mem -p "$pid" --no-headers 2>/dev/null)
            if [[ -n "$cpu_mem" ]]; then
                echo -e "${BLUE}   üíª CPU/MEM: $cpu_mem${NC}"
            fi
        else
            echo -e "${YELLOW}‚ö†Ô∏è  Archivo PID existe pero proceso no activo${NC}"
            rm -f "$PID_FILE" 2>/dev/null
        fi
    else
        echo -e "${RED}‚ùå Proceso daemon: NO EJECUT√ÅNDOSE${NC}"
    fi
    
    # Mostrar informaci√≥n del archivo de log
    if [[ -f "$LOG_FILE" ]]; then
        local log_size=$(du -h "$LOG_FILE" 2>/dev/null | cut -f1)
        local last_mod=$(stat -c %y "$LOG_FILE" 2>/dev/null | cut -d. -f1)
        echo -e "${BLUE}üìù Log: $log_size (√öltimo: $last_mod)${NC}"
    fi
    
    echo
}

# Funci√≥n para mostrar ayuda
show_help() {
    echo -e "${CYAN}üîß Gestor del daemon P10k-Pywal Sync${NC}\n"
    echo -e "${PURPLE}Uso: $(basename $0) [comando]${NC}\n"
    echo -e "${YELLOW}Comandos disponibles:${NC}"
    echo -e "  ${GREEN}start${NC}     - Iniciar el daemon"
    echo -e "  ${GREEN}stop${NC}      - Detener el daemon" 
    echo -e "  ${GREEN}restart${NC}   - Reiniciar el daemon"
    echo -e "  ${GREEN}status${NC}    - Mostrar estado del daemon"
    echo -e "  ${GREEN}enable${NC}    - Habilitar inicio autom√°tico"
    echo -e "  ${GREEN}disable${NC}   - Deshabilitar inicio autom√°tico"
    echo -e "  ${GREEN}logs${NC}      - Mostrar logs del daemon"
    echo -e "  ${GREEN}logs -f${NC}   - Seguir logs en tiempo real"
    echo -e "  ${GREEN}test${NC}      - Probar sincronizaci√≥n manual"
    echo -e "  ${GREEN}clean${NC}     - Limpiar archivos temporales"
    echo -e "  ${GREEN}help${NC}      - Mostrar esta ayuda\n"
    echo -e "${BLUE}üí° Ejemplos:${NC}"
    echo -e "  $0 start           # Iniciar daemon"
    echo -e "  $0 status          # Ver estado"
    echo -e "  $0 logs -f         # Ver logs en vivo"
    echo
}

# Funci√≥n para limpiar archivos temporales
clean_temp_files() {
    echo -e "${YELLOW}üßπ Limpiando archivos temporales...${NC}"
    
    local cleaned=false
    
    if [[ -f "$PID_FILE" ]]; then
        echo -e "  ${CYAN}Eliminando archivo PID...${NC}"
        rm -f "$PID_FILE"
        cleaned=true
    fi
    
    if [[ -f "$LOG_FILE" ]] && [[ $(stat -c%s "$LOG_FILE" 2>/dev/null) -gt 10485760 ]]; then
        echo -e "  ${CYAN}Rotando log (>10MB)...${NC}"
        mv "$LOG_FILE" "$LOG_FILE.old" 2>/dev/null
        touch "$LOG_FILE"
        cleaned=true
    fi
    
    if $cleaned; then
        echo -e "${GREEN}‚úÖ Limpieza completada${NC}"
    else
        echo -e "${BLUE}‚ÑπÔ∏è  No hay archivos que limpiar${NC}"
    fi
}

# Funci√≥n para probar sincronizaci√≥n
test_sync() {
    echo -e "${YELLOW}üß™ Probando sincronizaci√≥n manual...${NC}"
    
    if [[ -x "$HOME/.local/bin/p10k-auto-sync" ]]; then
        if "$HOME/.local/bin/p10k-auto-sync"; then
            echo -e "${GREEN}‚úÖ Sincronizaci√≥n manual exitosa${NC}"
        else
            echo -e "${RED}‚ùå Error en sincronizaci√≥n manual${NC}"
            return 1
        fi
    else
        echo -e "${RED}‚ùå Script p10k-auto-sync no encontrado${NC}"
        return 1
    fi
}

# Procesar argumentos
case "${1:-help}" in
    "start")
        echo -e "${YELLOW}üöÄ Iniciando daemon P10k-Pywal...${NC}"
        if systemctl --user start "$SERVICE_NAME"; then
            echo -e "${GREEN}‚úÖ Daemon iniciado correctamente${NC}"
            sleep 2
            show_status
        else
            echo -e "${RED}‚ùå Error al iniciar daemon${NC}"
            exit 1
        fi
        ;;
    
    "stop")
        echo -e "${YELLOW}üõë Deteniendo daemon P10k-Pywal...${NC}"
        if systemctl --user stop "$SERVICE_NAME" 2>/dev/null; then
            echo -e "${GREEN}‚úÖ Daemon detenido correctamente${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è  Daemon ya estaba detenido${NC}"
        fi
        ;;
    
    "restart")
        echo -e "${YELLOW}üîÑ Reiniciando daemon P10k-Pywal...${NC}"
        systemctl --user restart "$SERVICE_NAME"
        echo -e "${GREEN}‚úÖ Daemon reiniciado${NC}"
        sleep 2
        show_status
        ;;
    
    "status")
        show_status
        ;;
    
    "enable")
        echo -e "${YELLOW}üìå Habilitando inicio autom√°tico...${NC}"
        if systemctl --user enable "$SERVICE_NAME"; then
            echo -e "${GREEN}‚úÖ Inicio autom√°tico habilitado${NC}"
        else
            echo -e "${RED}‚ùå Error al habilitar inicio autom√°tico${NC}"
            exit 1
        fi
        ;;
    
    "disable")
        echo -e "${YELLOW}üìå Deshabilitando inicio autom√°tico...${NC}"
        if systemctl --user disable "$SERVICE_NAME"; then
            echo -e "${GREEN}‚úÖ Inicio autom√°tico deshabilitado${NC}"
        else
            echo -e "${RED}‚ùå Error al deshabilitar inicio autom√°tico${NC}"
            exit 1
        fi
        ;;
    
    "logs")
        if [[ "${2:-}" == "-f" ]]; then
            echo -e "${CYAN}üìã Siguiendo logs del daemon (Ctrl+C para salir):${NC}\n"
            if [[ -f "$LOG_FILE" ]]; then
                tail -f "$LOG_FILE"
            else
                echo -e "${YELLOW}‚ö†Ô∏è  Archivo de log no existe a√∫n${NC}"
            fi
        else
            if [[ -f "$LOG_FILE" ]]; then
                echo -e "${CYAN}üìã √öltimas 50 l√≠neas del log:${NC}\n"
                tail -n 50 "$LOG_FILE"
            else
                echo -e "${YELLOW}‚ö†Ô∏è  Archivo de log no existe a√∫n${NC}"
            fi
        fi
        ;;
    
    "test")
        test_sync
        ;;
    
    "clean")
        clean_temp_files
        ;;
    
    "help"|*)
        show_help
        ;;
esac
