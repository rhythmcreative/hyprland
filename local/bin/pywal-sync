#!/bin/bash

# Script de sincronizaciÃ³n rÃ¡pida con pywal - Super + A
# Sincroniza todos los componentes con los colores actuales de pywal
# NO cambia el wallpaper, solo aplica los colores existentes

set -euo pipefail

LOG_FILE="$HOME/.cache/pywal-sync.log"
LOCK_FILE="/tmp/pywal-sync.lock"

# FunciÃ³n de logging con timestamp
log() {
    local message="[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    echo "$message" | tee -a "$LOG_FILE"
}

# FunciÃ³n de notificaciÃ³n
notify() {
    notify-send "ğŸ¨ Pywal Sync" "$1" -t 2000 2>/dev/null || true
}

# Verificar si ya estÃ¡ ejecutÃ¡ndose
if [[ -f "$LOCK_FILE" ]]; then
    lock_pid=$(cat "$LOCK_FILE" 2>/dev/null || echo "")
    if [[ -n "$lock_pid" ]] && kill -0 "$lock_pid" 2>/dev/null; then
        log "â³ SincronizaciÃ³n ya en progreso (PID: $lock_pid)"
        notify "â³ SincronizaciÃ³n ya en progreso..."
        exit 0
    fi
fi

# Crear lock
echo $$ > "$LOCK_FILE"

# Cleanup function
cleanup() {
    rm -f "$LOCK_FILE"
}
trap cleanup EXIT

log "ğŸš€ === INICIANDO SINCRONIZACIÃ“N PYWAL ==="
notify "ğŸ¨ Sincronizando colores pywal..."

# Verificar que existen los colores de pywal
if [[ ! -f "$HOME/.cache/wal/colors.sh" ]]; then
    log "âŒ ERROR: Archivos de pywal no encontrados"
    notify "âŒ Error: Archivos de pywal no encontrados"
    exit 1
fi

# Cargar colores de pywal
source "$HOME/.cache/wal/colors.sh"
log "âœ… Colores pywal cargados"

# PASO 1: Recargar configuraciÃ³n Hyprland
log "ğŸ”„ PASO 1: Recargando Hyprland..."
if hyprctl reload > /dev/null 2>&1; then
    log "âœ… Hyprland recargado"
else
    log "âš ï¸ No se pudo recargar Hyprland"
fi

# PASO 2: Sincronizar Waybar (recarga suave)
log "ğŸ“± PASO 2: Sincronizando Waybar..."
waybar_pids=$(pgrep -x waybar || true)
if [[ -n "$waybar_pids" ]]; then
    # Intentar recarga suave de CSS
    if kill -USR2 $waybar_pids 2>/dev/null; then
        log "âœ… Waybar CSS recargado (SIGUSR2)"
        sleep 1
    elif kill -HUP $waybar_pids 2>/dev/null; then
        log "âœ… Waybar recargado (SIGHUP)"
        sleep 1
    else
        log "ğŸ”„ Reiniciando Waybar..."
        kill -TERM $waybar_pids 2>/dev/null || true
        sleep 1
        waybar > /dev/null 2>&1 &
        sleep 1
        log "âœ… Waybar reiniciado"
    fi
else
    log "ğŸš€ Iniciando Waybar..."
    waybar > /dev/null 2>&1 &
    sleep 1
fi

# PASO 3: Actualizar temas GTK sin reiniciar aplicaciones
log "ğŸ­ PASO 3: Aplicando temas GTK..."
if command -v gsettings &> /dev/null; then
    # Aplicar tema oscuro
    gsettings set org.gnome.desktop.interface color-scheme "prefer-dark" 2>/dev/null || true
    gsettings set org.gnome.desktop.interface gtk-theme "Arc-Dark" 2>/dev/null || true
    gsettings set org.gnome.desktop.interface icon-theme "Tela-circle-black-dark" 2>/dev/null || true
    gsettings set org.gnome.desktop.interface cursor-theme "Bibata-Modern-Ice" 2>/dev/null || true
    log "âœ… ConfiguraciÃ³n GTK aplicada"
fi

# PASO 4: Reiniciar Dunst para aplicar nuevos colores
log "ğŸ”” PASO 4: Reiniciando Dunst..."
if command -v dunst > /dev/null; then
    pkill dunst 2>/dev/null || true
    sleep 0.5
    dunst > /dev/null 2>&1 &
    log "âœ… Dunst reiniciado con nuevos colores"
fi

# PASO 5: Sincronizar componentes adicionales en segundo plano
log "ğŸ”§ PASO 5: Sincronizando componentes adicionales..."

# P10k sync (en segundo plano)
if [[ -x "$HOME/.local/bin/p10k-auto-sync" ]]; then
    "$HOME/.local/bin/p10k-auto-sync" &
    disown
    log "âœ… P10k sync iniciado"
fi

# Oh My Posh sync (en segundo plano)
if [[ -x "$HOME/.local/bin/sync-omp-pywal" ]]; then
    "$HOME/.local/bin/sync-omp-pywal" &
    disown
    log "âœ… Oh My Posh sync iniciado"
fi

# VerificaciÃ³n final
log "ğŸ” VerificaciÃ³n final..."
components_ok=true

if pgrep -x waybar > /dev/null; then
    log "âœ… Waybar funcionando"
else
    log "âš ï¸ Waybar no estÃ¡ corriendo"
    components_ok=false
fi

if [[ -f "$HOME/.cache/wal/colors.sh" ]]; then
    log "âœ… Colores pywal disponibles"
else
    log "âš ï¸ Archivos pywal no encontrados"
    components_ok=false
fi

# Resultado final
if $components_ok; then
    log "ğŸ‰ === SINCRONIZACIÃ“N PYWAL COMPLETADA ==="
    notify "ğŸ‰ SincronizaciÃ³n pywal completada!"
    
    # Mostrar colores principales en el log
    log "ğŸ¨ Color principal: $color1"
    log "ğŸ¨ Color de fondo: $background"
    log "ğŸ¨ Color de texto: $foreground"
else
    log "âš ï¸ === SINCRONIZACIÃ“N PARCIAL ==="
    notify "âš ï¸ SincronizaciÃ³n parcial - algunos componentes fallaron"
fi

log "ğŸ“‹ Log disponible en: $LOG_FILE"
exit 0
