#!/bin/bash

# SYNC TERMINALS + PYWAL - Script maestro
# Sincroniza Kitty + Oh My Posh + P10k automÃ¡ticamente con pywal
# Ejecutado despuÃ©s de cambios de wallpaper

set -euo pipefail

LOG_FILE="$HOME/.cache/sync-terminals-pywal.log"

# FunciÃ³n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# FunciÃ³n de notificaciÃ³n
notify() {
    if command -v notify-send &> /dev/null; then
        notify-send "ğŸ¨ Terminal Sync" "$1" -t 3000 -i terminal 2>/dev/null || true
    fi
}

# Verificar archivos de pywal
check_pywal() {
    if [[ ! -f "$HOME/.cache/wal/colors.json" ]] && [[ ! -f "$HOME/.cache/wal/colors.sh" ]]; then
        log "âŒ Error: Archivos de pywal no encontrados"
        notify "âŒ Archivos de pywal no encontrados"
        exit 1
    fi
    log "âœ… Archivos de pywal encontrados"
}

# Sincronizar Kitty
sync_kitty() {
    log "ğŸ± === SINCRONIZANDO KITTY ==="
    
    if [[ -f "$HOME/.cache/wal/colors-kitty.conf" ]]; then
        log "âœ… Kitty ya estÃ¡ sincronizado con pywal"
        log "ğŸ“„ Archivo: ~/.cache/wal/colors-kitty.conf"
        
        # Verificar que kitty.conf tiene el include
        if ! grep -q "colors-kitty.conf" "$HOME/.config/kitty/kitty.conf" 2>/dev/null; then
            log "âš ï¸ Agregando include de pywal a kitty.conf"
            echo "# Pywal colors" >> "$HOME/.config/kitty/kitty.conf"
            echo "include ~/.cache/wal/colors-kitty.conf" >> "$HOME/.config/kitty/kitty.conf"
        fi
        
        # Intentar recargar kitty si estÃ¡ corriendo
        if pgrep -x kitty > /dev/null; then
            log "ğŸ”„ Enviando seÃ±al de recarga a kitty..."
            kitty @ --to unix:/tmp/kitty-socket set-colors --reset 2>/dev/null || true
            kitty @ --to unix:/tmp/kitty-socket load-config 2>/dev/null || true
        fi
        
        log "âœ… Kitty sincronizado"
    else
        log "âŒ Error: colors-kitty.conf no encontrado"
        log "ğŸ’¡ Regenera colores con: wal -R"
    fi
}

# Sincronizar Oh My Posh (si estÃ¡ instalado)
sync_omp() {
    log "ğŸš€ === SINCRONIZANDO OH MY POSH ==="
    
    if ! command -v oh-my-posh &> /dev/null; then
        log "â„¹ï¸ Oh My Posh no estÃ¡ instalado, omitiendo"
        return 0
    fi
    
    if [[ -x "$HOME/.local/bin/sync-omp-pywal" ]]; then
        log "ğŸ”„ Ejecutando sync-omp-pywal..."
        if "$HOME/.local/bin/sync-omp-pywal"; then
            log "âœ… Oh My Posh sincronizado"
        else
            log "âš ï¸ Advertencia: Error en sync-omp-pywal"
        fi
    else
        log "âŒ Script sync-omp-pywal no encontrado"
    fi
}

# Sincronizar Powerlevel10k (si estÃ¡ activo)
sync_p10k() {
    log "âš¡ === SINCRONIZANDO POWERLEVEL10K ==="
    
    # Verificar si P10k estÃ¡ activo (variable ZSH_THEME o funciÃ³n p10k)
    if [[ -n "${ZSH_VERSION:-}" ]] && [[ "${ZSH_THEME:-}" == *"powerlevel10k"* ]]; then
        log "âœ… Powerlevel10k detectado en ZSH_THEME"
        
        if [[ -x "$HOME/.local/bin/sync-p10k-pywal" ]]; then
            log "ğŸ”„ Ejecutando sync-p10k-pywal..."
            if "$HOME/.local/bin/sync-p10k-pywal"; then
                log "âœ… Powerlevel10k sincronizado"
                
                # Intentar recargar P10k si es posible
                if [[ -n "${functions[p10k]:-}" ]]; then
                    log "ğŸ”„ Recargando Powerlevel10k..."
                    p10k reload 2>/dev/null || true
                fi
            else
                log "âš ï¸ Advertencia: Error en sync-p10k-pywal"
            fi
        else
            log "âŒ Script sync-p10k-pywal no encontrado"
        fi
    else
        log "â„¹ï¸ Powerlevel10k no estÃ¡ activo, omitiendo"
    fi
}

# Aplicar cambios de terminal inmediatamente
apply_terminal_changes() {
    log "âš¡ === APLICANDO CAMBIOS DE TERMINAL ==="
    
    # Recargar secuencias de color en terminales activos
    if [[ -f "$HOME/.cache/wal/sequences" ]]; then
        log "ğŸŒˆ Aplicando secuencias de color..."
        cat "$HOME/.cache/wal/sequences" 2>/dev/null || true
    fi
    
    # Exportar variables de entorno de colores
    if [[ -f "$HOME/.cache/wal/colors.sh" ]]; then
        source "$HOME/.cache/wal/colors.sh"
        log "âœ… Variables de colores exportadas"
    fi
    
    # Crear archivo de estado para otros scripts
    cat > "$HOME/.cache/terminals-sync-status" << EOF
# Terminal Sync Status - $(date)
KITTY_SYNCED=true
OMP_SYNCED=$(command -v oh-my-posh &>/dev/null && echo "true" || echo "false")
P10K_SYNCED=$([[ "${ZSH_THEME:-}" == *"powerlevel10k"* ]] && echo "true" || echo "false")
LAST_SYNC=$(date '+%Y-%m-%d %H:%M:%S')
WALLPAPER_FILE=$(cat ~/.cache/current-wallpaper 2>/dev/null || echo "unknown")
EOF
    
    log "âœ… Estado de sincronizaciÃ³n guardado"
}

# FunciÃ³n principal
main() {
    log "ğŸ¨ === INICIANDO SINCRONIZACIÃ“N TERMINAL + PYWAL ==="
    notify "ğŸ”„ Sincronizando terminales con pywal..."
    
    check_pywal
    sync_kitty
    sync_omp
    sync_p10k
    apply_terminal_changes
    
    log "ğŸ‰ === SINCRONIZACIÃ“N COMPLETADA ==="
    notify "âœ… Terminales sincronizados con pywal"
    
    log "ğŸ“ NOTAS:"
    log "â€¢ Reinicia terminal para aplicar todos los cambios"
    log "â€¢ Kitty: Cambios aplicados automÃ¡ticamente"
    log "â€¢ Oh My Posh: Requiere reinicio de terminal"
    log "â€¢ P10k: Recarga automÃ¡tica si estÃ¡ activo"
}

# Permitir ejecuciÃ³n con argumentos
case "${1:-}" in
    "--kitty-only")
        log "ğŸ± Sincronizando solo Kitty..."
        check_pywal
        sync_kitty
        ;;
    "--omp-only")
        log "ğŸš€ Sincronizando solo Oh My Posh..."
        check_pywal
        sync_omp
        ;;
    "--p10k-only")
        log "âš¡ Sincronizando solo Powerlevel10k..."
        check_pywal
        sync_p10k
        ;;
    "--status")
        if [[ -f "$HOME/.cache/terminals-sync-status" ]]; then
            echo "ğŸ“Š Estado de sincronizaciÃ³n:"
            cat "$HOME/.cache/terminals-sync-status"
        else
            echo "â„¹ï¸ No hay informaciÃ³n de sincronizaciÃ³n disponible"
        fi
        ;;
    *)
        main
        ;;
esac
