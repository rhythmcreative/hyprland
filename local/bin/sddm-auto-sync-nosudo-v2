#!/bin/bash

# Script mejorado para sincronizaci√≥n autom√°tica de wallpaper en SDDM (SIN SUDO)
# Autor: rhythmcreative
# Versi√≥n que NO requiere sudo para sincronizar autom√°ticamente
# Solo usa pkexec cuando es absolutamente necesario y funciona de forma transparente

LOG_FILE="/tmp/sddm-auto-sync-nosudo-v2.log"
USER_HOME="/home/rhythmcreative"
SDDM_SYSTEM_DIR="/usr/share/sddm/themes/sddm-astronaut-theme"
TEMP_DIR="/tmp/sddm-sync-$$"
WALLPAPER_CACHE="$USER_HOME/.cache/sddm-current-wallpaper"
POLKIT_POLICY_DIR="/usr/share/polkit-1/actions"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Funci√≥n para mostrar notificaciones
notify_user() {
    if [[ -n "$DISPLAY" ]] || [[ -n "$WAYLAND_DISPLAY" ]]; then
        notify-send "SDDM Auto-Sync" "$1" 2>/dev/null || true
    fi
}

get_current_wallpaper() {
    # Intentar obtener wallpaper desde pywal
    if [[ -f "$USER_HOME/.cache/wal/wal" ]]; then
        cat "$USER_HOME/.cache/wal/wal" 2>/dev/null
        return 0
    fi
    
    # Fallback: buscar en archivos de configuraci√≥n de swww
    if [[ -f "$USER_HOME/.cache/current-wallpaper" ]]; then
        cat "$USER_HOME/.cache/current-wallpaper" 2>/dev/null
        return 0
    fi
    
    return 1
}

# Verificar si el wallpaper ya est√° aplicado (para evitar cambios innecesarios)
is_wallpaper_current() {
    local wallpaper="$1"
    local config_file="$SDDM_SYSTEM_DIR/Themes/theme1.conf"
    local wallpaper_name=$(basename "$wallpaper")
    
    if [[ -f "$config_file" ]]; then
        if grep -q "Background=\"Backgrounds/$wallpaper_name\"" "$config_file" 2>/dev/null; then
            return 0  # Ya est√° aplicado
        fi
    fi
    
    return 1  # No est√° aplicado
}

# Crear script polkit personalizado (solo necesario una vez)
setup_polkit_rule() {
    local rule_file="/tmp/sddm-sync-rule.rules"
    
    cat > "$rule_file" << 'EOF'
// Regla polkit para permitir sincronizaci√≥n SDDM sin contrase√±a
polkit.addRule(function(action, subject) {
    if (action.id == "org.freedesktop.policykit.exec" &&
        action.lookup("program").indexOf("sddm-sync") > -1 &&
        subject.isInGroup("wheel")) {
        return polkit.Result.YES;
    }
});
EOF
    
    if pkexec cp "$rule_file" "/etc/polkit-1/rules.d/99-sddm-sync.rules" 2>/dev/null; then
        log "‚úÖ Regla polkit instalada para sincronizaci√≥n sin contrase√±a"
        rm -f "$rule_file"
        return 0
    else
        log "‚ö†Ô∏è No se pudo instalar regla polkit (continuando sin ella)"
        rm -f "$rule_file"
        return 1
    fi
}

# Funci√≥n principal de sincronizaci√≥n
sync_wallpaper_direct() {
    local wallpaper="$1"
    local wallpaper_name=$(basename "$wallpaper")
    
    log "üîÑ Iniciando sincronizaci√≥n para: $wallpaper_name"
    
    # Verificar si ya est√° aplicado
    if is_wallpaper_current "$wallpaper"; then
        log "‚úÖ El wallpaper $wallpaper_name ya est√° aplicado en SDDM"
        notify_user "‚úÖ SDDM ya sincronizado con $wallpaper_name"
        return 0
    fi
    
    # Preparar directorio temporal
    mkdir -p "$TEMP_DIR"
    
    # Copiar wallpaper al directorio temporal
    if ! cp "$wallpaper" "$TEMP_DIR/$wallpaper_name"; then
        log "‚ùå Error al copiar wallpaper al directorio temporal"
        return 1
    fi
    
    # Crear script temporal que se ejecutar√° con privilegios m√≠nimos
    local temp_script="$TEMP_DIR/apply-sddm.sh"
    
    cat > "$temp_script" << EOF
#!/bin/bash

WALLPAPER_SRC="$TEMP_DIR/$wallpaper_name"
WALLPAPER_NAME="$wallpaper_name"
SYSTEM_DEST="$SDDM_SYSTEM_DIR/Backgrounds/\$WALLPAPER_NAME"
CONFIG_FILE="$SDDM_SYSTEM_DIR/Themes/theme1.conf"

# Solo mostrar progreso si el comando se ejecuta interactivamente
if [[ -t 1 ]]; then
    echo "üîß Aplicando wallpaper \$WALLPAPER_NAME al sistema SDDM..."
fi

# Crear directorio de backgrounds si no existe
mkdir -p "$SDDM_SYSTEM_DIR/Backgrounds" || exit 1

# Copiar wallpaper
if cp "\$WALLPAPER_SRC" "\$SYSTEM_DEST" 2>/dev/null; then
    chmod 644 "\$SYSTEM_DEST" 2>/dev/null
    [[ -t 1 ]] && echo "‚úÖ Wallpaper copiado: \$WALLPAPER_NAME"
else
    [[ -t 1 ]] && echo "‚ùå Error al copiar wallpaper"
    exit 1
fi

# Actualizar configuraci√≥n
if [[ -f "\$CONFIG_FILE" ]]; then
    # Crear backup solo si no existe uno reciente (√∫ltimo minuto)
    if [[ ! -f "\$CONFIG_FILE.backup" ]] || [[ \$(find "\$CONFIG_FILE.backup" -mmin -1 2>/dev/null) == "" ]]; then
        cp "\$CONFIG_FILE" "\$CONFIG_FILE.backup" 2>/dev/null
    fi
    
    # Actualizar Background
    sed -i "s|^Background=.*|Background=\"Backgrounds/\$WALLPAPER_NAME\"|g" "\$CONFIG_FILE"
    
    # Aplicar colores de pywal si est√°n disponibles
    if [[ -f "$USER_HOME/.cache/wal/colors" ]]; then
        local background=\$(sed -n '1p' "$USER_HOME/.cache/wal/colors")
        local foreground=\$(sed -n '8p' "$USER_HOME/.cache/wal/colors")
        
        # Actualizar colores en configuraci√≥n si existen las l√≠neas
        sed -i "s|BackgroundColor=.*|BackgroundColor=\"\$background\"|g" "\$CONFIG_FILE" 2>/dev/null
        sed -i "s|TextColor=.*|TextColor=\"\$foreground\"|g" "\$CONFIG_FILE" 2>/dev/null
    fi
    
    [[ -t 1 ]] && echo "‚úÖ Configuraci√≥n actualizada"
else
    [[ -t 1 ]] && echo "‚ùå Archivo de configuraci√≥n no encontrado"
    exit 1
fi

# Limpiar archivos temporales
rm -rf "$TEMP_DIR" 2>/dev/null

[[ -t 1 ]] && echo "üéâ Sincronizaci√≥n completada"
exit 0
EOF
    
    chmod +x "$temp_script"
    
    # Ejecutar script con pkexec (se ejecutar√° silenciosamente si hay regla polkit)
    log "üîê Aplicando cambios al sistema..."
    
    # Ejecutar de forma silenciosa para uso autom√°tico
    if pkexec "$temp_script" >/dev/null 2>&1; then
        log "‚úÖ Wallpaper $wallpaper_name aplicado exitosamente"
        notify_user "‚úÖ SDDM sincronizado con $wallpaper_name"
        
        # Guardar wallpaper actual en cache
        echo "$wallpaper" > "$WALLPAPER_CACHE"
        
        # Limpiar temporal si no se limpi√≥ autom√°ticamente
        rm -rf "$TEMP_DIR" 2>/dev/null
        return 0
    else
        log "‚ùå Error al aplicar cambios (permisos denegados o error de sistema)"
        notify_user "‚ùå Error: no se pudo sincronizar SDDM"
        rm -rf "$TEMP_DIR" 2>/dev/null
        return 1
    fi
}

# Funci√≥n principal
main() {
    log "üöÄ Iniciando sincronizaci√≥n autom√°tica SDDM (modo sin sudo)..."
    
    # Obtener wallpaper actual
    CURRENT_WALLPAPER=$(get_current_wallpaper)
    
    if [[ -z "$CURRENT_WALLPAPER" ]] || [[ ! -f "$CURRENT_WALLPAPER" ]]; then
        log "‚ùå No se pudo obtener el wallpaper actual"
        notify_user "‚ùå Wallpaper no encontrado"
        exit 1
    fi
    
    log "üì∏ Wallpaper detectado: $(basename "$CURRENT_WALLPAPER")"
    
    # Verificar si es diferente del √∫ltimo aplicado
    if [[ -f "$WALLPAPER_CACHE" ]]; then
        local cached_wallpaper=$(cat "$WALLPAPER_CACHE" 2>/dev/null)
        if [[ "$cached_wallpaper" == "$CURRENT_WALLPAPER" ]]; then
            log "‚úÖ Wallpaper no ha cambiado desde la √∫ltima sincronizaci√≥n"
            exit 0
        fi
    fi
    
    # Sincronizar wallpaper
    if sync_wallpaper_direct "$CURRENT_WALLPAPER"; then
        log "üéâ Sincronizaci√≥n completada exitosamente"
        echo "‚úÖ SDDM sincronizado con $(basename "$CURRENT_WALLPAPER")"
    else
        log "‚ùå Error en la sincronizaci√≥n"
        echo "‚ùå Error al sincronizar SDDM"
        exit 1
    fi
}

# Funci√≥n de configuraci√≥n inicial
setup() {
    echo "üîß Configuraci√≥n inicial de SDDM Auto-Sync..."
    echo "============================================="
    echo ""
    echo "Este script configurar√° la sincronizaci√≥n autom√°tica de wallpapers para SDDM."
    echo "Se requieren permisos de administrador SOLO para la configuraci√≥n inicial."
    echo ""
    
    # Intentar configurar regla polkit para evitar contrase√±as futuras
    read -p "¬øDeseas configurar regla polkit para evitar contrase√±as en el futuro? (s/n): " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[SsYy]$ ]]; then
        setup_polkit_rule
    fi
    
    echo ""
    echo "‚úÖ Configuraci√≥n completada."
    echo "üîÑ Ahora puedes ejecutar el script normalmente: $(basename "$0")"
    echo ""
}

# Manejo de argumentos
case "$1" in
    --setup)
        setup
        ;;
    --wallpaper)
        if [[ -n "$2" ]] && [[ -f "$2" ]]; then
            log "üñºÔ∏è Sincronizando con wallpaper espec√≠fico: $2"
            sync_wallpaper_direct "$2"
        else
            echo "‚ùå Error: especifica un archivo de wallpaper v√°lido"
            echo "Uso: $0 --wallpaper /ruta/al/wallpaper.jpg"
            exit 1
        fi
        ;;
    --help|-h)
        echo "SDDM Auto-Sync (Sin Sudo) - Sincronizaci√≥n autom√°tica de wallpapers"
        echo "Uso:"
        echo "  $0                    - Sincronizar con wallpaper actual"
        echo "  $0 --setup          - Configuraci√≥n inicial"
        echo "  $0 --wallpaper FILE - Sincronizar con wallpaper espec√≠fico"
        echo "  $0 --help           - Mostrar esta ayuda"
        ;;
    *)
        main
        ;;
esac
