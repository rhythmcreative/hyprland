#!/bin/bash

# Script para aplicar colores de pywal inmediatamente en la sesiÃ³n actual
# Este script debe ejecutarse DESPUÃ‰S de pywal-sync para aplicar cambios visualmente

set -euo pipefail

echo "ğŸ”„ Aplicando colores de pywal inmediatamente..."

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” APLICAR COLORES DE KITTY â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

apply_kitty_colors() {
    local kitty_colors="$HOME/.cache/wal/colors-kitty.conf"
    
    if [[ ! -f "$kitty_colors" ]]; then
        echo "âŒ Archivo de colores de Kitty no encontrado: $kitty_colors"
        return 1
    fi
    
    echo "ğŸ± Aplicando colores a Kitty..."
    
    # MÃ©todo 1: Remote control (mÃ¡s efectivo)
    if [[ -S /tmp/kitty-socket ]] && command -v kitty >/dev/null 2>&1; then
        if kitty @ --to unix:/tmp/kitty-socket set-colors --all "$kitty_colors" 2>/dev/null; then
            echo "âœ… Colores aplicados a Kitty via remote control"
            return 0
        else
            echo "âš ï¸ Remote control fallÃ³, probando otros mÃ©todos..."
        fi
    fi
    
    # MÃ©todo 2: Recargar configuraciÃ³n completa de Kitty
    if command -v kitty >/dev/null 2>&1; then
        # Enviar seÃ±al de recarga a todas las instancias
        pkill -USR1 kitty 2>/dev/null || true
        echo "ğŸ“¤ SeÃ±al de recarga enviada a Kitty"
        
        # Si estamos en una sesiÃ³n de Kitty, recargar configuraciÃ³n
        if [[ "${TERM}" == "xterm-kitty" ]] || [[ "${KITTY_WINDOW_ID:-}" ]]; then
            # Usar escape sequences para recargar colores
            printf '\e]0;Reloading Kitty colors...\a'
            
            # Leer colores del archivo y aplicarlos via escape sequences
            while IFS= read -r line; do
                if [[ "$line" =~ ^(foreground|background|cursor|selection_foreground|selection_background|url_color)\ (.+)$ ]]; then
                    local property="${BASH_REMATCH[1]}"
                    local color="${BASH_REMATCH[2]}"
                    
                    case "$property" in
                        "foreground") printf '\e]10;%s\a' "$color" ;;
                        "background") printf '\e]11;%s\a' "$color" ;;
                        "cursor") printf '\e]12;%s\a' "$color" ;;
                    esac
                fi
            done < "$kitty_colors"
            
            echo "ğŸ¨ Escape sequences enviadas para actualizar colores"
        fi
    fi
}

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” APLICAR COLORES DE POWERLEVEL10K â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

apply_p10k_colors() {
    local p10k_colors="$HOME/.cache/wal/p10k-colors.zsh"
    
    if [[ ! -f "$p10k_colors" ]]; then
        echo "âŒ Archivo de colores de P10k no encontrado: $p10k_colors"
        return 1
    fi
    
    echo "ğŸ¨ Aplicando colores a Powerlevel10k..."
    
    # Solo funciona si estamos en una sesiÃ³n de zsh
    if [[ "${SHELL##*/}" != "zsh" ]] && [[ -z "${ZSH_VERSION:-}" ]]; then
        echo "âš ï¸ No estamos en zsh, aplicando via seÃ±ales a procesos zsh..."
        
        # Enviar seÃ±al a todos los procesos zsh
        local zsh_pids
        readarray -t zsh_pids < <(pgrep -x zsh 2>/dev/null || true)
        
        for pid in "${zsh_pids[@]}"; do
            if [[ -n "$pid" ]] && [[ -e "/proc/$pid" ]]; then
                kill -USR1 "$pid" 2>/dev/null || true
                echo "ğŸ“¤ SeÃ±al USR1 enviada a zsh PID: $pid"
            fi
        done
        return 0
    fi
    
    # Si estamos en zsh, aplicar directamente
    if [[ -n "${ZSH_VERSION:-}" ]]; then
        echo "ğŸ¯ Aplicando en sesiÃ³n zsh actual..."
        
        # Cargar el archivo de colores
        source "$p10k_colors"
        
        # Verificar si powerlevel10k estÃ¡ cargado
        if [[ "${+functions[p10k]}" == 1 ]]; then
            echo "ğŸ”„ Recargando Powerlevel10k..."
            p10k reload
            echo "âœ… Powerlevel10k recargado con nuevos colores"
        else
            echo "âš ï¸ Powerlevel10k no estÃ¡ cargado en esta sesiÃ³n"
        fi
        
        # Forzar actualizaciÃ³n del prompt actual
        if [[ "${+functions[zle]}" == 1 ]]; then
            zle reset-prompt 2>/dev/null || true
        fi
    fi
}

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” APLICAR COLORES DE TERMINAL â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

apply_terminal_colors() {
    echo "ğŸ–¥ï¸ Aplicando colores base del terminal..."
    
    # Aplicar secuencias de pywal si estÃ¡n disponibles
    local sequences_file="$HOME/.cache/wal/sequences"
    if [[ -f "$sequences_file" ]]; then
        cat "$sequences_file"
        echo "ğŸ¨ Secuencias de colores aplicadas"
    fi
    
    # Aplicar colores TTY si estÃ¡n disponibles
    local tty_colors="$HOME/.cache/wal/colors-tty.sh"
    if [[ -f "$tty_colors" ]]; then
        source "$tty_colors"
        echo "ğŸ–¥ï¸ Colores TTY aplicados"
    fi
}

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” FUNCIÃ“N PRINCIPAL â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

main() {
    echo "ğŸš€ Aplicando colores de pywal inmediatamente..."
    echo "ğŸ“ Terminal actual: ${TERM:-unknown}"
    echo "ğŸš Shell actual: ${SHELL##*/} ${ZSH_VERSION:-${BASH_VERSION:-unknown}}"
    echo ""
    
    local success=true
    
    # Aplicar colores base del terminal primero
    apply_terminal_colors
    echo ""
    
    # Aplicar colores de Kitty
    if ! apply_kitty_colors; then
        echo "âš ï¸ Algunos problemas aplicando colores de Kitty"
        success=false
    fi
    echo ""
    
    # Aplicar colores de Powerlevel10k
    if ! apply_p10k_colors; then
        echo "âš ï¸ Algunos problemas aplicando colores de Powerlevel10k"
        success=false
    fi
    echo ""
    
    if [[ "$success" == "true" ]]; then
        echo "ğŸ‰ Â¡Colores aplicados exitosamente!"
        echo "ğŸ’¡ Si no ves cambios inmediatos, prueba abrir un nuevo terminal"
    else
        echo "âš ï¸ AplicaciÃ³n completada con algunas advertencias"
        echo "ğŸ”„ Para aplicar completamente: reinicia el terminal o ejecuta 'source ~/.zshrc'"
    fi
    
    # Consejo final
    echo ""
    echo "ğŸ¯ CONSEJOS:"
    echo "  â€¢ Para Kitty: Los cambios se aplican mejor con Ctrl+Shift+F5 (recargar config)"
    echo "  â€¢ Para P10k: Los cambios se ven mejor en terminales nuevos"
    echo "  â€¢ Ejecuta 'source ~/.zshrc' para cargar completamente los cambios"
}

# Ejecutar si se llama directamente
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
