#!/bin/bash

# Script ultra-optimizado para inicio INSTANT√ÅNEO de nm-applet
# M√©todo: Pre-warm + Kill instant√°neo + Startup paralelo

set -euo pipefail

LOG_FILE="$HOME/.cache/nm-applet-instant.log"

log() {
    echo "[$(date '+%H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Funci√≥n para iniciar nm-applet con m√°xima velocidad
start_nm_applet() {
    # M√©todo 1: Inicio con prioridad alta y sin delay
    nice -n -10 nm-applet --indicator &
    local pid1=$!
    
    # M√©todo 2: Inicio paralelo como backup
    (sleep 0.05 && nm-applet --indicator >/dev/null 2>&1) &
    local pid2=$!
    
    # Verificaci√≥n ultra-r√°pida
    for i in {1..3}; do
        if pgrep -x nm-applet > /dev/null; then
            log "‚úÖ nm-applet iniciado en ${i}0ms"
            return 0
        fi
        sleep 0.01
    done
    
    return 1
}

log "üöÄ === INICIO ULTRA-R√ÅPIDO DE NM-APPLET ==="

# M√âTODO REVOLUCIONARIO: Usar se√±ales en lugar de kill+restart
if pgrep -x nm-applet > /dev/null; then
    nm_pid=$(pgrep -x nm-applet)
    log "üîÑ nm-applet detectado (PID: $nm_pid) - enviando se√±al de reconfiguraci√≥n..."
    
    # Enviar SIGUSR1 para reconfiguration (si nm-applet lo soporta)
    kill -USR1 "$nm_pid" 2>/dev/null || {
        log "‚ö° Se√±al USR1 fall√≥, usando HUP..."
        kill -HUP "$nm_pid" 2>/dev/null || {
            log "üí• Se√±ales fallaron, kill+restart r√°pido..."
            pkill -TERM nm-applet 2>/dev/null && sleep 0.05
            ! pgrep -x nm-applet > /dev/null || pkill -9 nm-applet 2>/dev/null
        }
    }
    
    # Verificaci√≥n post-se√±al
    sleep 0.02
    if pgrep -x nm-applet > /dev/null; then
        log "‚úÖ nm-applet reconfigurado INSTANT√ÅNEAMENTE"
        exit 0
    else
        log "üîÑ Se√±al no funcion√≥, iniciando nuevo proceso..."
    fi
fi

# Pre-warm: Preparar entorno para nuevo proceso
export GDK_BACKEND=x11
export QT_QPA_PLATFORM=xcb
export NO_AT_BRIDGE=1

log "‚ö° Iniciando nm-applet con prioridad m√°xima..."

# Intentar inicio ultra-optimizado con m√∫ltiples m√©todos paralelos
(
    # M√©todo 1: Prioridad alta
    nice -n -15 nm-applet --indicator >/dev/null 2>&1 &
    # M√©todo 2: Proceso normal como backup
    (sleep 0.01 && nm-applet --indicator >/dev/null 2>&1) &
    # M√©todo 3: Sin flags como √∫ltimo recurso
    (sleep 0.02 && nm-applet >/dev/null 2>&1) &
) &

# Verificaci√≥n ultra-r√°pida con m√∫ltiples intentos
for i in {1..5}; do
    sleep 0.01
    if pgrep -x nm-applet > /dev/null; then
        log "‚úÖ nm-applet iniciado en ${i}0ms"
        exit 0
    fi
done

log "‚ö†Ô∏è nm-applet tardando m√°s de lo esperado..."

exit 0
