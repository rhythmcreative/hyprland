#!/bin/bash

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                          GTK PyWal Theme Synchronizer                                 â•‘  
# â•‘                                                                                       â•‘
# â•‘  Script que sincroniza tema GTK con colores pywal y reinicia nm-applet               â•‘
# â•‘                          by rhythmcreative                                            â•‘
# â•‘                                                                                       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# FunciÃ³n para mostrar mensajes con colores
show_message() {
    echo -e "${GREEN}[GTK-PYWAL]${NC} $1"
}

show_warning() {
    echo -e "${YELLOW}[GTK-PYWAL]${NC} $1"
}

show_error() {
    echo -e "${RED}[GTK-PYWAL]${NC} $1"
}

# Verificar si pywal estÃ¡ instalado
if ! command -v wal &> /dev/null; then
    show_error "pywal no estÃ¡ instalado. InstÃ¡lalo con: pip install pywal"
    exit 1
fi

# Verificar si los colores de pywal existen
PYWAL_COLORS="$HOME/.cache/wal/colors.sh"
if [[ ! -f "$PYWAL_COLORS" ]]; then
    show_error "Colores de pywal no encontrados. Ejecuta 'wal -i imagen.jpg' primero"
    exit 1
fi

# Cargar colores de pywal
source "$PYWAL_COLORS"

show_message "ðŸŽ¨ Aplicando tema GTK con colores pywal..."

# Crear directorio para temas GTK si no existe
GTK_THEME_DIR="$HOME/.themes/PyWal-GTK"
mkdir -p "$GTK_THEME_DIR/gtk-3.0"
mkdir -p "$GTK_THEME_DIR/gtk-4.0"

# Generar tema GTK 3.0
show_message "ðŸ“ Generando tema GTK 3.0..."
cat > "$GTK_THEME_DIR/gtk-3.0/gtk.css" << EOF
/* PyWal GTK Theme - Generated automatically */
/* Colors from pywal */

/* Define color palette */
@define-color bg_color ${background};
@define-color fg_color ${foreground};
@define-color base_color ${color0};
@define-color text_color ${foreground};
@define-color selected_bg_color ${color6};
@define-color selected_fg_color ${background};
@define-color tooltip_bg_color ${color8};
@define-color tooltip_fg_color ${foreground};
@define-color theme_bg_color ${background};
@define-color theme_fg_color ${foreground};
@define-color theme_base_color ${color0};
@define-color theme_text_color ${foreground};
@define-color theme_selected_bg_color ${color6};
@define-color theme_selected_fg_color ${background};

/* Window styling */
window {
    background-color: ${background};
    color: ${foreground};
}

/* Headerbar styling */
headerbar {
    background: linear-gradient(to bottom, ${color8}, ${background});
    color: ${foreground};
    border-bottom: 1px solid ${color8};
}

headerbar button {
    background-color: transparent;
    color: ${foreground};
    border: 1px solid ${color8};
    border-radius: 6px;
}

headerbar button:hover {
    background-color: ${color8};
    color: ${foreground};
}

headerbar button:active {
    background-color: ${color6};
    color: ${background};
}

/* Button styling */
button {
    background: linear-gradient(to bottom, ${color8}, ${color0});
    color: ${foreground};
    border: 1px solid ${color8};
    border-radius: 6px;
    padding: 8px 12px;
}

button:hover {
    background: linear-gradient(to bottom, ${color6}, ${color8});
    color: ${background};
}

button:active {
    background-color: ${color6};
    color: ${background};
}

/* Entry (input) styling */
entry {
    background-color: ${color0};
    color: ${foreground};
    border: 1px solid ${color8};
    border-radius: 4px;
}

entry:focus {
    border-color: ${color6};
    box-shadow: 0 0 0 1px ${color6};
}

/* Selection styling */
selection {
    background-color: ${color6};
    color: ${background};
}

/* Menu styling */
menu {
    background-color: ${background};
    color: ${foreground};
    border: 1px solid ${color8};
}

menuitem {
    padding: 8px 12px;
}

menuitem:hover {
    background-color: ${color6};
    color: ${background};
}

/* Scrollbar styling */
scrollbar slider {
    background-color: ${color8};
    border-radius: 10px;
}

scrollbar slider:hover {
    background-color: ${color6};
}

/* Switch styling */
switch {
    background-color: ${color8};
    border-radius: 16px;
}

switch:checked {
    background-color: ${color6};
}

switch slider {
    background-color: ${foreground};
    border-radius: 50%;
}

/* Notebook (tabs) styling */
notebook header {
    background-color: ${background};
    border-bottom: 1px solid ${color8};
}

notebook tab {
    background-color: ${color0};
    color: ${foreground};
    border: 1px solid ${color8};
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    padding: 8px 16px;
}

notebook tab:checked {
    background-color: ${color6};
    color: ${background};
}

/* Progressbar styling */
progressbar progress {
    background-color: ${color6};
    border-radius: 4px;
}

progressbar trough {
    background-color: ${color8};
    border-radius: 4px;
}

/* Treeview styling */
treeview {
    background-color: ${color0};
    color: ${foreground};
}

treeview:selected {
    background-color: ${color6};
    color: ${background};
}

/* Tooltip styling */
tooltip {
    background-color: ${color8};
    color: ${foreground};
    border: 1px solid ${color6};
    border-radius: 4px;
    padding: 4px 8px;
}
EOF

# Generar tema GTK 4.0 (similar pero con sintaxis actualizada)
show_message "ðŸ“ Generando tema GTK 4.0..."
cat > "$GTK_THEME_DIR/gtk-4.0/gtk.css" << EOF
/* PyWal GTK 4.0 Theme - Generated automatically */
/* Colors from pywal */

/* Define color palette */
@define-color accent_bg_color ${color6};
@define-color accent_fg_color ${background};
@define-color destructive_bg_color ${color1};
@define-color destructive_fg_color ${background};
@define-color success_bg_color ${color2};
@define-color success_fg_color ${background};
@define-color warning_bg_color ${color3};
@define-color warning_fg_color ${background};
@define-color error_bg_color ${color1};
@define-color error_fg_color ${background};
@define-color window_bg_color ${background};
@define-color window_fg_color ${foreground};
@define-color view_bg_color ${color0};
@define-color view_fg_color ${foreground};
@define-color headerbar_bg_color ${background};
@define-color headerbar_fg_color ${foreground};
@define-color popover_bg_color ${background};
@define-color popover_fg_color ${foreground};
@define-color shade_color rgba(0,0,0,.36);
@define-color scrollbar_outline_color rgba(255,255,255,.1);

/* Window styling */
window {
    background-color: @window_bg_color;
    color: @window_fg_color;
}

/* Button styling */
button {
    background: linear-gradient(to bottom, ${color8}, ${color0});
    color: ${foreground};
    border: 1px solid ${color8};
    border-radius: 6px;
    padding: 8px 12px;
}

button:hover {
    background: linear-gradient(to bottom, ${color6}, ${color8});
    color: ${background};
}

button.suggested-action {
    background-color: @accent_bg_color;
    color: @accent_fg_color;
}

button.destructive-action {
    background-color: @destructive_bg_color;
    color: @destructive_fg_color;
}

/* Entry styling */
entry {
    background-color: @view_bg_color;
    color: @view_fg_color;
    border: 1px solid ${color8};
    border-radius: 6px;
}

entry:focus {
    border-color: @accent_bg_color;
    outline: 2px solid alpha(@accent_bg_color, 0.3);
}

/* HeaderBar styling */
headerbar {
    background-color: @headerbar_bg_color;
    color: @headerbar_fg_color;
    border-bottom: 1px solid ${color8};
}

/* Switch styling */
switch {
    background-color: ${color8};
    border-radius: 16px;
}

switch:checked {
    background-color: @accent_bg_color;
}

/* Scrollbar styling */
scrollbar slider {
    background-color: ${color8};
    border-radius: 10px;
}

scrollbar slider:hover {
    background-color: @accent_bg_color;
}

/* Selection styling */
selection {
    background-color: @accent_bg_color;
    color: @accent_fg_color;
}
EOF

# Configurar gsettings para usar el tema
show_message "âš™ï¸  Configurando gsettings para usar el tema PyWal-GTK..."
gsettings set org.gnome.desktop.interface gtk-theme "PyWal-GTK"
gsettings set org.gnome.desktop.wm.preferences theme "PyWal-GTK"

# Configurar variables de entorno GTK
export GTK_THEME="PyWal-GTK"

# Reiniciar nm-applet con nuevo tema
show_message "ðŸ”„ Reiniciando nm-applet para aplicar nuevo tema..."
pkill -f nm-applet
sleep 1
nohup nm-applet > /dev/null 2>&1 &

# Aplicar tema a aplicaciones Qt tambiÃ©n
show_message "ðŸŽ¨ Aplicando colores a aplicaciones Qt..."
if command -v qt5ct &> /dev/null; then
    # Crear configuraciÃ³n Qt5ct si no existe
    QT5CT_DIR="$HOME/.config/qt5ct"
    mkdir -p "$QT5CT_DIR/colors"
    
    cat > "$QT5CT_DIR/colors/PyWal.conf" << EOF
[ColorScheme]
active_colors=${foreground}, ${background}, ${color8}, ${color6}, ${color0}, ${color8}, ${foreground}, ${foreground}, ${foreground}, ${background}, ${background}, ${color8}, ${color6}, ${foreground}, ${color6}, ${color1}, ${background}, ${foreground}, ${color8}, ${foreground}, ${color8}
disabled_colors=${color8}, ${background}, ${color8}, ${color6}, ${color0}, ${color8}, ${color8}, ${color8}, ${color8}, ${background}, ${background}, ${color8}, ${color8}, ${color8}, ${color6}, ${color1}, ${background}, ${color8}, ${color8}, ${color8}, ${color8}
inactive_colors=${foreground}, ${background}, ${color8}, ${color6}, ${color0}, ${color8}, ${foreground}, ${foreground}, ${foreground}, ${background}, ${background}, ${color8}, ${color6}, ${foreground}, ${color6}, ${color1}, ${background}, ${foreground}, ${color8}, ${foreground}, ${color8}
EOF
fi

# NotificaciÃ³n de Ã©xito
show_message "âœ… Tema GTK PyWal aplicado exitosamente!"
show_message "ðŸŽ¯ Colores principales:"
echo -e "   â€¢ Fondo: ${background}"
echo -e "   â€¢ Texto: ${foreground}"  
echo -e "   â€¢ Acento: ${color6}"
echo -e "   â€¢ Secundario: ${color8}"

# Opcional: mostrar notificaciÃ³n visual si dunst estÃ¡ disponible
if command -v notify-send &> /dev/null; then
    notify-send "GTK PyWal Theme" "Tema aplicado exitosamente! ðŸŽ¨" -t 3000
fi

exit 0
