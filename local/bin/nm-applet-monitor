#!/bin/bash

# Monitor simple para sincronizar nm-applet con waybar autom√°ticamente
# Este script se ejecuta en background y vigila cambios en los colores

PIDFILE="/tmp/nm-applet-monitor.pid"
LOGFILE="/tmp/nm-applet-monitor.log"

# Funci√≥n de logging
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOGFILE"
}

# Funci√≥n para detener el monitor
stop_monitor() {
    if [ -f "$PIDFILE" ]; then
        local pid=$(cat "$PIDFILE")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null
            rm -f "$PIDFILE"
            echo "üõë Monitor detenido"
            return 0
        else
            rm -f "$PIDFILE"
        fi
    fi
    echo "‚ö†Ô∏è El monitor no estaba ejecut√°ndose"
}

# Funci√≥n principal del monitor
start_monitor() {
    # Verificar si ya est√° ejecut√°ndose
    if [ -f "$PIDFILE" ]; then
        local pid=$(cat "$PIDFILE")
        if kill -0 "$pid" 2>/dev/null; then
            echo "‚ùå El monitor ya est√° ejecut√°ndose (PID: $pid)"
            return 1
        else
            rm -f "$PIDFILE"
        fi
    fi
    
    echo "üöÄ Iniciando monitor de sincronizaci√≥n nm-applet ‚Üî waybar..."
    
    # Crear script temporal para el monitor
    local temp_script="/tmp/nm-applet-monitor-worker.sh"
    cat > "$temp_script" << 'EOF'
#!/bin/bash
PIDFILE="/tmp/nm-applet-monitor.pid"
LOGFILE="/tmp/nm-applet-monitor.log"

# Funci√≥n de logging
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOGFILE"
}

# Escribir PID
echo $$ > "$PIDFILE"
log "Monitor iniciado (PID: $$)"

colors_file="$HOME/.config/waybar/colors-pywal.css"
sync_script="$HOME/.local/bin/sync-nm-applet-waybar"
last_checksum=""

# Trap para limpiar al salir
trap 'rm -f "$PIDFILE"; log "Monitor detenido"; exit' TERM INT EXIT

# Loop de monitorizaci√≥n
while true; do
    if [ -f "$colors_file" ]; then
        current_checksum=$(md5sum "$colors_file" 2>/dev/null | cut -d' ' -f1)
        
        if [ "$current_checksum" != "$last_checksum" ] && [ -n "$current_checksum" ]; then
            if [ -n "$last_checksum" ]; then
                log "üé® Cambios detectados, sincronizando nm-applet..."
                "$sync_script" > /dev/null 2>&1 &
                log "‚úÖ Sincronizaci√≥n iniciada"
            fi
            last_checksum="$current_checksum"
        fi
    fi
    
    sleep 3
done
EOF
    
    chmod +x "$temp_script"
    
    # Ejecutar con nohup para mayor estabilidad
    nohup bash "$temp_script" > /dev/null 2>&1 &
    local monitor_pid=$!
    
    # Esperar un momento para verificar que se inici√≥ correctamente
    sleep 2
    
    if kill -0 "$monitor_pid" 2>/dev/null; then
        echo "‚úÖ Monitor iniciado correctamente (PID: $monitor_pid)"
    else
        echo "‚ùå Error al iniciar el monitor"
        return 1
    fi
    echo "üìÅ Log: $LOGFILE"
    echo "üí° Para detener: $0 stop"
}

# Funci√≥n para mostrar estado
status_monitor() {
    if [ -f "$PIDFILE" ]; then
        local pid=$(cat "$PIDFILE")
        if kill -0 "$pid" 2>/dev/null; then
            echo "‚úÖ Monitor ejecut√°ndose (PID: $pid)"
            echo "üìÅ Log: $LOGFILE"
            if [ -f "$LOGFILE" ]; then
                echo "üìä √öltimas l√≠neas:"
                tail -3 "$LOGFILE" 2>/dev/null | sed 's/^/  /'
            fi
            return 0
        else
            rm -f "$PIDFILE"
        fi
    fi
    echo "‚ö†Ô∏è El monitor no est√° ejecut√°ndose"
    return 1
}

# Funci√≥n principal
case "${1:-start}" in
    "start")
        start_monitor
        ;;
    "stop")
        stop_monitor
        ;;
    "status")
        status_monitor
        ;;
    "restart")
        stop_monitor
        sleep 1
        start_monitor
        ;;
    *)
        echo "Uso: $0 {start|stop|status|restart}"
        echo ""
        echo "  start   - Iniciar monitor (por defecto)"
        echo "  stop    - Detener monitor"
        echo "  status  - Ver estado"
        echo "  restart - Reiniciar monitor"
        ;;
esac
