#!/bin/bash

# Script mejorado para reiniciar waybar UNA SOLA VEZ sin conflictos
# Evita reinicios m√∫ltiples y mejora la sincronizaci√≥n de colores
# Versi√≥n optimizada con debouncing y detecci√≥n de cambios recientes

LOCK_FILE="/tmp/waybar-restart.lock"
LOG_FILE="$HOME/.cache/waybar-single-restart.log"
LAST_RESTART_FILE="/tmp/waybar-last-restart"
DEBOUNCE_SECONDS=8  # Tiempo m√≠nimo entre reinicios

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Funci√≥n para verificar si es necesario hacer debouncing
check_debouncing() {
    if [[ -f "$LAST_RESTART_FILE" ]]; then
        local last_restart=$(cat "$LAST_RESTART_FILE" 2>/dev/null || echo "0")
        local current_time=$(date +%s)
        local time_diff=$((current_time - last_restart))
        
        if [[ $time_diff -lt $DEBOUNCE_SECONDS ]]; then
            log "‚è≥ Debouncing: √öltimo reinicio hace ${time_diff}s (m√≠n: ${DEBOUNCE_SECONDS}s)"
            log "üö´ Reinicio cancelado para evitar exceso de reinicios"
            # Actualizar el tiempo para extender el debouncing
            echo "$current_time" > "$LAST_RESTART_FILE"
            exit 0
        fi
    fi
    
    # Registrar tiempo actual
    echo "$(date +%s)" > "$LAST_RESTART_FILE"
}

# Verificar si ya hay un reinicio en progreso
if [[ -f "$LOCK_FILE" ]]; then
    lock_pid=$(cat "$LOCK_FILE" 2>/dev/null)
    if [[ -n "$lock_pid" ]] && kill -0 "$lock_pid" 2>/dev/null; then
        log "‚è≥ Reinicio ya en progreso (PID: $lock_pid), esperando..."
        # Esperar hasta 10 segundos a que termine el proceso
        for i in {1..20}; do
            if ! kill -0 "$lock_pid" 2>/dev/null; then
                break
            fi
            sleep 0.5
        done
        if kill -0 "$lock_pid" 2>/dev/null; then
            log "‚ö†Ô∏è Proceso de reinicio anterior se colg√≥, continuando..."
            rm -f "$LOCK_FILE"
        else
            log "‚úÖ Proceso anterior termin√≥, waybar ya deber√≠a estar corriendo"
            exit 0
        fi
    else
        # Archivo de bloqueo hu√©rfano, eliminarlo
        rm -f "$LOCK_FILE"
    fi
fi

# Verificar debouncing antes de proceder
check_debouncing

# Crear archivo de bloqueo
echo $$ > "$LOCK_FILE"

# Funci√≥n de limpieza
cleanup() {
    rm -f "$LOCK_FILE"
}
trap cleanup EXIT

log "=== Iniciando reinicio √∫nico de waybar ==="

# Paso 1: Detener waybar actual de forma inteligente
waybar_pids=$(pgrep -x waybar 2>/dev/null)
if [[ -n "$waybar_pids" ]]; then
    pid_count=$(echo "$waybar_pids" | wc -l)
    log "üîÑ Deteniendo $pid_count instancia(s) de waybar..."
    
    # Intentar cierre suave primero
    kill -TERM $waybar_pids 2>/dev/null
    
    # Esperar hasta 5 segundos a que se cierren
    for i in {1..10}; do
        if ! pgrep -x waybar >/dev/null 2>&1; then
            break
        fi
        sleep 0.5
    done
    
    # Si siguen corriendo, forzar cierre
    if pgrep -x waybar >/dev/null 2>&1; then
        log "‚ö†Ô∏è Forzando cierre de procesos persistentes..."
        pkill -KILL waybar 2>/dev/null
        sleep 1
    fi
    
    log "‚úÖ Todos los procesos waybar cerrados"
else
    log "‚ÑπÔ∏è Waybar no estaba corriendo"
fi

# Paso 2: Esperar a que los archivos de configuraci√≥n est√©n listos
log "‚è≥ Esperando configuraci√≥n..."
attempts=0
while [[ $attempts -lt 20 ]]; do
    if [[ -f ~/.cache/wal/colors-hyprland.conf ]] || [[ $attempts -gt 10 ]]; then
        break
    fi
    sleep 0.2
    ((attempts++))
done

# Paso 3: Iniciar waybar UNA sola vez
log "üöÄ Iniciando waybar..."
if waybar &>/dev/null & then
    waybar_pid=$!
    sleep 2
    
    # Verificar que waybar est√° corriendo
    if kill -0 "$waybar_pid" 2>/dev/null && pgrep -x waybar >/dev/null; then
        log "‚úÖ Waybar iniciado correctamente (PID: $waybar_pid)"
        notify-send "‚úÖ Waybar" "Reiniciado exitosamente" -t 2000 2>/dev/null || true
    else
        log "‚ùå Waybar fall√≥ al iniciar"
        # Intentar una vez m√°s con configuraci√≥n b√°sica
        if waybar & then
            sleep 2
            if pgrep -x waybar >/dev/null; then
                log "‚úÖ Waybar iniciado con configuraci√≥n b√°sica"
                notify-send "‚ö†Ô∏è Waybar" "Iniciado con configuraci√≥n b√°sica" -t 2000 2>/dev/null || true
            else
                log "‚ùå ERROR CR√çTICO: No se pudo iniciar waybar"
                notify-send "‚ùå Error Waybar" "No se pudo iniciar" -u critical -t 5000 2>/dev/null || true
                exit 1
            fi
        fi
    fi
else
    log "‚ùå Error al ejecutar waybar"
    exit 1
fi

log "=== Reinicio √∫nico completado ==="
