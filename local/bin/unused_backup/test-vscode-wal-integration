#!/bin/bash

# Script de prueba para verificar la integraci√≥n completa de VSCode con pywal

LOG_FILE="$HOME/.cache/wallpaper-theme.log"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [Test-VSCode-Wal] $1" >> "$LOG_FILE"
    echo "[Test-VSCode-Wal] $1"
}

echo "üß™ Probando integraci√≥n VSCode + pywal..."
log "Iniciando prueba de integraci√≥n VSCode + pywal"

# Verificar componentes necesarios
echo ""
echo "üîç Verificando componentes..."

# 1. Verificar pywal
if command -v wal > /dev/null 2>&1; then
    echo "‚úÖ pywal est√° instalado"
    log "pywal: ‚úÖ"
else
    echo "‚ùå pywal no est√° instalado"
    log "pywal: ‚ùå"
    exit 1
fi

# 2. Verificar VSCode
if command -v code > /dev/null 2>&1; then
    echo "‚úÖ VSCode est√° instalado"
    log "VSCode: ‚úÖ"
else
    echo "‚ùå VSCode no est√° instalado"
    log "VSCode: ‚ùå"
    exit 1
fi

# 3. Verificar extensi√≥n wal-theme
if code --list-extensions | grep -q "dlasagno.wal-theme"; then
    echo "‚úÖ Extensi√≥n wal-theme instalada"
    log "Extensi√≥n wal-theme: ‚úÖ"
else
    echo "‚ùå Extensi√≥n wal-theme no instalada"
    log "Extensi√≥n wal-theme: ‚ùå"
    echo "   Ejecutando: /home/rhythmcreative/.local/bin/configure-vscode-wal"
    /home/rhythmcreative/.local/bin/configure-vscode-wal
fi

# 4. Verificar configuraci√≥n de VSCode
VSCODE_SETTINGS="$HOME/.config/Code/User/settings.json"
if [ -f "$VSCODE_SETTINGS" ]; then
    if grep -q "\"workbench.colorTheme\": \"Wal\"" "$VSCODE_SETTINGS" && grep -q "\"walTheme.autoUpdate\": true" "$VSCODE_SETTINGS"; then
        echo "‚úÖ VSCode configurado para usar tema Wal"
        log "Configuraci√≥n VSCode: ‚úÖ"
    else
        echo "‚ö†Ô∏è  VSCode no est√° configurado correctamente"
        log "Configuraci√≥n VSCode: ‚ö†Ô∏è"
        echo "   Ejecutando configuraci√≥n autom√°tica..."
        /home/rhythmcreative/.local/bin/configure-vscode-wal
    fi
else
    echo "‚ö†Ô∏è  Archivo settings.json no existe"
    log "settings.json: ‚ö†Ô∏è"
    echo "   Ejecutando configuraci√≥n autom√°tica..."
    /home/rhythmcreative/.local/bin/configure-vscode-wal
fi

# 5. Verificar que pywal haya sido ejecutado al menos una vez
if [ -f "$HOME/.cache/wal/colors.json" ]; then
    echo "‚úÖ pywal ha sido ejecutado (colores disponibles)"
    log "Colores pywal: ‚úÖ"
    
    # Mostrar colores actuales
    if command -v jq > /dev/null 2>&1; then
        current_wallpaper=$(jq -r '.wallpaper' "$HOME/.cache/wal/colors.json" 2>/dev/null)
        if [ "$current_wallpaper" != "null" ] && [ -n "$current_wallpaper" ]; then
            echo "   Wallpaper actual: $(basename "$current_wallpaper")"
            log "Wallpaper actual: $current_wallpaper"
        fi
    fi
else
    echo "‚ö†Ô∏è  pywal no ha sido ejecutado a√∫n"
    log "Colores pywal: ‚ö†Ô∏è"
    echo "   Para probar completamente, ejecuta el selector de wallpaper con Super+Shift+W"
fi

# 6. Verificar scripts necesarios
echo ""
echo "üîç Verificando scripts..."

scripts=(
    "/home/rhythmcreative/.local/bin/wallpaper-selector-hyde"
    "/home/rhythmcreative/.local/bin/configure-vscode-wal"
)

for script in "${scripts[@]}"; do
    if [ -f "$script" ] && [ -x "$script" ]; then
        echo "‚úÖ $(basename "$script")"
        log "Script $script: ‚úÖ"
    else
        echo "‚ùå $(basename "$script") (no existe o no es ejecutable)"
        log "Script $script: ‚ùå"
    fi
done

# 7. Verificar binding de Hyprland
echo ""
echo "üîç Verificando configuraci√≥n de Hyprland..."

HYPRLAND_CONFIG="$HOME/.config/hypr/hyprland.conf"
if [ -f "$HYPRLAND_CONFIG" ]; then
    if grep -q "bind.*mainMod.*SHIFT.*W.*wallpaper-selector-hyde" "$HYPRLAND_CONFIG"; then
        echo "‚úÖ Binding Super+Shift+W configurado"
        log "Hyprland binding: ‚úÖ"
    else
        echo "‚ö†Ô∏è  Binding Super+Shift+W no encontrado o incorrecto"
        log "Hyprland binding: ‚ö†Ô∏è"
    fi
else
    echo "‚ö†Ô∏è  Archivo hyprland.conf no encontrado"
    log "Hyprland config: ‚ö†Ô∏è"
fi

# 8. Prueba funcional (si VSCode est√° corriendo)
echo ""
echo "üß™ Prueba funcional..."

if pgrep -x "code" > /dev/null || pgrep -f "code.*--" > /dev/null; then
    echo "‚úÖ VSCode est√° corriendo"
    log "VSCode corriendo: ‚úÖ"
    
    echo "   Enviando comando de actualizaci√≥n de tema..."
    if code --command "walTheme.update" > /dev/null 2>&1; then
        echo "‚úÖ Comando de actualizaci√≥n enviado correctamente"
        log "Comando actualizaci√≥n: ‚úÖ"
    else
        echo "‚ö†Ô∏è  Error al enviar comando de actualizaci√≥n"
        log "Comando actualizaci√≥n: ‚ö†Ô∏è"
    fi
else
    echo "‚ÑπÔ∏è  VSCode no est√° corriendo actualmente"
    log "VSCode corriendo: No"
    echo "   El tema se aplicar√° autom√°ticamente cuando se abra VSCode"
fi

# Resumen final
echo ""
echo "üìã Resumen:"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# Verificar estado general
all_good=true

# Verificar componentes cr√≠ticos
if ! command -v wal > /dev/null 2>&1; then
    all_good=false
fi

if ! command -v code > /dev/null 2>&1; then
    all_good=false
fi

if ! code --list-extensions | grep -q "dlasagno.wal-theme"; then
    all_good=false
fi

if [ "$all_good" = true ]; then
    echo "üéâ ¬°Integraci√≥n VSCode + pywal configurada correctamente!"
    echo ""
    echo "üìù Uso:"
    echo "   1. Presiona Super+Shift+W para abrir el selector de wallpaper"
    echo "   2. Selecciona una imagen"
    echo "   3. El tema de VSCode se actualizar√° autom√°ticamente"
    echo ""
    echo "üí° Consejos:"
    echo "   ‚Ä¢ Si VSCode est√° abierto, el tema se actualiza inmediatamente"
    echo "   ‚Ä¢ Si VSCode est√° cerrado, el tema se aplicar√° al abrirlo"
    echo "   ‚Ä¢ Puedes actualizar manualmente con Ctrl+Shift+P > 'Wal Theme: Update'"
    
    log "Estado final: ‚úÖ Todo configurado correctamente"
else
    echo "‚ö†Ô∏è  Hay algunos problemas que necesitan atenci√≥n"
    echo "   Revisa los elementos marcados con ‚ùå o ‚ö†Ô∏è  arriba"
    
    log "Estado final: ‚ö†Ô∏è Problemas detectados"
fi

echo ""
echo "üìä Para m√°s detalles, revisa el log: $LOG_FILE"

log "Prueba de integraci√≥n completada"
