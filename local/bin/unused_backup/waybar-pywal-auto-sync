#!/bin/bash

# Script para sincronizaci√≥n autom√°tica de waybar con pywal
# Se ejecuta despu√©s de que pywal genera nuevos colores

LOG_FILE="$HOME/.cache/waybar-pywal-sync.log"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

log "=== Iniciando sincronizaci√≥n waybar-pywal ==="

# Verificar que pywal haya generado los archivos
if [[ ! -f ~/.cache/wal/colors-pywal.css ]]; then
    log "ERROR: No se encontr√≥ ~/.cache/wal/colors-pywal.css"
    exit 1
fi

# Crear directorio de waybar si no existe
mkdir -p ~/.config/waybar

# Copiar colores de pywal a waybar
if cp ~/.cache/wal/colors-pywal.css ~/.config/waybar/colors-pywal.css; then
    log "‚úì Colores copiados a waybar"
else
    log "ERROR: No se pudieron copiar los colores"
    exit 1
fi

# Verificar si waybar est√° corriendo
if pgrep -x "waybar" > /dev/null; then
    log "Waybar est√° corriendo, reiniciando..."
    # Reiniciar waybar suavemente
    pkill -SIGUSR2 waybar 2>/dev/null || {
        log "Forzando reinicio de waybar..."
        pkill waybar
        sleep 0.5
        nohup waybar > /dev/null 2>&1 &
    }
else
    log "Waybar no est√° corriendo, iniciando..."
    nohup waybar > /dev/null 2>&1 &
fi

# Esperar un momento para que waybar se inicie
sleep 1

# Verificar que waybar se inici√≥ correctamente
if pgrep -x "waybar" > /dev/null; then
    log "‚úì Waybar sincronizado correctamente con pywal"
    notify-send "üé® Waybar Sincronizado" "Colores actualizados autom√°ticamente" -t 2000
else
    log "ERROR: Waybar no se pudo iniciar"
    notify-send "‚ùå Error Waybar" "No se pudo sincronizar con pywal" -u critical -t 3000
    exit 1
fi

log "=== Sincronizaci√≥n completada ==="
