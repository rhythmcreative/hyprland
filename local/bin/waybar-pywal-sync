#!/bin/bash

# Script optimizado para sincronizar waybar con pywal
# Evita reinicios mÃºltiples y asegura sincronizaciÃ³n correcta

# FunciÃ³n de logging
log() {
    echo "$(date '+%H:%M:%S') - $1" | tee -a /tmp/waybar-pywal-sync.log
}

# Verificar si pywal estÃ¡ instalado
if ! command -v wal &> /dev/null; then
    notify-send "âŒ Error" "pywal no estÃ¡ instalado" -u critical
    exit 1
fi

log "ðŸŽ¨ Iniciando sincronizaciÃ³n waybar-pywal..."

# Verificar si existen los archivos de colores de pywal
if [[ ! -f "$HOME/.cache/wal/colors.css" ]]; then
    log "âš ï¸ No se encontraron colores de pywal, aplicando wallpaper actual..."
    current_wallpaper=$(cat ~/.cache/current-wallpaper 2>/dev/null || echo "")
    if [[ -n "$current_wallpaper" && -f "$current_wallpaper" ]]; then
        wal -i "$current_wallpaper" -n
        sleep 1
    else
        log "âŒ No se pudo determinar wallpaper actual"
        exit 1
    fi
fi

# FunciÃ³n para recargar waybar de forma eficiente (SÃšPER OPTIMIZADA - CERO REINICIOS SI ES POSIBLE)
reload_waybar_safe() {
    local waybar_pids=$(pgrep -x waybar)
    local pid_count=0
    
    if [[ -n "$waybar_pids" ]]; then
        pid_count=$(echo "$waybar_pids" | wc -l)
    fi
    
    # Si waybar no estÃ¡ corriendo, iniciarlo
    if [[ -z "$waybar_pids" ]]; then
        log "ðŸš€ Iniciando waybar (no estaba corriendo)..."
        waybar > /dev/null 2>&1 &
        sleep 1
        return 0
    fi
    
    # Si hay mÃºltiples instancias, limpiar y reiniciar UNA SOLA VEZ
    if [[ $pid_count -gt 1 ]]; then
        log "ðŸ§¹ Detectadas $pid_count instancias de waybar, limpiando..."
        pkill -TERM waybar 2>/dev/null || true
        sleep 2
        # Verificar si se cerraron todas
        remaining=$(pgrep -x waybar || true)
        if [[ -n "$remaining" ]]; then
            pkill -9 waybar 2>/dev/null || true
            sleep 1
        fi
        waybar > /dev/null 2>&1 &
        sleep 1
        log "âœ… Waybar iniciado con instancia Ãºnica"
        return 0
    fi
    
    # INSTANCIA ÃšNICA: Intentar SOLO recarga de CSS sin reiniciar
    log "ðŸŽ¨ Recargando estilos de waybar (sin reinicio)..."
    
    # MÃ©todo 1: Recarga de CSS usando SIGUSR2
    if kill -USR2 $waybar_pids 2>/dev/null; then
        log "âœ… CSS de waybar recargado exitosamente (CERO reinicios)"
        sleep 1
        # Verificar que sigue corriendo
        if kill -0 $waybar_pids 2>/dev/null; then
            return 0
        fi
    fi
    
    # MÃ©todo 2: Si SIGUSR2 falla, usar SIGHUP para recarga completa
    log "ðŸ”„ Intentando recarga completa con SIGHUP..."
    if kill -HUP $waybar_pids 2>/dev/null; then
        sleep 1.5
        # Verificar que sigue corriendo despuÃ©s de SIGHUP
        if kill -0 $waybar_pids 2>/dev/null; then
            log "âœ… Waybar recargado con SIGHUP (sin reinicio de proceso)"
            return 0
        fi
    fi
    
    # ÃšLTIMO RECURSO: Solo si waybar se crasheÃ³, reiniciarlo UNA SOLA VEZ
    log "âš ï¸ Waybar se cerrÃ³ durante la recarga, reiniciando (Ãºltimo recurso)..."
    # Ya no estÃ¡ corriendo, solo iniciarlo
    waybar > /dev/null 2>&1 &
    sleep 1
    if pgrep -x waybar > /dev/null; then
        log "âœ… Waybar reiniciado exitosamente (1 vez Ãºnicamente)"
    else
        log "âŒ ERROR: No se pudo reiniciar waybar"
        return 1
    fi
}

# Actualizar SOLO los colores de waybar con pywal SIN modificar style.css
update_waybar_colors_only() {
    local waybar_config_dir="$HOME/.config/waybar"
    local wal_colors="$HOME/.cache/wal/colors.css"
    
    # Verificar que existan los archivos necesarios
    if [[ ! -f "$wal_colors" ]]; then
        log "âŒ Archivo de colores de pywal no encontrado"
        return 1
    fi
    
    # Leer colores de pywal
    source "$HOME/.cache/wal/colors.sh"
    
    # Crear/actualizar SOLO el archivo de colores para waybar (NO TOCAR style.css)
    cat > "$waybar_config_dir/colors-pywal.css" << EOF
/* Colores generados automÃ¡ticamente por pywal */
@define-color background ${background};
@define-color foreground ${foreground};
@define-color cursor ${cursor};
@define-color color0 ${color0};
@define-color color1 ${color1};
@define-color color2 ${color2};
@define-color color3 ${color3};
@define-color color4 ${color4};
@define-color color5 ${color5};
@define-color color6 ${color6};
@define-color color7 ${color7};
@define-color color8 ${color8};
@define-color color9 ${color9};
@define-color color10 ${color10};
@define-color color11 ${color11};
@define-color color12 ${color12};
@define-color color13 ${color13};
@define-color color14 ${color14};
@define-color color15 ${color15};
EOF
    
    log "âœ… Colores de waybar actualizados (style.css NO modificado)"
    
    # SOLO asegurar que style.css tenga el import si no lo tiene
    if [[ -f "$waybar_config_dir/style.css" ]]; then
        if ! grep -q "colors-pywal.css" "$waybar_config_dir/style.css"; then
            # AÃ±adir import al inicio del archivo SOLO si no existe
            sed -i '1i@import "colors-pywal.css";' "$waybar_config_dir/style.css"
            log "âœ… Import de colores aÃ±adido a tu style.css (resto sin modificar)"
        else
            log "âœ… Tu style.css ya tiene el import de colores, no se modifica nada mÃ¡s"
        fi
    fi
}

# Ejecutar actualizaciÃ³n de colores SOLAMENTE (sin tocar tu style.css)
update_waybar_colors_only

# Recargar waybar de forma segura
reload_waybar_safe

log "ðŸŽ‰ SincronizaciÃ³n completada"

# Sincronizar nm-applet automÃ¡ticamente
log "ðŸ”„ Sincronizando nm-applet con los nuevos colores..."
if [[ -f "$HOME/.local/bin/nm-applet-waybar-sync" ]]; then
    "$HOME/.local/bin/nm-applet-waybar-sync" 2>&1 | while read line; do
        log "nm-applet: $line"
    done
    log "âœ… nm-applet sincronizado automÃ¡ticamente"
else
    log "âš ï¸ Script de sincronizaciÃ³n nm-applet no encontrado"
fi

# Intentar enviar notificaciÃ³n, pero no fallar si no funciona
notify-send "ðŸŽ¨ Waybar + nm-applet Sync" "Colores sincronizados con pywal" -t 2000 2>/dev/null || true
