#!/bin/bash

# Script de gesti칩n del daemon pywal-gtk-auto
# Wrapper simple para comandos comunes del daemon

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Funciones de logging
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

show_help() {
    echo "游댢 Gesti칩n del Daemon PyWal-GTK-Auto"
    echo "====================================="
    echo ""
    echo "Uso: pywal-daemon <comando>"
    echo ""
    echo "Comandos disponibles:"
    echo "  start     - Iniciar el daemon"
    echo "  stop      - Detener el daemon"
    echo "  restart   - Reiniciar el daemon"
    echo "  status    - Ver estado del daemon"
    echo "  logs      - Ver logs en tiempo real"
    echo "  test      - Probar sincronizaci칩n"
    echo "  setup     - Configurar/reinstalar daemon"
    echo "  enable    - Habilitar inicio autom치tico"
    echo "  disable   - Deshabilitar inicio autom치tico"
    echo "  help      - Mostrar esta ayuda"
    echo ""
    echo "Ejemplos:"
    echo "  pywal-daemon start    # Iniciar el daemon"
    echo "  pywal-daemon logs     # Ver logs en tiempo real"
    echo "  pywal-daemon test     # Probar que funciona"
}

daemon_start() {
    log_info "Iniciando daemon..."
    if systemctl --user is-active --quiet pywal-gtk-daemon.service; then
        log_warning "El daemon ya est치 ejecut치ndose"
        return 0
    fi
    
    systemctl --user start pywal-gtk-daemon.service
    sleep 2
    
    if systemctl --user is-active --quiet pywal-gtk-daemon.service; then
        log_success "Daemon iniciado exitosamente"
    else
        log_error "Error al iniciar el daemon"
        return 1
    fi
}

daemon_stop() {
    log_info "Deteniendo daemon..."
    if ! systemctl --user is-active --quiet pywal-gtk-daemon.service; then
        log_warning "El daemon no est치 ejecut치ndose"
        return 0
    fi
    
    systemctl --user stop pywal-gtk-daemon.service
    log_success "Daemon detenido"
}

daemon_restart() {
    log_info "Reiniciando daemon..."
    systemctl --user restart pywal-gtk-daemon.service
    sleep 2
    
    if systemctl --user is-active --quiet pywal-gtk-daemon.service; then
        log_success "Daemon reiniciado exitosamente"
    else
        log_error "Error al reiniciar el daemon"
        return 1
    fi
}

daemon_status() {
    echo "游늵 Estado del Daemon PyWal-GTK-Auto"
    echo "====================================="
    
    if systemctl --user is-active --quiet pywal-gtk-daemon.service; then
        echo "游릭 Estado: Activo y ejecut치ndose"
    else
        echo "游댮 Estado: Detenido"
    fi
    
    echo ""
    echo "游늶 Informaci칩n detallada:"
    systemctl --user status pywal-gtk-daemon.service --no-pager -l
    
    echo ""
    echo "游닇 칔ltimas l칤neas del log:"
    if [ -f "$HOME/.cache/wal/daemon.log" ]; then
        tail -n 5 "$HOME/.cache/wal/daemon.log"
    else
        echo "Log no disponible"
    fi
}

daemon_logs() {
    echo "游닇 Logs del Daemon (presiona Ctrl+C para salir)"
    echo "==============================================="
    journalctl --user -u pywal-gtk-daemon.service -f --no-pager
}

daemon_test() {
    if command -v test-pywal-gtk-sync &> /dev/null; then
        test-pywal-gtk-sync
    else
        log_error "Script de prueba no encontrado"
        log_info "Ejecuta 'pywal-daemon setup' para instalarlo"
        return 1
    fi
}

daemon_setup() {
    if command -v setup-pywal-gtk-daemon &> /dev/null; then
        setup-pywal-gtk-daemon
    else
        log_error "Script de configuraci칩n no encontrado"
        return 1
    fi
}

daemon_enable() {
    log_info "Habilitando inicio autom치tico..."
    systemctl --user enable pywal-gtk-daemon.service
    log_success "Inicio autom치tico habilitado"
}

daemon_disable() {
    log_info "Deshabilitando inicio autom치tico..."
    systemctl --user disable pywal-gtk-daemon.service
    log_success "Inicio autom치tico deshabilitado"
}

main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    case "$1" in
        start)
            daemon_start
            ;;
        stop)
            daemon_stop
            ;;
        restart)
            daemon_restart
            ;;
        status)
            daemon_status
            ;;
        logs)
            daemon_logs
            ;;
        test)
            daemon_test
            ;;
        setup)
            daemon_setup
            ;;
        enable)
            daemon_enable
            ;;
        disable)
            daemon_disable
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Comando desconocido: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
