#!/bin/bash

# Script de verificaci√≥n para probar la sincronizaci√≥n de nm-applet
# Verifica que todos los componentes est√©n funcionando correctamente

echo "üîç === Verificaci√≥n de Sincronizaci√≥n nm-applet + Waybar ==="
echo ""

# Verificar si nm-applet est√° corriendo
echo "üì∂ Verificando nm-applet..."
if pgrep -x nm-applet > /dev/null; then
    echo "‚úÖ nm-applet est√° corriendo"
else
    echo "‚ùå nm-applet NO est√° corriendo"
fi

# Verificar si waybar est√° corriendo
echo "üì± Verificando waybar..."
if pgrep -x waybar > /dev/null; then
    echo "‚úÖ waybar est√° corriendo"
else
    echo "‚ùå waybar NO est√° corriendo"
fi

# Verificar archivos pywal
echo "üé® Verificando archivos pywal..."
if [[ -f "$HOME/.cache/wal/colors.sh" ]]; then
    echo "‚úÖ Colores pywal disponibles"
    source "$HOME/.cache/wal/colors.sh"
    echo "  Background: $background"
    echo "  Foreground: $foreground"
    echo "  Accent (color4): $color4"
else
    echo "‚ùå Archivos pywal NO encontrados"
fi

# Verificar CSS de nm-applet
echo "üé® Verificando CSS de nm-applet..."
if [[ -f "$HOME/.config/gtk-3.0/nm-applet-pywal.css" ]]; then
    echo "‚úÖ CSS de nm-applet (GTK3) existe"
    echo "  Modificado: $(stat -c %y "$HOME/.config/gtk-3.0/nm-applet-pywal.css")"
else
    echo "‚ùå CSS de nm-applet (GTK3) NO existe"
fi

if [[ -f "$HOME/.config/gtk-4.0/nm-applet-pywal.css" ]]; then
    echo "‚úÖ CSS de nm-applet (GTK4) existe"
else
    echo "‚ùå CSS de nm-applet (GTK4) NO existe"
fi

# Verificar scripts de sincronizaci√≥n
echo "üîß Verificando scripts..."
if [[ -x "$HOME/.local/bin/nm-applet-auto-sync" ]]; then
    echo "‚úÖ nm-applet-auto-sync ejecutable"
else
    echo "‚ùå nm-applet-auto-sync NO encontrado o no ejecutable"
fi

if [[ -x "$HOME/.local/bin/complete-wallpaper-sync" ]]; then
    echo "‚úÖ complete-wallpaper-sync ejecutable"
else
    echo "‚ùå complete-wallpaper-sync NO encontrado o no ejecutable"
fi

# Verificar configuraci√≥n GTK
echo "üéõÔ∏è Verificando configuraci√≥n GTK..."
if command -v gsettings &> /dev/null; then
    current_theme=$(gsettings get org.gnome.desktop.interface gtk-theme 2>/dev/null || echo "No configurado")
    echo "  Tema GTK actual: $current_theme"
    color_scheme=$(gsettings get org.gnome.desktop.interface color-scheme 2>/dev/null || echo "No configurado")
    echo "  Esquema de colores: $color_scheme"
else
    echo "‚ö†Ô∏è gsettings no disponible"
fi

echo ""
echo "üß™ === Prueba R√°pida de Sincronizaci√≥n ==="
echo "¬øDeseas probar la sincronizaci√≥n de nm-applet ahora? (y/n)"
read -r response

if [[ "$response" =~ ^[Yy]$ ]]; then
    echo "üöÄ Ejecutando sincronizaci√≥n de nm-applet..."
    if [[ -x "$HOME/.local/bin/nm-applet-auto-sync" ]]; then
        "$HOME/.local/bin/nm-applet-auto-sync" --force
        echo ""
        echo "‚úÖ Sincronizaci√≥n completada. Verifica nm-applet en el system tray."
    else
        echo "‚ùå Script de sincronizaci√≥n no disponible"
    fi
else
    echo "‚ÑπÔ∏è Prueba omitida"
fi

echo ""
echo "üìã === Resumen ==="
echo "Para sincronizar manualmente: Super + Shift + N"
echo "Para sincronizaci√≥n completa: Super + Shift + W" 
echo "Logs disponibles en: ~/.cache/nm-applet-auto-sync.log"
echo "Logs completos en: ~/.cache/complete-wallpaper-sync.log"
echo ""
