#!/bin/bash

# Script de sincronizaciÃ³n completa del sistema
# Sincroniza waybar, nm-applet y otros componentes

echo "ğŸŒˆ Iniciando sincronizaciÃ³n completa del sistema de colores..."

# First, update waybar colors if pywal colors have changed
echo "ğŸ¨ Actualizando colores de waybar..."
if [[ -f "$HOME/.local/bin/sync-waybar-pywal" ]]; then
    "$HOME/.local/bin/sync-waybar-pywal"
else
    # Solo si sync-waybar-pywal no existe, hacer un reinicio simple
    if pgrep -x waybar > /dev/null; then
        echo "ğŸ”„ Recargando waybar (fallback)..."
        pkill -USR2 waybar 2>/dev/null || {
            pkill waybar
            sleep 1
            waybar > /dev/null 2>&1 &
        }
    fi
fi

# Reload dunst with new pywal colors
echo "ğŸ”” Recargando dunst con nuevos colores..."
if [[ -f "$HOME/.config/dunst/scripts/reload-dunst.sh" ]]; then
    "$HOME/.config/dunst/scripts/reload-dunst.sh" &
    dunst_pid=$!
    # Esperar mÃ¡ximo 8 segundos para dunst
    if timeout 8 wait $dunst_pid 2>/dev/null; then
        echo "âœ… Dunst sincronizado exitosamente"
    else
        echo "âš ï¸ Dunst sync continuando en segundo plano..."
        disown $dunst_pid 2>/dev/null || true
    fi
elif [[ -f "$HOME/.config/wal/done.d/dunst-restart.sh" ]]; then
    "$HOME/.config/wal/done.d/dunst-restart.sh" &
    disown
    echo "âœ… Dunst recarga iniciada con script de pywal"
else
    # Fallback manual: reiniciar dunst directamente
    echo "ğŸ”” Recargando dunst manualmente..."
    pkill dunst 2>/dev/null || true
    sleep 1
    dunst >/dev/null 2>&1 &
    echo "âœ… Dunst recargado manualmente"
fi

# Sync nm-applet with waybar (en segundo plano)
echo "ğŸ“¶ Sincronizando nm-applet con waybar..."
if [[ -f "$HOME/.local/bin/nm-applet-waybar-sync" ]]; then
    "$HOME/.local/bin/nm-applet-waybar-sync" &
    disown
fi

# Send notification
if command -v notify-send > /dev/null; then
    notify-send "ğŸŒˆ SincronizaciÃ³n Completa" "Waybar + Dunst + nm-applet sincronizados con pywal" -t 3000 -i preferences-desktop-theme
fi

echo "ğŸ‰ SincronizaciÃ³n completa del sistema finalizada!"
