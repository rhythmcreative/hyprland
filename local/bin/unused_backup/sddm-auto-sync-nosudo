#!/bin/bash

# Script para sincronizaci√≥n autom√°tica de wallpaper en SDDM sin sudo
# Usa polkit (pkexec) para permisos o copia a directorio de usuario
# Autor: rhythmcreative

LOG_FILE="$HOME/.cache/sddm-auto-sync-nosudo.log"
USER_HOME="$HOME"
SDDM_SYSTEM_DIR="/usr/share/sddm/themes/sddm-astronaut-theme"
POLKIT_ACTION_FILE="/usr/share/polkit-1/actions/com.rhythmcreative.sddm-sync.policy"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Funci√≥n para mostrar notificaciones (silenciosa)
notify_user() {
    if [[ -n "$DISPLAY" ]] || [[ -n "$WAYLAND_DISPLAY" ]]; then
        notify-send "SDDM Auto-Sync" "$1" 2>/dev/null || true
    fi
}

get_current_wallpaper() {
    # Intentar obtener wallpaper desde pywal
    if [[ -f "$USER_HOME/.cache/wal/wal" ]]; then
        cat "$USER_HOME/.cache/wal/wal" 2>/dev/null
        return 0
    fi
    
    # Fallback: buscar en archivos de configuraci√≥n
    if [[ -f "$USER_HOME/.cache/current-wallpaper" ]]; then
        cat "$USER_HOME/.cache/current-wallpaper" 2>/dev/null
        return 0
    fi
    
    return 1
}

# Crear polkit policy para permisos autom√°ticos
create_polkit_policy() {
    local temp_policy="/tmp/sddm-sync.policy"
    
    cat > "$temp_policy" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE policyconfig PUBLIC
 "-//freedesktop//DTD PolicyKit Policy Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/PolicyKit/1.0/policyconfig.dtd">

<policyconfig>
    <action id="com.rhythmcreative.sddm-sync">
        <description>Sync SDDM wallpaper</description>
        <message>Synchronize SDDM theme wallpaper</message>
        <defaults>
            <allow_any>no</allow_any>
            <allow_inactive>no</allow_inactive>
            <allow_active>yes</allow_active>
        </defaults>
        <annotate key="org.freedesktop.policykit.exec.path">/bin/bash</annotate>
        <annotate key="org.freedesktop.policykit.exec.allow_gui">true</annotate>
    </action>
</policyconfig>
EOF

    # Intentar crear el policy (puede fallar sin permisos)
    if pkexec cp "$temp_policy" "$POLKIT_ACTION_FILE" 2>/dev/null; then
        log "‚úÖ Polkit policy creado exitosamente"
        rm -f "$temp_policy"
        return 0
    else
        log "‚ö†Ô∏è No se pudo crear polkit policy, continuando sin √©l"
        rm -f "$temp_policy"
        return 1
    fi
}

# Funci√≥n alternativa usando directorio de usuario
sync_wallpaper_user_method() {
    local wallpaper="$1"
    local filename=$(basename "$wallpaper")
    
    # Crear directorio local de SDDM si no existe
    local local_sddm_dir="$USER_HOME/.local/share/sddm-themes/sddm-astronaut-theme"
    mkdir -p "$local_sddm_dir/Backgrounds"
    
    # Copiar wallpaper al directorio local
    if cp "$wallpaper" "$local_sddm_dir/Backgrounds/$filename"; then
        log "‚úÖ Wallpaper copiado a directorio local: $filename"
        
        # Crear/actualizar configuraci√≥n local
        local config_file="$local_sddm_dir/theme.conf"
        cat > "$config_file" << EOF
[General]
Background="Backgrounds/$filename"
EOF
        
        log "‚úÖ Configuraci√≥n local actualizada"
        return 0
    else
        log "‚ùå Error al copiar wallpaper al directorio local"
        return 1
    fi
}

# Funci√≥n principal mejorada sin sudo
sync_wallpaper_automatic() {
    local wallpaper="$1"
    local filename=$(basename "$wallpaper")
    
    log "üîÑ Sincronizaci√≥n autom√°tica iniciada para: $filename"
    
    # M√©todo 1: Intentar con pkexec (sin di√°logos molestos)
    local temp_script="/tmp/sddm-sync-$$.sh"
    cat > "$temp_script" << EOF
#!/bin/bash
WALLPAPER_SRC="$wallpaper"
FILENAME="$filename"
SYSTEM_DEST="$SDDM_SYSTEM_DIR/Backgrounds/\$FILENAME"
CONFIG_FILE="$SDDM_SYSTEM_DIR/Themes/theme1.conf"

# Crear directorio si no existe
mkdir -p "$SDDM_SYSTEM_DIR/Backgrounds" 2>/dev/null

# Copiar wallpaper
if cp "\$WALLPAPER_SRC" "\$SYSTEM_DEST" 2>/dev/null; then
    chmod 644 "\$SYSTEM_DEST" 2>/dev/null
    
    # Actualizar configuraci√≥n
    if [[ -f "\$CONFIG_FILE" ]]; then
        sed -i "s|^Background=.*|Background=\"Backgrounds/\$FILENAME\"|g" "\$CONFIG_FILE" 2>/dev/null
    fi
    
    exit 0
else
    exit 1
fi
EOF
    
    chmod +x "$temp_script"
    
    # Intentar pkexec sin di√°logo (solo si est√° configurado)
    if pkexec --disable-internal-agent "$temp_script" 2>/dev/null; then
        log "‚úÖ Sincronizaci√≥n con sistema exitosa via pkexec"
        rm -f "$temp_script"
        return 0
    fi
    
    # M√©todo 2: Usar directorio de usuario como fallback
    log "‚ÑπÔ∏è pkexec fall√≥, usando m√©todo alternativo de directorio de usuario"
    rm -f "$temp_script"
    
    if sync_wallpaper_user_method "$wallpaper"; then
        log "‚úÖ Sincronizaci√≥n con directorio de usuario exitosa"
        return 0
    else
        log "‚ùå Todos los m√©todos fallaron"
        return 1
    fi
}

main() {
    log "üöÄ Iniciando sincronizaci√≥n autom√°tica sin sudo..."
    
    # Obtener wallpaper actual
    CURRENT_WALLPAPER=$(get_current_wallpaper)
    
    if [[ -z "$CURRENT_WALLPAPER" ]] || [[ ! -f "$CURRENT_WALLPAPER" ]]; then
        log "‚ùå No se pudo obtener el wallpaper actual"
        exit 1
    fi
    
    # Limpiar la ruta del wallpaper (quitar caracteres extra√±os)
    CURRENT_WALLPAPER=$(echo "$CURRENT_WALLPAPER" | tr -d '%' | head -n1)
    
    if [[ ! -f "$CURRENT_WALLPAPER" ]]; then
        log "‚ùå Archivo de wallpaper no existe despu√©s de limpiar ruta: $CURRENT_WALLPAPER"
        exit 1
    fi
    
    log "üì∏ Wallpaper detectado: $(basename "$CURRENT_WALLPAPER")"
    
    # Sincronizaci√≥n autom√°tica
    if sync_wallpaper_automatic "$CURRENT_WALLPAPER"; then
        log "üéâ Sincronizaci√≥n exitosa para: $(basename "$CURRENT_WALLPAPER")"
        notify_user "‚úÖ SDDM sincronizado: $(basename "$CURRENT_WALLPAPER")"
        exit 0
    else
        log "‚ùå Error en la sincronizaci√≥n"
        notify_user "‚ùå Error al sincronizar SDDM"
        exit 1
    fi
}

# Permitir wallpaper espec√≠fico como argumento
if [[ "$1" == "--wallpaper" ]] && [[ -n "$2" ]] && [[ -f "$2" ]]; then
    log "üñºÔ∏è Sincronizando con wallpaper espec√≠fico: $2"
    CURRENT_WALLPAPER="$2"
    sync_wallpaper_automatic "$CURRENT_WALLPAPER"
else
    main
fi
