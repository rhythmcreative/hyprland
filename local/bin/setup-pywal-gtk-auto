#!/bin/bash

# Script de configuraciÃ³n para PywalGTK-Auto
# Configura la sincronizaciÃ³n automÃ¡tica entre pywal y GTK

echo "ðŸš€ Configurando PywalGTK-Auto..."
echo ""

# Verificar dependencias
echo "ðŸ“‹ Verificando dependencias..."
MISSING_DEPS=()

if ! command -v wal >/dev/null 2>&1; then
    MISSING_DEPS+=("pywal")
fi

if ! command -v nwg-look >/dev/null 2>&1; then
    echo "âš ï¸  nwg-look no estÃ¡ instalado. Puedes instalarlo con: yay -S nwg-look"
fi

if [ ${#MISSING_DEPS[@]} -gt 0 ]; then
    echo "âŒ Faltan dependencias: ${MISSING_DEPS[*]}"
    echo "Por favor instala las dependencias faltantes y vuelve a ejecutar este script."
    exit 1
fi

echo "âœ… Todas las dependencias estÃ¡n instaladas"
echo ""

# Generar el tema inicial
echo "ðŸŽ¨ Generando tema inicial..."
if [ -f "$HOME/.cache/wal/colors.json" ]; then
    "$HOME/.local/bin/generate-pywal-gtk-theme"
else
    echo "âš ï¸  No se encontraron colores de pywal. Ejecutando pywal con un wallpaper por defecto..."
    # Buscar un wallpaper en directorios comunes
    WALLPAPER=""
    for dir in "$HOME/Pictures/Wallpapers" "$HOME/Pictures" "/usr/share/pixmaps" "/usr/share/wallpapers"; do
        if [ -d "$dir" ]; then
            WALLPAPER=$(find "$dir" -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | head -1)
            if [ -n "$WALLPAPER" ]; then
                break
            fi
        fi
    done
    
    if [ -n "$WALLPAPER" ]; then
        echo "Usando wallpaper: $WALLPAPER"
        wal -i "$WALLPAPER"
        "$HOME/.local/bin/generate-pywal-gtk-theme"
    else
        echo "âŒ No se encontrÃ³ ningÃºn wallpaper. Por favor ejecuta 'wal -i /ruta/a/tu/wallpaper.jpg' primero."
        exit 1
    fi
fi

echo ""

# Configurar el hook automÃ¡tico
echo "ðŸ”§ Configurando hook automÃ¡tico..."

# Verificar si ya existe un hook
HOOK_FILE="$HOME/.cache/wal/pywal-gtk-auto-hook.sh"
if [ -f "$HOOK_FILE" ]; then
    echo "âœ… Hook ya existe en $HOOK_FILE"
else
    echo "âŒ Hook no encontrado"
    exit 1
fi

# Configurar pywal para usar el hook
echo "ðŸ“ Configurando pywal para usar el hook..."

# Verificar configuraciÃ³n de pywal
PYWAL_CONFIG="$HOME/.config/wal/templates"
mkdir -p "$PYWAL_CONFIG"

# Crear configuraciÃ³n para que pywal ejecute el hook automÃ¡ticamente
cat > "$HOME/.config/wal/templates/done.sh" << 'EOF'
#!/bin/bash
# Este archivo se ejecuta automÃ¡ticamente despuÃ©s de que pywal genere los colores

# Ejecutar el hook de PywalGTK-Auto
if [ -x "$HOME/.cache/wal/pywal-gtk-auto-hook.sh" ]; then
    "$HOME/.cache/wal/pywal-gtk-auto-hook.sh"
fi

# Ejecutar otros hooks existentes
for hook in "$HOME/.cache/wal/"*-hook.sh; do
    if [ -f "$hook" ] && [ -x "$hook" ] && [ "$hook" != "$HOME/.cache/wal/pywal-gtk-auto-hook.sh" ]; then
        "$hook"
    fi
done
EOF

chmod +x "$HOME/.config/wal/templates/done.sh"

echo "âœ… Hook configurado correctamente"
echo ""

# Aplicar el tema
echo "ðŸŽ¯ Aplicando tema PywalGTK-Auto..."
gsettings set org.gnome.desktop.interface gtk-theme 'PywalGTK-Auto'
gsettings set org.gnome.desktop.wm.preferences theme 'PywalGTK-Auto'

# TambiÃ©n aplicarlo para aplicaciones flatpak
if command -v flatpak >/dev/null 2>&1; then
    flatpak --user override --env=GTK_THEME=PywalGTK-Auto 2>/dev/null || true
fi

echo "âœ… Tema aplicado"
echo ""

# InformaciÃ³n final
echo "ðŸŽ‰ Â¡PywalGTK-Auto configurado exitosamente!"
echo ""
echo "ðŸ“– InformaciÃ³n importante:"
echo "   â€¢ Tema creado: ~/.themes/PywalGTK-Auto"
echo "   â€¢ Generador: ~/.local/bin/generate-pywal-gtk-theme"
echo "   â€¢ Hook automÃ¡tico: ~/.cache/wal/pywal-gtk-auto-hook.sh"
echo ""
echo "ðŸ”„ Uso:"
echo "   â€¢ El tema se actualizarÃ¡ automÃ¡ticamente cada vez que uses pywal"
echo "   â€¢ Para cambiar wallpaper y colores: wal -i /ruta/a/imagen.jpg"
echo "   â€¢ Para regenerar manualmente: generate-pywal-gtk-theme"
echo "   â€¢ Para usar con nwg-look: selecciona 'PywalGTK-Auto' en la lista de temas"
echo ""
echo "âœ¨ Â¡Disfruta de tu tema GTK sincronizado con pywal!"
