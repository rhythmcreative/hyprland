#!/bin/bash

# Gesti√≥n de scripts de sincronizaci√≥n de Waybar
# Evita conflictos entre m√∫ltiples scripts

DAEMON_NAME="waybar-colors-sync"
LOG_FILE="/tmp/waybar-sync-manager.log"

# Funci√≥n de logging
log() {
    echo "$(date '+%H:%M:%S') [SYNC-MANAGER] - $1" | tee -a "$LOG_FILE"
}

# Funci√≥n para mostrar ayuda
show_help() {
    cat << EOF
Uso: waybar-sync-manager [OPCI√ìN]

OPCIONES:
  start      Inicia la gesti√≥n limpia de sincronizaci√≥n
  stop       Detiene todos los scripts de sincronizaci√≥n
  status     Muestra el estado actual
  fix        Ejecuta correcci√≥n inmediata de colores
  help       Muestra esta ayuda

EOF
}

# Funci√≥n para detener todos los scripts relacionados
stop_all_sync_scripts() {
    log "üõë Deteniendo todos los scripts de sincronizaci√≥n..."
    
    # Lista de scripts y daemons que pueden estar interfiriendo
    local scripts=(
        "waybar-pywal-sync"
        "waybar-master-sync"
        "waybar-colors-sync"
        "waybar-fix-wallpaper-sync"
        "waybar-pywal-universal-sync"
        "waybar-pywal-auto-sync"
    )
    
    for script in "${scripts[@]}"; do
        local pids=$(pgrep -f "$script" 2>/dev/null || true)
        if [[ -n "$pids" ]]; then
            log "‚ö° Deteniendo $script (PIDs: $pids)"
            echo "$pids" | xargs kill -TERM 2>/dev/null || true
            sleep 0.5
            # Si a√∫n siguen ejecut√°ndose, forzar
            local remaining=$(pgrep -f "$script" 2>/dev/null || true)
            if [[ -n "$remaining" ]]; then
                echo "$remaining" | xargs kill -KILL 2>/dev/null || true
            fi
        fi
    done
    
    # Limpiar archivos de lock
    rm -f /tmp/waybar_*.lock 2>/dev/null || true
    rm -f /tmp/waybar-*.lock 2>/dev/null || true
    
    log "‚úÖ Scripts de sincronizaci√≥n detenidos"
}

# Funci√≥n para mostrar estado actual
show_status() {
    log "üìä Estado actual de sincronizaci√≥n:"
    
    # Verificar waybar
    local waybar_pids=$(pgrep -x waybar 2>/dev/null || true)
    if [[ -n "$waybar_pids" ]]; then
        log "‚úÖ Waybar ejecut√°ndose (PID: $waybar_pids)"
    else
        log "‚ùå Waybar NO est√° ejecut√°ndose"
    fi
    
    # Verificar scripts activos
    local scripts=(
        "waybar-pywal-sync"
        "waybar-master-sync"
        "waybar-colors-sync"
    )
    
    for script in "${scripts[@]}"; do
        local pids=$(pgrep -f "$script" 2>/dev/null || true)
        if [[ -n "$pids" ]]; then
            log "üîÑ $script ejecut√°ndose (PID: $pids)"
        else
            log "‚èπÔ∏è $script detenido"
        fi
    done
    
    # Verificar archivos de colores
    if [[ -f "$HOME/.config/waybar/colors-pywal.css" ]]; then
        local color_timestamp=$(stat -c %Y "$HOME/.config/waybar/colors-pywal.css" 2>/dev/null || echo "0")
        local current_time=$(date +%s)
        local age=$((current_time - color_timestamp))
        log "üé® Archivo de colores: $(date -d @$color_timestamp '+%H:%M:%S') (hace ${age}s)"
    else
        log "‚ùå Archivo de colores no encontrado"
    fi
}

# Funci√≥n principal de gesti√≥n
start_clean_management() {
    log "üéØ Iniciando gesti√≥n limpia de sincronizaci√≥n..."
    
    # Detener scripts conflictivos
    stop_all_sync_scripts
    
    # Esperar estabilidad
    sleep 2
    
    # Ejecutar correcci√≥n inicial
    if [[ -x "$HOME/.local/bin/waybar-color-fix" ]]; then
        log "üîß Ejecutando correcci√≥n inicial..."
        "$HOME/.local/bin/waybar-color-fix"
    else
        log "‚ö†Ô∏è Script waybar-color-fix no encontrado"
    fi
    
    log "‚úÖ Gesti√≥n limpia iniciada"
}

# Procesamiento de argumentos
case "${1:-}" in
    "start")
        start_clean_management
        ;;
    "stop")
        stop_all_sync_scripts
        ;;
    "status")
        show_status
        ;;
    "fix")
        if [[ -x "$HOME/.local/bin/waybar-color-fix" ]]; then
            "$HOME/.local/bin/waybar-color-fix"
        else
            log "‚ùå Script waybar-color-fix no encontrado"
            exit 1
        fi
        ;;
    "help"|"--help"|"-h"|"")
        show_help
        ;;
    *)
        echo "Opci√≥n desconocida: $1"
        show_help
        exit 1
        ;;
esac
