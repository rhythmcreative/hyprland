#!/bin/bash

# Script de prueba para verificar la sincronizaciÃ³n automÃ¡tica nm-applet â†” waybar

echo "ğŸ§ª Prueba de sincronizaciÃ³n automÃ¡tica nm-applet â†” waybar"
echo "=================================================="
echo ""

# Verificar que el monitor estÃ© ejecutÃ¡ndose
if ! /home/rhythmcreative/.local/bin/nm-applet-monitor status > /dev/null; then
    echo "âŒ El monitor no estÃ¡ ejecutÃ¡ndose. Iniciando..."
    /home/rhythmcreative/.local/bin/nm-applet-monitor start
    echo ""
fi

# Mostrar colores actuales
echo "ğŸ¨ Colores actuales de waybar:"
if [ -f "$HOME/.config/waybar/colors-pywal.css" ]; then
    grep -E "(background|foreground|color4)" "$HOME/.config/waybar/colors-pywal.css" | head -3
else
    echo "  âš ï¸ Archivo de colores no encontrado"
fi
echo ""

# Buscar wallpapers disponibles
wallpapers_dir="$HOME/Pictures/Wallpapers"
if [ -d "$wallpapers_dir" ]; then
    wallpapers=($(find "$wallpapers_dir" -name "*.jpg" -o -name "*.png" | head -3))
    
    if [ ${#wallpapers[@]} -gt 0 ]; then
        echo "ğŸ“· Wallpapers disponibles para prueba:"
        for i in "${!wallpapers[@]}"; do
            echo "  $((i+1)). $(basename "${wallpapers[$i]}")"
        done
        echo ""
        
        echo "ğŸ”„ Cambiando wallpaper para probar sincronizaciÃ³n automÃ¡tica..."
        echo "   Usando: $(basename "${wallpapers[1]}")"
        
        # Usar sync-waybar-pywal que ya integra la sincronizaciÃ³n
        if [ -x "$HOME/.local/bin/sync-waybar-pywal" ]; then
            "$HOME/.local/bin/sync-waybar-pywal" "${wallpapers[1]}" --backend wal
        else
            echo "   Fallback: usando wal directamente..."
            wal -i "${wallpapers[1]}" > /dev/null 2>&1
        fi
        
        echo "âœ… Wallpaper cambiado"
        echo ""
        
        # Esperar un momento para que el monitor detecte los cambios
        echo "â³ Esperando a que el monitor detecte cambios..."
        sleep 5
        
        # Mostrar nuevos colores
        echo "ğŸ¨ Nuevos colores de waybar:"
        if [ -f "$HOME/.config/waybar/colors-pywal.css" ]; then
            grep -E "(background|foreground|color4)" "$HOME/.config/waybar/colors-pywal.css" | head -3
        fi
        echo ""
        
        # Verificar log del monitor
        echo "ğŸ“Š Actividad del monitor (Ãºltimas 5 lÃ­neas):"
        if [ -f "/tmp/nm-applet-monitor.log" ]; then
            tail -5 /tmp/nm-applet-monitor.log | sed 's/^/  /'
        else
            echo "  âš ï¸ Log del monitor no encontrado"
        fi
        echo ""
        
        # Verificar que nm-applet estÃ© ejecutÃ¡ndose
        if pgrep -x nm-applet > /dev/null; then
            echo "âœ… nm-applet estÃ¡ ejecutÃ¡ndose"
            echo "ğŸ‰ Â¡Prueba completada! nm-applet deberÃ­a tener ahora los mismos colores que waybar"
        else
            echo "âš ï¸ nm-applet no estÃ¡ ejecutÃ¡ndose - puede haberse reiniciado durante la sincronizaciÃ³n"
            echo "ğŸ’¡ Esto es normal, deberÃ­a iniciarse automÃ¡ticamente"
        fi
        
    else
        echo "âŒ No se encontraron wallpapers en $wallpapers_dir"
    fi
else
    echo "âŒ Directorio de wallpapers no encontrado: $wallpapers_dir"
fi

echo ""
echo "ğŸ’¡ Comandos Ãºtiles:"
echo "  Monitor: nm-applet-monitor {start|stop|status|restart}"
echo "  Sync manual: sync-nm-applet-waybar"
echo "  Cambiar wallpaper: sync-waybar-pywal [imagen]"
