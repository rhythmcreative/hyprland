#!/bin/bash

# Script para sincronizar wal-gtk-auto en Hyprland
# Se ejecuta con Super+Shift+W

set -e

# Funci√≥n para mostrar notificaciones
notify() {
    if command -v notify-send &> /dev/null; then
        notify-send "PyWal GTK" "$1" -i applications-graphics
    fi
}

# Funci√≥n para logging
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$HOME/.cache/wal/hyprland-sync.log"
}

main() {
    log "Iniciando sincronizaci√≥n manual en Hyprland..."
    
    # Verificar que existe pywal
    if ! command -v wal &> /dev/null; then
        notify "‚ùå Error: pywal no encontrado"
        log "ERROR: pywal no encontrado"
        exit 1
    fi
    
    # Verificar que existen colores
    if [ ! -f "$HOME/.cache/wal/colors.json" ]; then
        notify "‚ùå Error: No hay colores de pywal"
        log "ERROR: No se encontraron colores de pywal"
        exit 1
    fi
    
    # Verificar que existe el tema
    if [ ! -d "$HOME/.themes/wal-gtk-auto" ]; then
        notify "‚ùå Error: Tema wal-gtk-auto no encontrado"
        log "ERROR: Tema wal-gtk-auto no encontrado"
        exit 1
    fi
    
    # Ejecutar wal -R para asegurar que todo est√° actualizado
    log "Ejecutando wal -R..."
    notify "üîÑ Recargando colores pywal..."
    wal -R &> /dev/null
    
    # Esperar un poco para que pywal termine
    sleep 1
    
    # Actualizar el tema wal-gtk-auto
    if [ -x "$HOME/.local/bin/update-wal-gtk-auto" ]; then
        log "Actualizando tema wal-gtk-auto..."
        "$HOME/.local/bin/update-wal-gtk-auto" &> /dev/null
        log "Tema actualizado correctamente"
    else
        log "ERROR: update-wal-gtk-auto no encontrado o no ejecutable"
        notify "‚ùå Error: Script de actualizaci√≥n no encontrado"
        exit 1
    fi
    
    # Recargar tema GTK espec√≠fico para Hyprland
    log "Recargando tema GTK en Hyprland..."
    
    # M√©todo 1: Cambiar temporalmente el tema y volver
    if command -v gsettings &> /dev/null; then
        # Obtener tema actual
        current_theme=$(gsettings get org.gnome.desktop.interface gtk-theme | tr -d "'")
        
        # Si ya es wal-gtk-auto, cambiar temporalmente a Adwaita
        if [ "$current_theme" = "wal-gtk-auto" ]; then
            gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita'
            sleep 0.5
        fi
        
        # Establecer wal-gtk-auto
        gsettings set org.gnome.desktop.interface gtk-theme 'wal-gtk-auto'
        log "Tema GTK establecido via gsettings"
    fi
    
    # M√©todo 2: Limpiar caches GTK
    log "Limpiando caches GTK..."
    rm -rf "$HOME/.cache/gtk-3.0" "$HOME/.cache/gtk-4.0" 2>/dev/null || true
    
    # M√©todo 3: Actualizar cache de iconos
    if command -v gtk-update-icon-cache &> /dev/null; then
        gtk-update-icon-cache -f "$HOME/.themes/wal-gtk-auto" 2>/dev/null || true
        log "Cache de iconos actualizado"
    fi
    
    # M√©todo 4: Recargar configuraci√≥n de Hyprland (solo GTK, no toda la config)
    if command -v hyprctl &> /dev/null; then
        # Recargar solo variables de entorno GTK
        hyprctl setcursor "$(gsettings get org.gnome.desktop.interface cursor-theme | tr -d "'")" "$(gsettings get org.gnome.desktop.interface cursor-size)" 2>/dev/null || true
        log "Configuraci√≥n de cursor recargada en Hyprland"
    fi
    
    # M√©todo 5: Forzar recarga enviando se√±ales a aplicaciones GTK activas
    # Esto hace que las aplicaciones GTK detecten el cambio de tema
    if command -v pgrep &> /dev/null; then
        # Enviar SIGUSR1 a aplicaciones GTK comunes (si est√°n ejecut√°ndose)
        for app in nautilus thunar firefox thunderbird code; do
            pids=$(pgrep -x "$app" 2>/dev/null || true)
            if [ -n "$pids" ]; then
                echo "$pids" | while read -r pid; do
                    kill -USR1 "$pid" 2>/dev/null || true
                done
                log "Se√±al enviada a $app"
            fi
        done
    fi
    
    # M√©todo 6: Crear timestamp para forzar que las apps detecten cambios
    touch "$HOME/.themes/wal-gtk-auto/gtk-3.0/.timestamp"
    touch "$HOME/.themes/wal-gtk-auto/gtk-4.0/.timestamp"
    
    # Mostrar notificaci√≥n de √©xito
    notify "‚úÖ Tema wal-gtk-auto sincronizado"
    log "Sincronizaci√≥n completada exitosamente"
    
    # Opcional: mostrar colores actuales
    if [ -f "$HOME/.cache/wal/colors.sh" ]; then
        source "$HOME/.cache/wal/colors.sh"
        log "Colores actuales: bg=$background, fg=$foreground, accent=$color1"
    fi
}

# Ejecutar funci√≥n principal
main "$@"
