#!/bin/bash

# Script para cambiar wallpaper con pywal y sincronizar automÃ¡ticamente todos los temas
# Integrado con HyDE, Hyprland y Powerlevel10k

# Configuraciones
WALLPAPER_DIR="$HOME/wallpapers"
ALTERNATIVE_DIRS=("$HOME/Pictures/wallpapers" "$HOME/.local/share/wallpapers" "$HOME/Hyde/Source/assets/wallpapers")

# FunciÃ³n para mostrar ayuda
show_help() {
    echo "ğŸ¨ Cambiador de Wallpaper con PyWal"
    echo ""
    echo "Uso: $(basename "$0") [OPCIONES] [IMAGEN]"
    echo ""
    echo "Opciones:"
    echo "  -h, --help        Mostrar esta ayuda"
    echo "  -r, --random      Seleccionar wallpaper aleatorio"
    echo "  -s, --select      Mostrar selector interactivo"
    echo "  -d, --directory   Especificar directorio de wallpapers"
    echo ""
    echo "Ejemplos:"
    echo "  $(basename "$0") ~/Pictures/mi-wallpaper.jpg"
    echo "  $(basename "$0") --random"
    echo "  $(basename "$0") --select"
    echo ""
}

# FunciÃ³n para encontrar directorio de wallpapers
find_wallpaper_dir() {
    if [[ -d "$WALLPAPER_DIR" ]]; then
        echo "$WALLPAPER_DIR"
        return 0
    fi
    
    for dir in "${ALTERNATIVE_DIRS[@]}"; do
        if [[ -d "$dir" ]]; then
            echo "$dir"
            return 0
        fi
    done
    
    echo ""
    return 1
}

# FunciÃ³n para seleccionar wallpaper aleatorio
select_random_wallpaper() {
    local dir="$1"
    
    if [[ ! -d "$dir" ]]; then
        echo "âŒ Directorio no encontrado: $dir"
        return 1
    fi
    
    # Buscar imÃ¡genes comunes
    local wallpapers=($(find "$dir" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.bmp" \) 2>/dev/null))
    
    if [[ ${#wallpapers[@]} -eq 0 ]]; then
        echo "âŒ No se encontraron wallpapers en: $dir"
        return 1
    fi
    
    # Seleccionar uno aleatorio
    local random_wallpaper="${wallpapers[$RANDOM % ${#wallpapers[@]}]}"
    echo "$random_wallpaper"
}

# FunciÃ³n para selector interactivo con fzf (si estÃ¡ disponible)
select_interactive_wallpaper() {
    local dir="$1"
    
    if [[ ! -d "$dir" ]]; then
        echo "âŒ Directorio no encontrado: $dir"
        return 1
    fi
    
    if ! command -v fzf >/dev/null 2>&1; then
        echo "âŒ fzf no estÃ¡ instalado. Usando selector aleatorio..."
        select_random_wallpaper "$dir"
        return
    fi
    
    # Buscar imÃ¡genes y usar fzf para seleccionar
    local selected_wallpaper=$(find "$dir" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.bmp" \) 2>/dev/null | fzf --preview 'echo "ğŸ“ {}" && file {}' --height 60% --border --prompt "ğŸ¨ Selecciona un wallpaper: ")
    
    if [[ -n "$selected_wallpaper" ]]; then
        echo "$selected_wallpaper"
    else
        echo "âŒ No se seleccionÃ³ ningÃºn wallpaper"
        return 1
    fi
}

# FunciÃ³n principal para cambiar wallpaper
change_wallpaper() {
    local wallpaper="$1"
    
    if [[ ! -f "$wallpaper" ]]; then
        echo "âŒ Archivo no encontrado: $wallpaper"
        return 1
    fi
    
    echo "ğŸ¨ Cambiando wallpaper y generando esquema de colores..."
    echo "ğŸ“„ Wallpaper: $(basename "$wallpaper")"
    
    # Aplicar pywal
    wal -i "$wallpaper" -a 85
    
    if [[ $? -ne 0 ]]; then
        echo "âŒ Error al aplicar pywal"
        return 1
    fi
    
    echo "âœ… PyWal aplicado correctamente"
    
    # Aplicar wallpaper con swww (Hyprland)
    if command -v swww >/dev/null 2>&1; then
        echo "ğŸ–¼ï¸  Aplicando wallpaper con swww..."
        swww img "$wallpaper" --transition-type wipe --transition-duration 1
        
        if [[ $? -eq 0 ]]; then
            echo "âœ… Wallpaper aplicado con swww"
        else
            echo "âš ï¸  Error al aplicar wallpaper con swww, intentando con hyprctl..."
            hyprctl hyprpaper wallpaper "eDP-1,$wallpaper" 2>/dev/null || echo "âš ï¸  hyprctl no disponible"
        fi
    elif command -v hyprctl >/dev/null 2>&1; then
        echo "ğŸ–¼ï¸  Aplicando wallpaper con hyprctl..."
        hyprctl hyprpaper wallpaper "eDP-1,$wallpaper" 2>/dev/null || echo "âš ï¸  Error con hyprctl"
    else
        echo "âš ï¸  No se encontrÃ³ swww ni hyprctl, solo se aplicaron los colores"
    fi
    
    # Recargar configuraciones relacionadas
    echo "ğŸ”„ Recargando configuraciones..."
    
    # Recargar waybar si estÃ¡ corriendo
    if pgrep -x "waybar" >/dev/null; then
        echo "ğŸ“Š Recargando Waybar..."
        killall waybar
        waybar &>/dev/null & disown
    fi
    
    # Recargar dunst si estÃ¡ corriendo
    if pgrep -x "dunst" >/dev/null; then
        echo "ğŸ”” Recargando Dunst..."
        killall dunst
        dunst &>/dev/null & disown
    fi
    
    # Aplicar colores a terminal actual (si es posible)
    if [[ -n "$TMUX" ]]; then
        echo "ğŸ–¥ï¸  Aplicando colores a tmux..."
        tmux source-file ~/.tmux.conf 2>/dev/null || true
    fi
    
    echo ""
    echo "âœ¨ Â¡Cambio de tema completado!"
    echo "ğŸ¯ Wallpaper: $(basename "$wallpaper")"
    echo "ğŸ¨ Colores generados automÃ¡ticamente con pywal"
    echo "ğŸ“ Los colores de Powerlevel10k se actualizarÃ¡n en la prÃ³xima sesiÃ³n de terminal"
    echo "ğŸ’¡ Para aplicar inmediatamente: ejecuta 'source ~/.zshrc'"
}

# FunciÃ³n principal
main() {
    case "${1:-}" in
        -h|--help)
            show_help
            exit 0
            ;;
        -r|--random)
            local dir=$(find_wallpaper_dir)
            if [[ -z "$dir" ]]; then
                echo "âŒ No se encontrÃ³ ningÃºn directorio de wallpapers"
                echo "ğŸ’¡ Crea el directorio $WALLPAPER_DIR y coloca tus wallpapers ahÃ­"
                exit 1
            fi
            
            local wallpaper=$(select_random_wallpaper "$dir")
            if [[ -n "$wallpaper" ]]; then
                change_wallpaper "$wallpaper"
            else
                exit 1
            fi
            ;;
        -s|--select)
            local dir=$(find_wallpaper_dir)
            if [[ -z "$dir" ]]; then
                echo "âŒ No se encontrÃ³ ningÃºn directorio de wallpapers"
                echo "ğŸ’¡ Crea el directorio $WALLPAPER_DIR y coloca tus wallpapers ahÃ­"
                exit 1
            fi
            
            local wallpaper=$(select_interactive_wallpaper "$dir")
            if [[ -n "$wallpaper" ]]; then
                change_wallpaper "$wallpaper"
            else
                exit 1
            fi
            ;;
        -d|--directory)
            if [[ -z "$2" ]]; then
                echo "âŒ Debes especificar un directorio"
                show_help
                exit 1
            fi
            WALLPAPER_DIR="$2"
            local wallpaper=$(select_random_wallpaper "$WALLPAPER_DIR")
            if [[ -n "$wallpaper" ]]; then
                change_wallpaper "$wallpaper"
            else
                exit 1
            fi
            ;;
        "")
            # Sin argumentos, usar selector interactivo
            local dir=$(find_wallpaper_dir)
            if [[ -z "$dir" ]]; then
                echo "âŒ No se encontrÃ³ ningÃºn directorio de wallpapers"
                echo "ğŸ’¡ Crea el directorio $WALLPAPER_DIR y coloca tus wallpapers ahÃ­"
                exit 1
            fi
            
            local wallpaper=$(select_interactive_wallpaper "$dir")
            if [[ -n "$wallpaper" ]]; then
                change_wallpaper "$wallpaper"
            else
                exit 1
            fi
            ;;
        *)
            # Wallpaper especÃ­fico
            if [[ -f "$1" ]]; then
                change_wallpaper "$1"
            else
                echo "âŒ Archivo no encontrado: $1"
                show_help
                exit 1
            fi
            ;;
    esac
}

# Verificar dependencias bÃ¡sicas
if ! command -v wal >/dev/null 2>&1; then
    echo "âŒ PyWal no estÃ¡ instalado"
    echo "ğŸ’¡ Instala con: pip install pywal"
    exit 1
fi

# Ejecutar funciÃ³n principal
main "$@"
