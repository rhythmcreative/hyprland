#!/bin/bash

# Script para sincronizaci√≥n autom√°tica de wallpaper en SDDM (SIN SUDO)
# Autor: rhythmcreative
# Versi√≥n sin privilegios - usa enlaces simb√≥licos para evitar necesidad de sudo
# REQUIERE configuraci√≥n inicial con sudo, pero despu√©s funciona autom√°ticamente

LOG_FILE="/tmp/sddm-auto-sync-local-no-sudo.log"
USER_HOME="/home/rhythmcreative"
SDDM_THEME_DIR="$USER_HOME/.config/sddm-theme"
SDDM_SYSTEM_DIR="/usr/share/sddm/themes/sddm-astronaut-theme"
BG_SDDM_DIR="/home/rhythmcreative/BG-SDDM"

# Crear estructura de directorios locales
setup_local_dirs() {
    mkdir -p "$SDDM_THEME_DIR/Backgrounds"
    mkdir -p "$SDDM_THEME_DIR/Themes"
    mkdir -p "$SDDM_THEME_DIR/scripts"
    
    # Copiar configuraci√≥n base si existe y no tenemos una local
    if [[ -f "$SDDM_SYSTEM_DIR/Themes/theme1.conf" ]] && [[ ! -f "$SDDM_THEME_DIR/Themes/theme1.conf" ]]; then
        cp "$SDDM_SYSTEM_DIR/Themes/theme1.conf" "$SDDM_THEME_DIR/Themes/theme1.conf" 2>/dev/null || {
            # Si no podemos copiar, crear una configuraci√≥n b√°sica
            cat > "$SDDM_THEME_DIR/Themes/theme1.conf" <<'EOF'
[General]
#################### General ####################

# Configuraci√≥n autom√°tica de resoluci√≥n para m√∫ltiples monitores
# El tema se adapta din√°micamente seg√∫n los monitores detectados
ScreenWidth="auto"
ScreenHeight="auto"
Font="Open Sans"
KeyboardSize="0.4"
RoundCorners="20"
HourFormat="HH:mm"
DateFormat="dddd d MMMM"
HeaderText=""

#################### Background ####################

Background="Backgrounds/default.jpg"
DimBackground="0.3"
CropBackground="true"
BackgroundHorizontalAlignment="center"
BackgroundVerticalAlignment="center"

#################### Colors ####################

HighlightColor="#000000"
BackgroundColor="#000000"
TextColor="#ffffff"
PlaceholderColor="#bbbbbb"
SystemButtonsIconColor="#ffffff"
HighlightTextColor="#ffffff"
HoverSessionAndVirtualKeyboard="#333333"

#################### Form ####################

PartialBlur="no"
FullBlur="true"
BlurMax="64"
Blur="1.0"
HaveFormBackground="true"
FormPosition="center"
FormBackgroundColor="#000000"
FormBackgroundOpacity="0.6"

#################### Virtual Keyboard ####################

VirtualKeyboardPosition="center"

#################### Interface Behavior ####################

HideVirtualKeyboard="false"
HideSystemButtons="false"
HideLoginButton="true"
ForceLastUser="true"
PasswordFocus="true"
HideCompletePassword="true"
AllowEmptyPassword="false"
AllowUppercaseLettersInUsernames="false"
RightToLeftLayout="false"
EOF
        }
    fi
}

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Funci√≥n para mostrar notificaciones
notify_user() {
    if [[ -n "$DISPLAY" ]] || [[ -n "$WAYLAND_DISPLAY" ]]; then
        notify-send "SDDM Sync (No-Sudo)" "$1" 2>/dev/null || true
    fi
}

get_current_wallpaper() {
    # Intentar obtener wallpaper desde pywal
    if [[ -f "$USER_HOME/.cache/wal/wal" ]]; then
        cat "$USER_HOME/.cache/wal/wal" 2>/dev/null
        return 0
    fi
    
    # Fallback: buscar en archivos de configuraci√≥n de swww
    if [[ -f "$USER_HOME/.cache/current-wallpaper" ]]; then
        cat "$USER_HOME/.cache/current-wallpaper" 2>/dev/null
        return 0
    fi
    
    return 1
}

# Verificar si el sistema est√° configurado para symlinks
check_symlink_setup() {
    local system_backgrounds_dir="$SDDM_SYSTEM_DIR/Backgrounds"
    local system_config_file="$SDDM_SYSTEM_DIR/Themes/theme1.conf"
    local local_backgrounds_dir="$SDDM_THEME_DIR/Backgrounds"
    local local_config_file="$SDDM_THEME_DIR/Themes/theme1.conf"
    
    # Verificar si los enlaces simb√≥licos est√°n configurados
    if [[ -L "$system_backgrounds_dir" ]] && [[ "$(readlink "$system_backgrounds_dir")" == "$local_backgrounds_dir" ]]; then
        log "‚úÖ Enlace simb√≥lico de Backgrounds configurado correctamente"
        SYMLINKS_CONFIGURED=true
    else
        log "‚ö†Ô∏è Enlace simb√≥lico de Backgrounds NO configurado"
        SYMLINKS_CONFIGURED=false
    fi
    
    if [[ -L "$system_config_file" ]] && [[ "$(readlink "$system_config_file")" == "$local_config_file" ]]; then
        log "‚úÖ Enlace simb√≥lico de configuraci√≥n configurado correctamente"
        CONFIG_SYMLINK_CONFIGURED=true
    else
        log "‚ö†Ô∏è Enlace simb√≥lico de configuraci√≥n NO configurado"
        CONFIG_SYMLINK_CONFIGURED=false
    fi
}

# Crear script de configuraci√≥n inicial (se ejecuta una sola vez con sudo)
create_setup_script() {
    local setup_script="$SDDM_THEME_DIR/scripts/setup-symlinks.sh"
    
    cat > "$setup_script" <<EOF
#!/bin/bash
# Script de configuraci√≥n inicial para enlaces simb√≥licos SDDM (ejecutar UNA VEZ con sudo)

SDDM_SYSTEM_DIR="$SDDM_SYSTEM_DIR"
SDDM_THEME_DIR="$SDDM_THEME_DIR"

echo "üîß Configurando enlaces simb√≥licos para SDDM (se ejecuta una sola vez)"

# Hacer backup de archivos originales
if [[ -d "\$SDDM_SYSTEM_DIR/Backgrounds" ]] && [[ ! -L "\$SDDM_SYSTEM_DIR/Backgrounds" ]]; then
    echo "üìÅ Haciendo backup del directorio Backgrounds original..."
    mv "\$SDDM_SYSTEM_DIR/Backgrounds" "\$SDDM_SYSTEM_DIR/Backgrounds.backup.\$(date +%Y%m%d_%H%M%S)"
fi

if [[ -f "\$SDDM_SYSTEM_DIR/Themes/theme1.conf" ]] && [[ ! -L "\$SDDM_SYSTEM_DIR/Themes/theme1.conf" ]]; then
    echo "üìÅ Haciendo backup del archivo de configuraci√≥n original..."
    mv "\$SDDM_SYSTEM_DIR/Themes/theme1.conf" "\$SDDM_SYSTEM_DIR/Themes/theme1.conf.backup.\$(date +%Y%m%d_%H%M%S)"
fi

# Crear enlaces simb√≥licos
echo "üîó Creando enlace simb√≥lico para Backgrounds..."
ln -sf "\$SDDM_THEME_DIR/Backgrounds" "\$SDDM_SYSTEM_DIR/Backgrounds"

echo "üîó Creando enlace simb√≥lico para configuraci√≥n..."
ln -sf "\$SDDM_THEME_DIR/Themes/theme1.conf" "\$SDDM_SYSTEM_DIR/Themes/theme1.conf"

echo "‚úÖ Enlaces simb√≥licos configurados correctamente"
echo "üéâ Ahora el script principal funcionar√° sin sudo"
echo ""
echo "Para verificar:"
echo "  ls -la \$SDDM_SYSTEM_DIR/Backgrounds"
echo "  ls -la \$SDDM_SYSTEM_DIR/Themes/theme1.conf"
EOF

    chmod +x "$setup_script"
    log "üìã Script de configuraci√≥n creado: $setup_script"
}

# Funci√≥n principal de sincronizaci√≥n (sin sudo)
sync_wallpaper_no_sudo() {
    local wallpaper="$1"
    log "üì± Sincronizaci√≥n SDDM sin sudo..."
    
    setup_local_dirs
    
    # Copiar wallpaper al directorio local
    local filename=$(basename "$wallpaper")
    local dest_path="$SDDM_THEME_DIR/Backgrounds/$filename"
    
    if [[ ! -f "$dest_path" ]] || ! cmp -s "$wallpaper" "$dest_path" 2>/dev/null; then
        log "üìÅ Copiando wallpaper: $filename"
        if cp "$wallpaper" "$dest_path" 2>/dev/null; then
            chmod 644 "$dest_path" 2>/dev/null || true
            log "‚úÖ Wallpaper copiado a directorio local"
        else
            log "‚ùå Error al copiar wallpaper"
            return 1
        fi
    fi
    
    # Actualizar configuraci√≥n local
    local config_file="$SDDM_THEME_DIR/Themes/theme1.conf"
    if [[ -f "$config_file" ]]; then
        log "‚öôÔ∏è Actualizando configuraci√≥n local..."
        
        # Crear backup
        cp "$config_file" "$config_file.backup.$(date +%Y%m%d_%H%M%S)" 2>/dev/null || true
        
        # Actualizar configuraci√≥n local
        if sed -i "s|^Background=.*|Background=\"Backgrounds/$filename\"|g" "$config_file" 2>/dev/null; then
            log "‚úÖ Configuraci√≥n local actualizada para: $filename"
            
            # Si los symlinks est√°n configurados, los cambios se aplican autom√°ticamente
            if [[ "$SYMLINKS_CONFIGURED" == "true" ]] && [[ "$CONFIG_SYMLINK_CONFIGURED" == "true" ]]; then
                log "üéâ Cambios aplicados autom√°ticamente al sistema (via symlinks)"
                return 0
            else
                log "‚ö†Ô∏è Enlaces simb√≥licos no configurados, se requiere configuraci√≥n inicial"
                create_setup_script
                return 2  # C√≥digo especial para indicar que se necesita configuraci√≥n
            fi
        else
            log "‚ùå Error al actualizar configuraci√≥n local"
            return 1
        fi
    else
        log "‚ùå Archivo de configuraci√≥n no encontrado: $config_file"
        return 1
    fi
}

# Aplicar colores de pywal a configuraci√≥n local
sync_pywal_colors_local() {
    log "üé® Aplicando colores de pywal a configuraci√≥n local..."
    
    local colors_file="$USER_HOME/.cache/wal/colors"
    local config_file="$SDDM_THEME_DIR/Themes/theme1.conf"
    
    if [[ ! -f "$colors_file" ]]; then
        log "‚ö†Ô∏è Archivo de colores pywal no encontrado"
        return 1
    fi
    
    if [[ ! -f "$config_file" ]]; then
        log "‚ùå Archivo de configuraci√≥n local no encontrado"
        return 1
    fi
    
    # Leer colores
    local background=$(sed -n '1p' "$colors_file")
    local foreground=$(sed -n '8p' "$colors_file")
    local color1=$(sed -n '2p' "$colors_file")
    local color4=$(sed -n '5p' "$colors_file")
    local color5=$(sed -n '6p' "$colors_file")
    
    # Aplicar colores usando patrones m√°s espec√≠ficos del tema
    sed -i "s|^HighlightColor=.*|HighlightColor=\"$color1\"|g" "$config_file" 2>/dev/null || true
    sed -i "s|^BackgroundColor=.*|BackgroundColor=\"$background\"|g" "$config_file" 2>/dev/null || true
    sed -i "s|^TextColor=.*|TextColor=\"$foreground\"|g" "$config_file" 2>/dev/null || true
    sed -i "s|^SystemButtonsIconColor=.*|SystemButtonsIconColor=\"$foreground\"|g" "$config_file" 2>/dev/null || true
    sed -i "s|^HighlightTextColor=.*|HighlightTextColor=\"$foreground\"|g" "$config_file" 2>/dev/null || true
    sed -i "s|^FormBackgroundColor=.*|FormBackgroundColor=\"$background\"|g" "$config_file" 2>/dev/null || true
    
    log "üé® Colores pywal aplicados a configuraci√≥n local"
}

main() {
    log "üîê Iniciando sincronizaci√≥n autom√°tica de SDDM (modo sin sudo)..."
    
    # Verificar configuraci√≥n de symlinks
    check_symlink_setup
    
    # Obtener wallpaper actual
    CURRENT_WALLPAPER=$(get_current_wallpaper)
    
    if [[ -z "$CURRENT_WALLPAPER" ]] || [[ ! -f "$CURRENT_WALLPAPER" ]]; then
        log "‚ùå No se pudo obtener el wallpaper actual"
        notify_user "‚ùå No se pudo sincronizar: wallpaper no encontrado"
        exit 1
    fi
    
    log "üì∏ Wallpaper detectado: $(basename "$CURRENT_WALLPAPER")"
    
    # Sincronizar wallpaper (sin sudo)
    sync_result=$(sync_wallpaper_no_sudo "$CURRENT_WALLPAPER")
    sync_exit_code=$?
    
    case $sync_exit_code in
        0)
            # Aplicar colores de pywal si est√°n disponibles
            sync_pywal_colors_local
            
            log "üéâ Sincronizaci√≥n completada exitosamente (sin sudo)"
            notify_user "‚úÖ SDDM sincronizado autom√°ticamente con $(basename "$CURRENT_WALLPAPER")"
            echo "‚úÖ SDDM sincronizado autom√°ticamente"
            echo "üîÑ Los cambios estar√°n visibles en el pr√≥ximo logout/reinicio"
            ;;
        2)
            log "‚ö†Ô∏è Configuraci√≥n inicial requerida"
            notify_user "‚ö†Ô∏è Se requiere configuraci√≥n inicial √∫nica"
            echo "‚ö†Ô∏è CONFIGURACI√ìN INICIAL REQUERIDA"
            echo ""
            echo "Para habilitar la sincronizaci√≥n autom√°tica sin sudo, ejecuta UNA VEZ:"
            echo "  sudo $SDDM_THEME_DIR/scripts/setup-symlinks.sh"
            echo ""
            echo "Despu√©s de eso, este script funcionar√° autom√°ticamente sin sudo."
            ;;
        *)
            log "‚ùå Error en la sincronizaci√≥n"
            notify_user "‚ùå Error en sincronizaci√≥n"
            exit 1
            ;;
    esac
}

# Permitir argumentos espec√≠ficos
if [[ "$1" == "--wallpaper" ]] && [[ -n "$2" ]] && [[ -f "$2" ]]; then
    log "üñºÔ∏è Sincronizando con wallpaper espec√≠fico: $2"
    check_symlink_setup
    CURRENT_WALLPAPER="$2"
    sync_wallpaper_no_sudo "$CURRENT_WALLPAPER"
    sync_pywal_colors_local
elif [[ "$1" == "--setup" ]]; then
    # Crear directorio de configuraci√≥n y script de setup
    setup_local_dirs
    create_setup_script
    echo "üìã Script de configuraci√≥n creado en: $SDDM_THEME_DIR/scripts/setup-symlinks.sh"
    echo "Ejecuta: sudo $SDDM_THEME_DIR/scripts/setup-symlinks.sh"
elif [[ "$1" == "--status" ]]; then
    # Mostrar estado de configuraci√≥n
    check_symlink_setup
    echo "Estado de configuraci√≥n SDDM sin sudo:"
    echo "======================================"
    if [[ "$SYMLINKS_CONFIGURED" == "true" ]]; then
        echo "‚úÖ Enlaces de Backgrounds: Configurado"
    else
        echo "‚ùå Enlaces de Backgrounds: NO configurado"
    fi
    if [[ "$CONFIG_SYMLINK_CONFIGURED" == "true" ]]; then
        echo "‚úÖ Enlaces de configuraci√≥n: Configurado"
    else
        echo "‚ùå Enlaces de configuraci√≥n: NO configurado"
    fi
    echo ""
    if [[ "$SYMLINKS_CONFIGURED" == "true" ]] && [[ "$CONFIG_SYMLINK_CONFIGURED" == "true" ]]; then
        echo "üéâ Sistema completamente configurado - funcionar√° autom√°ticamente"
    else
        echo "‚ö†Ô∏è Ejecuta: $0 --setup  y sigue las instrucciones"
    fi
else
    main
fi
