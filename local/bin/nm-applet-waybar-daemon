#!/bin/bash

# Demonio de sincronizaci√≥n autom√°tica nm-applet ‚Üî waybar
# Este script monitoriza cambios en los colores de waybar y sincroniza nm-applet autom√°ticamente

DAEMON_NAME="nm-applet-waybar-daemon"
PIDFILE="/tmp/${DAEMON_NAME}.pid"
LOGFILE="/tmp/${DAEMON_NAME}.log"

# Funci√≥n de logging
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - [DAEMON] $1" >> "$LOGFILE"
}

# Verificar si el demonio ya est√° ejecut√°ndose
check_daemon() {
    if [ -f "$PIDFILE" ]; then
        local pid=$(cat "$PIDFILE")
        if kill -0 "$pid" 2>/dev/null; then
            return 0  # Demonio ejecut√°ndose
        else
            rm -f "$PIDFILE"  # PID file obsoleto
            return 1  # No ejecut√°ndose
        fi
    fi
    return 1  # No ejecut√°ndose
}

# Funci√≥n para iniciar el demonio
start_daemon() {
    if check_daemon; then
        echo "‚ùå El demonio ya est√° ejecut√°ndose (PID: $(cat "$PIDFILE"))"
        return 1
    fi
    
    echo "üöÄ Iniciando demonio de sincronizaci√≥n nm-applet ‚Üî waybar..."
    log "Iniciando demonio de sincronizaci√≥n"
    
    # Iniciar demonio en background
    (monitor_waybar_colors) &
    local daemon_pid=$!
    
    # Guardar PID
    echo "$daemon_pid" > "$PIDFILE"
    
    sleep 2
    
    if kill -0 "$daemon_pid" 2>/dev/null; then
        echo "‚úÖ Demonio iniciado correctamente (PID: $daemon_pid)"
        echo "üìÅ Log: $LOGFILE"
        return 0
    else
        echo "‚ùå Error al iniciar el demonio"
        rm -f "$PIDFILE"
        return 1
    fi
}

# Funci√≥n para detener el demonio
stop_daemon() {
    if ! check_daemon; then
        echo "‚ö†Ô∏è El demonio no est√° ejecut√°ndose"
        return 1
    fi
    
    local pid=$(cat "$PIDFILE")
    echo "üõë Deteniendo demonio (PID: $pid)..."
    log "Deteniendo demonio"
    
    # Intentar terminaci√≥n suave
    if kill -TERM "$pid" 2>/dev/null; then
        sleep 3
        
        # Verificar si se detuvo
        if ! kill -0 "$pid" 2>/dev/null; then
            rm -f "$PIDFILE"
            echo "‚úÖ Demonio detenido correctamente"
            return 0
        fi
        
        # Forzar terminaci√≥n si no se detuvo
        if kill -KILL "$pid" 2>/dev/null; then
            rm -f "$PIDFILE"
            echo "‚úÖ Demonio detenido forzadamente"
            return 0
        fi
    fi
    
    echo "‚ùå Error al detener el demonio"
    return 1
}

# Funci√≥n para monitorizar cambios en colores de waybar
monitor_waybar_colors() {
    # Escribir PID del proceso monitor
    echo $$ > "$PIDFILE"
    
    log "Monitor de colores iniciado"
    
    local colors_file="$HOME/.config/waybar/colors-pywal.css"
    local last_checksum=""
    local sync_script="$HOME/.local/bin/sync-nm-applet-waybar"
    
    # Verificar que el script de sincronizaci√≥n existe
    if [ ! -x "$sync_script" ]; then
        log "‚ùå Script de sincronizaci√≥n no encontrado: $sync_script"
        exit 1
    fi
    
    log "Monitorizando cambios en: $colors_file"
    
    # Loop principal de monitorizaci√≥n
    while true; do
        if [ -f "$colors_file" ]; then
            # Calcular checksum del archivo de colores
            local current_checksum=$(md5sum "$colors_file" 2>/dev/null | cut -d' ' -f1)
            
            # Si el checksum cambi√≥, sincronizar
            if [ "$current_checksum" != "$last_checksum" ] && [ -n "$current_checksum" ]; then
                if [ -n "$last_checksum" ]; then  # No ejecutar en la primera iteraci√≥n
                    log "üé® Detectados cambios en colores de waybar, sincronizando nm-applet..."
                    
                    # Ejecutar sincronizaci√≥n en background
                    "$sync_script" > /dev/null 2>&1 &
                    
                    log "‚úÖ Sincronizaci√≥n de nm-applet iniciada"
                fi
                
                last_checksum="$current_checksum"
            fi
        else
            log "‚ö†Ô∏è Archivo de colores no encontrado: $colors_file"
        fi
        
        # Esperar antes del siguiente chequeo
        sleep 5
    done
}

# Funci√≥n para mostrar estado
status_daemon() {
    if check_daemon; then
        local pid=$(cat "$PIDFILE")
        echo "‚úÖ Demonio ejecut√°ndose (PID: $pid)"
        
        # Mostrar informaci√≥n adicional
        if [ -f "$LOGFILE" ]; then
            echo "üìÅ Log: $LOGFILE"
            echo "üìä √öltimas l√≠neas del log:"
            tail -5 "$LOGFILE" 2>/dev/null || echo "  (Sin entradas en el log)"
        fi
        
        return 0
    else
        echo "‚ö†Ô∏è El demonio no est√° ejecut√°ndose"
        return 1
    fi
}

# Funci√≥n para reiniciar el demonio
restart_daemon() {
    echo "üîÑ Reiniciando demonio..."
    stop_daemon
    sleep 2
    start_daemon
}

# Funci√≥n para mostrar ayuda
show_help() {
    cat << EOF
üé® Demonio de Sincronizaci√≥n nm-applet ‚Üî waybar

Uso: $0 {start|stop|restart|status|help}

Comandos:
  start    - Iniciar el demonio de sincronizaci√≥n
  stop     - Detener el demonio
  restart  - Reiniciar el demonio
  status   - Mostrar estado actual del demonio  
  help     - Mostrar esta ayuda

Descripci√≥n:
Este demonio monitoriza autom√°ticamente los cambios en los colores de waybar
y sincroniza nm-applet para que use los mismos colores.

Archivos:
  PID:  $PIDFILE
  Log:  $LOGFILE
  Sync: $HOME/.local/bin/sync-nm-applet-waybar
EOF
}

# Funci√≥n principal
main() {
    case "${1:-}" in
        start)
            start_daemon
            ;;
        stop)
            stop_daemon
            ;;
        restart)
            restart_daemon
            ;;
        status)
            status_daemon
            ;;
        help|--help|-h)
            show_help
            ;;
        "")
            echo "‚ùå Comando requerido. Use '$0 help' para ver la ayuda."
            exit 1
            ;;
        *)
            echo "‚ùå Comando desconocido: $1"
            echo "üí° Use '$0 help' para ver los comandos disponibles."
            exit 1
            ;;
    esac
}

# Ejecutar funci√≥n principal con todos los argumentos
main "$@"
