#!/bin/bash
# Script para cambiar wallpaper y actualizar LibreWolf automÃ¡ticamente
# Uso: set-wallpaper [imagen] o set-wallpaper --random

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Banner
echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${PURPLE}â•‘               ğŸŒ„ Wallpaper & Theme Manager ğŸ¨               â•‘${NC}"
echo -e "${PURPLE}â•‘                 ActualizaciÃ³n automÃ¡tica                     â•‘${NC}"
echo -e "${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# FunciÃ³n para mostrar ayuda
show_help() {
    echo -e "${WHITE}Uso:${NC}"
    echo -e "${CYAN}  set-wallpaper [imagen]     ${WHITE}- Establecer wallpaper especÃ­fico${NC}"
    echo -e "${CYAN}  set-wallpaper --random     ${WHITE}- Wallpaper aleatorio del directorio${NC}"
    echo -e "${CYAN}  set-wallpaper --help       ${WHITE}- Mostrar esta ayuda${NC}"
    echo ""
    echo -e "${WHITE}Ejemplos:${NC}"
    echo -e "${CYAN}  set-wallpaper ~/Pictures/landscape.jpg${NC}"
    echo -e "${CYAN}  set-wallpaper --random${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Tip: Los colores del tema de LibreWolf se actualizarÃ¡n automÃ¡ticamente${NC}"
}

# FunciÃ³n para encontrar imÃ¡genes
find_wallpapers() {
    local dirs=(
        "$HOME/Pictures"
        "$HOME/Wallpapers" 
        "$HOME/backgrounds"
        "$HOME/.config/wallpapers"
        "/usr/share/pixmaps"
        "/usr/share/backgrounds"
    )
    
    local images=()
    
    for dir in "${dirs[@]}"; do
        if [ -d "$dir" ]; then
            while IFS= read -r -d '' file; do
                images+=("$file")
            done < <(find "$dir" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.bmp" -o -iname "*.webp" \) -print0 2>/dev/null)
        fi
    done
    
    printf '%s\n' "${images[@]}"
}

# FunciÃ³n para wallpaper aleatorio
set_random_wallpaper() {
    echo -e "${BLUE}ğŸ” Buscando wallpapers disponibles...${NC}"
    
    local wallpapers=($(find_wallpapers))
    
    if [ ${#wallpapers[@]} -eq 0 ]; then
        echo -e "${RED}âŒ No se encontraron wallpapers${NC}"
        echo -e "${YELLOW}ğŸ’¡ Coloca algunas imÃ¡genes en ~/Pictures o ~/Wallpapers${NC}"
        exit 1
    fi
    
    # Seleccionar wallpaper aleatorio
    local random_wallpaper="${wallpapers[$RANDOM % ${#wallpapers[@]}]}"
    
    echo -e "${GREEN}ğŸ² Wallpaper seleccionado: ${WHITE}$(basename "$random_wallpaper")${NC}"
    set_wallpaper "$random_wallpaper"
}

# FunciÃ³n principal para establecer wallpaper
set_wallpaper() {
    local image="$1"
    
    if [ ! -f "$image" ]; then
        echo -e "${RED}âŒ Error: El archivo '$image' no existe${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}ğŸ–¼ï¸  Estableciendo wallpaper: ${WHITE}$(basename "$image")${NC}"
    
    # Generar colores con pywal
    echo -e "${CYAN}ğŸ¨ Generando paleta de colores...${NC}"
    if wal -i "$image" -q; then
        echo -e "${GREEN}âœ… Colores generados exitosamente${NC}"
        
        # Actualizar tema de LibreWolf si estÃ¡ disponible
        if command -v update-librewolf-theme &> /dev/null; then
            echo -e "${CYAN}ğŸ¦Š Actualizando tema de LibreWolf...${NC}"
            update-librewolf-theme --auto
        fi
        
        # Establecer wallpaper usando feh si estÃ¡ disponible
        if command -v feh &> /dev/null; then
            feh --bg-fill "$image"
            echo -e "${GREEN}âœ… Wallpaper establecido con feh${NC}"
        elif command -v nitrogen &> /dev/null; then
            nitrogen --set-zoom-fill "$image"
            echo -e "${GREEN}âœ… Wallpaper establecido con nitrogen${NC}"
        elif command -v gsettings &> /dev/null; then
            gsettings set org.gnome.desktop.background picture-uri "file://$image"
            echo -e "${GREEN}âœ… Wallpaper establecido con gsettings${NC}"
        else
            echo -e "${YELLOW}âš ï¸  No se encontrÃ³ gestor de wallpapers (feh, nitrogen, gsettings)${NC}"
        fi
        
        # Mostrar informaciÃ³n de colores
        echo ""
        echo -e "${WHITE}ğŸ“Š InformaciÃ³n de la nueva paleta:${NC}"
        source ~/.cache/wal/colors.sh
        echo -e "${WHITE}   ğŸ¨ Fondo:      ${NC}${background}"
        echo -e "${WHITE}   âœ¨ Texto:      ${NC}${foreground}"
        echo -e "${WHITE}   ğŸŒŸ Acento:     ${NC}${color4}"
        echo -e "${WHITE}   ğŸ’« Secundario: ${NC}${color5}"
        
        echo ""
        echo -e "${GREEN}ğŸ‰ Â¡Cambio completado!${NC}"
        echo -e "${YELLOW}ğŸ“‹ Para ver los cambios:${NC}"
        echo -e "${WHITE}   â€¢ Reinicia LibreWolf para el nuevo tema${NC}"
        echo -e "${WHITE}   â€¢ Los colores de terminal se actualizaron automÃ¡ticamente${NC}"
        
    else
        echo -e "${RED}âŒ Error al generar colores con pywal${NC}"
        exit 1
    fi
}

# Verificar argumentos
case "$1" in
    --help|-h)
        show_help
        exit 0
        ;;
    --random|-r)
        set_random_wallpaper
        ;;
    "")
        echo -e "${YELLOW}âš ï¸  No se especificÃ³ ninguna imagen${NC}"
        echo ""
        show_help
        exit 1
        ;;
    *)
        set_wallpaper "$1"
        ;;
esac
