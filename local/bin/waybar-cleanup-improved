#!/bin/bash

# Script mejorado para limpiar instancias duplicadas de waybar
# y reiniciar con configuraci√≥n correcta

set -euo pipefail

LOG_FILE="$HOME/.cache/waybar-cleanup.log"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Funci√≥n de notificaci√≥n
notify() {
    notify-send "üßπ Waybar Cleanup" "$1" -t 2000 2>/dev/null || true
}

log "üßπ === INICIANDO LIMPIEZA DE WAYBAR ==="
notify "Limpiando waybar..."

# Contar instancias actuales
waybar_count=$(pgrep -x waybar | wc -l)
log "üîç Instancias de waybar detectadas: $waybar_count"

if [[ $waybar_count -eq 0 ]]; then
    log "‚ÑπÔ∏è No hay instancias de waybar ejecut√°ndose"
    log "üöÄ Iniciando waybar..."
    waybar > /dev/null 2>&1 &
    sleep 2
    log "‚úÖ Waybar iniciado"
    notify "‚úÖ Waybar iniciado"
    exit 0
fi

if [[ $waybar_count -eq 1 ]]; then
    # Verificar si waybar est√° funcionando correctamente
    log "‚ÑπÔ∏è Solo hay una instancia de waybar - verificando estado..."
    
    # Intentar verificar si waybar responde correctamente
    sleep 1
    
    if pgrep -x waybar > /dev/null; then
        log "‚úÖ Waybar funcionando correctamente - no se necesita limpieza"
        notify "‚úÖ Waybar OK"
        exit 0
    else
        log "‚ö†Ô∏è Waybar no responde - reiniciando..."
        pkill waybar 2>/dev/null || true
        sleep 1
        waybar > /dev/null 2>&1 &
        sleep 2
        log "‚úÖ Waybar reiniciado"
        notify "üîÑ Waybar reiniciado"
        exit 0
    fi
fi

# Si hay m√∫ltiples instancias, limpiar todas
log "‚ö†Ô∏è M√∫ltiples instancias detectadas ($waybar_count) - limpiando..."
notify "üßπ Limpiando m√∫ltiples instancias..."

# Obtener PIDs de waybar
waybar_pids=($(pgrep -x waybar))
log "üìã PIDs de waybar: ${waybar_pids[*]}"

# Cerrar todas las instancias suavemente
log "üõë Cerrando instancias con SIGTERM..."
for pid in "${waybar_pids[@]}"; do
    if kill -TERM "$pid" 2>/dev/null; then
        log "‚úÖ Enviado SIGTERM a PID $pid"
    else
        log "‚ö†Ô∏è No se pudo enviar SIGTERM a PID $pid"
    fi
done

# Esperar a que terminen
sleep 2

# Verificar si a√∫n hay instancias corriendo
remaining_pids=($(pgrep -x waybar 2>/dev/null || true))
if [[ ${#remaining_pids[@]} -gt 0 ]]; then
    log "‚ö†Ô∏è Algunas instancias siguen corriendo - forzando cierre..."
    for pid in "${remaining_pids[@]}"; do
        if kill -KILL "$pid" 2>/dev/null; then
            log "üîß Enviado SIGKILL a PID $pid"
        else
            log "‚ö†Ô∏è No se pudo enviar SIGKILL a PID $pid"
        fi
    done
    sleep 1
fi

# Verificaci√≥n final
final_count=$(pgrep -x waybar | wc -l)
if [[ $final_count -eq 0 ]]; then
    log "‚úÖ Todas las instancias de waybar cerradas exitosamente"
    
    # Esperar un momento antes de reiniciar
    sleep 1
    
    log "üöÄ Iniciando nueva instancia limpia de waybar..."
    waybar > /dev/null 2>&1 &
    new_pid=$!
    
    # Verificar que inici√≥ correctamente
    sleep 3
    
    if pgrep -x waybar > /dev/null; then
        log "‚úÖ Waybar reiniciado exitosamente (PID: $new_pid)"
        
        # Verificar workspaces despu√©s de un momento
        sleep 2
        if hyprctl workspaces | grep -q "workspace ID"; then
            log "‚úÖ M√≥dulo de workspaces funcionando correctamente"
            notify "‚úÖ Waybar limpiado y reiniciado"
        else
            log "‚ö†Ô∏è Advertencia: No se pudo verificar el estado de workspaces"
            notify "‚ö†Ô∏è Waybar reiniciado - verificar workspaces"
        fi
    else
        log "‚ùå Error: No se pudo reiniciar waybar"
        notify "‚ùå Error al reiniciar waybar"
        exit 1
    fi
else
    log "‚ùå Error: A√∫n hay $final_count instancias de waybar corriendo"
    notify "‚ùå Error en limpieza"
    exit 1
fi

log "üéâ === LIMPIEZA DE WAYBAR COMPLETADA ==="
exit 0
