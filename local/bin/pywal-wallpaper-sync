#!/bin/bash

# Script completo de sincronizaci√≥n de pywal con wallpaper
# Detecta autom√°ticamente el wallpaper actual y sincroniza todos los temas

WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
CURRENT_WALLPAPER_FILE="$HOME/.cache/current_wallpaper"

# Funci√≥n para obtener el wallpaper actual
get_current_wallpaper() {
    # Verificar si hay un archivo que guarde el wallpaper actual
    if [ -f "$CURRENT_WALLPAPER_FILE" ]; then
        cat "$CURRENT_WALLPAPER_FILE"
    else
        # Intentar detectar el wallpaper desde swww
        swww query 2>/dev/null | grep -o "image: .*" | cut -d' ' -f2- || echo ""
    fi
}

# Funci√≥n para aplicar pywal
apply_pywal() {
    local wallpaper="$1"
    
    if [ ! -f "$wallpaper" ]; then
        notify-send "üö´ Pywal Sync" "Wallpaper no encontrado: $wallpaper"
        return 1
    fi
    
    echo "üé® Aplicando pywal con: $(basename "$wallpaper")"
    
    # Aplicar pywal con configuraciones optimizadas
    wal -i "$wallpaper" -n -s -t
    
    # Esperar un momento para que los archivos se generen
    sleep 1
    
    # Verificar que los archivos de colores se generaron correctamente
    if [ ! -f ~/.cache/wal/colors.rasi ]; then
        notify-send "‚ö†Ô∏è Pywal" "Error generando colores para rofi"
        return 1
    fi

    # Generar tema GTK
    if [ -x "$HOME/.local/bin/generate-pywal-gtk-theme" ]; then
        echo "üé® Generando tema GTK..."
        "$HOME/.local/bin/generate-pywal-gtk-theme"
    fi
    
    return 0
}

# Funci√≥n para recargar componentes
reload_components() {
    echo "üîÑ Recargando componentes del sistema..."
    
    # Recargar Hyprland para aplicar nuevos colores
    hyprctl reload &>/dev/null
    
    # Recargar waybar si est√° corriendo
    if pgrep -x "waybar" > /dev/null; then
        pkill waybar
        sleep 0.5
        waybar &disown
    fi
    
    # Aplicar colores a aplicaciones existentes
    if command -v pywalfox &> /dev/null; then
        pywalfox update &>/dev/null &
    fi
    
    # Si existe, aplicar tema a Discord
    if [ -x "$HOME/.local/bin/wallpaper-with-discord" ]; then
        $HOME/.local/bin/apply-discord-theme &>/dev/null &
    fi
    
    echo "‚úÖ Componentes recargados"
}

# Funci√≥n principal
main() {
    echo "üé® Iniciando sincronizaci√≥n de pywal..."
    
    # Obtener wallpaper actual
    CURRENT_WALLPAPER=$(get_current_wallpaper)
    
    if [ -z "$CURRENT_WALLPAPER" ] || [ ! -f "$CURRENT_WALLPAPER" ]; then
        # Si no se puede detectar autom√°ticamente, usar el √∫ltimo wallpaper conocido
        if [ -f ~/.cache/wal/wal ]; then
            CURRENT_WALLPAPER=$(cat ~/.cache/wal/wal)
        else
            notify-send "üö´ Pywal Sync" "No se pudo detectar el wallpaper actual"
            echo "‚ùå Error: No se pudo detectar el wallpaper actual"
            exit 1
        fi
    fi
    
    echo "üñºÔ∏è Wallpaper detectado: $(basename "$CURRENT_WALLPAPER")"
    
    # Aplicar pywal
    if apply_pywal "$CURRENT_WALLPAPER"; then
        # Recargar componentes
        reload_components
        
        # Notificaci√≥n de √©xito
        notify-send "üé® Pywal Sincronizado" "Tema actualizado con: $(basename "$CURRENT_WALLPAPER")" -t 3000
        echo "‚úÖ Sincronizaci√≥n completada exitosamente"
    else
        notify-send "‚ùå Error Pywal" "No se pudo sincronizar el tema" -t 3000
        echo "‚ùå Error en la sincronizaci√≥n"
        exit 1
    fi
}

# Verificar dependencias
if ! command -v wal &> /dev/null; then
    notify-send "‚ùå Error" "pywal no est√° instalado"
    echo "‚ùå Error: pywal no est√° instalado"
    exit 1
fi

# Ejecutar funci√≥n principal
main "$@"
