#!/bin/bash

# GTK-PyWal Synchronization Script
# Sincroniza automÃ¡ticamente los temas GTK3/GTK4 con los colores de pywal

set -euo pipefail

LOG_FILE="$HOME/.cache/gtk-pywal-sync.log"
LOCK_FILE="/tmp/gtk-pywal-sync.lock"

# FunciÃ³n de logging con timestamp
log() {
    local message="[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    echo "$message" | tee -a "$LOG_FILE"
}

# FunciÃ³n de notificaciÃ³n
notify() {
    notify-send "ðŸŽ¨ GTK Theme Sync" "$1" -t 2000 2>/dev/null || true
}

# Verificar si ya estÃ¡ ejecutÃ¡ndose
if [[ -f "$LOCK_FILE" ]]; then
    lock_pid=$(cat "$LOCK_FILE" 2>/dev/null || echo "")
    if [[ -n "$lock_pid" ]] && kill -0 "$lock_pid" 2>/dev/null; then
        log "â³ SincronizaciÃ³n GTK ya en progreso (PID: $lock_pid)"
        exit 0
    fi
fi

# Crear lock
echo $$ > "$LOCK_FILE"

# FunciÃ³n de limpieza
cleanup() {
    rm -f "$LOCK_FILE"
}
trap cleanup EXIT INT TERM

log "ðŸŽ¨ === INICIANDO SINCRONIZACIÃ“N GTK-PYWAL ==="

# Verificar que pywal estÃ© instalado y haya generado colores
if ! command -v wal &> /dev/null; then
    log "âŒ ERROR: pywal no estÃ¡ instalado"
    notify "âŒ Error: pywal no encontrado"
    exit 1
fi

# Verificar archivos de colores de pywal
if [[ ! -f "$HOME/.cache/wal/colors.sh" ]]; then
    log "âŒ ERROR: Archivos de colores de pywal no encontrados"
    notify "âŒ Error: Colores de pywal no encontrados"
    exit 1
fi

# Cargar colores de pywal
source "$HOME/.cache/wal/colors.sh"

log "âœ… Colores de pywal cargados exitosamente"

# Verificar que las plantillas existan
GTK3_TEMPLATE="$HOME/.config/wal/templates/gtk3.css"
GTK4_TEMPLATE="$HOME/.config/wal/templates/gtk4.css"

if [[ ! -f "$GTK3_TEMPLATE" ]]; then
    log "âŒ ERROR: Plantilla GTK3 no encontrada: $GTK3_TEMPLATE"
    notify "âŒ Error: Plantilla GTK3 no encontrada"
    exit 1
fi

if [[ ! -f "$GTK4_TEMPLATE" ]]; then
    log "âŒ ERROR: Plantilla GTK4 no encontrada: $GTK4_TEMPLATE"
    notify "âŒ Error: Plantilla GTK4 no encontrada"
    exit 1
fi

# Crear directorios necesarios
mkdir -p "$HOME/.cache/wal"
mkdir -p "$HOME/.config/gtk-3.0"
mkdir -p "$HOME/.config/gtk-4.0"

log "ðŸ”„ PASO 1: Generando temas GTK dinÃ¡micos..."

# FunciÃ³n para procesar plantilla con colores de pywal
process_template() {
    local template_file="$1"
    local output_file="$2"
    
    log "ðŸ”§ Procesando: $template_file -> $output_file"
    
    # Leer plantilla y reemplazar variables
    local processed_content
    processed_content=$(sed \
        -e "s/{background}/$background/g" \
        -e "s/{foreground}/$foreground/g" \
        -e "s/{cursor}/$cursor/g" \
        -e "s/{color0}/$color0/g" \
        -e "s/{color1}/$color1/g" \
        -e "s/{color2}/$color2/g" \
        -e "s/{color3}/$color3/g" \
        -e "s/{color4}/$color4/g" \
        -e "s/{color5}/$color5/g" \
        -e "s/{color6}/$color6/g" \
        -e "s/{color7}/$color7/g" \
        -e "s/{color8}/$color8/g" \
        -e "s/{color9}/$color9/g" \
        -e "s/{color10}/$color10/g" \
        -e "s/{color11}/$color11/g" \
        -e "s/{color12}/$color12/g" \
        -e "s/{color13}/$color13/g" \
        -e "s/{color14}/$color14/g" \
        -e "s/{color15}/$color15/g" \
        "$template_file")
    
    # Escribir archivo procesado
    echo "$processed_content" > "$output_file"
    
    if [[ -f "$output_file" ]]; then
        log "âœ… Tema generado: $output_file"
        return 0
    else
        log "âŒ Error generando: $output_file"
        return 1
    fi
}

# Generar GTK3 theme
if process_template "$GTK3_TEMPLATE" "$HOME/.cache/wal/gtk3.css"; then
    log "âœ… Tema GTK3 generado exitosamente"
else
    log "âŒ Error generando tema GTK3"
    exit 1
fi

# Generar GTK4 theme
if process_template "$GTK4_TEMPLATE" "$HOME/.cache/wal/gtk4.css"; then
    log "âœ… Tema GTK4 generado exitosamente"
else
    log "âŒ Error generando tema GTK4"
    exit 1
fi

log "ðŸ”„ PASO 2: Aplicando configuraciÃ³n GTK..."

# FunciÃ³n para actualizar configuraciÃ³n GTK
update_gtk_config() {
    local version="$1"
    local config_file="$HOME/.config/gtk-${version}.0/settings.ini"
    
    log "ðŸ”§ Actualizando configuraciÃ³n GTK${version}: $config_file"
    
    # Backup del archivo original
    if [[ -f "$config_file" ]]; then
        cp "$config_file" "$config_file.backup"
    fi
    
    # Crear configuraciÃ³n actualizada
    cat > "$config_file" << EOF
[Settings]
gtk-theme-name=Adwaita
gtk-icon-theme-name=Tela-circle
gtk-font-name=Adwaita Sans 11
gtk-cursor-theme-name=Bibata-Modern-Classic
gtk-cursor-theme-size=24
gtk-toolbar-style=GTK_TOOLBAR_ICONS
gtk-toolbar-icon-size=GTK_ICON_SIZE_LARGE_TOOLBAR
gtk-button-images=0
gtk-menu-images=0
gtk-enable-event-sounds=1
gtk-enable-input-feedback-sounds=0
gtk-xft-antialias=1
gtk-xft-hinting=1
gtk-xft-hintstyle=hintslight
gtk-xft-rgba=rgb
gtk-application-prefer-dark-theme=1
# PyWal integration enabled
EOF
    
    log "âœ… ConfiguraciÃ³n GTK${version} actualizada"
}

# Actualizar configuraciones
update_gtk_config 3
update_gtk_config 4

log "ðŸ”„ PASO 3: Aplicando cambios al sistema..."

# Recargar configuraciÃ³n GTK
if command -v gsettings &> /dev/null; then
    log "ðŸ”§ Aplicando configuraciones con gsettings..."
    
    # Configurar tema GTK
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita" 2>/dev/null || true
    gsettings set org.gnome.desktop.interface icon-theme "Tela-circle" 2>/dev/null || true
    gsettings set org.gnome.desktop.interface cursor-theme "Bibata-Modern-Classic" 2>/dev/null || true
    gsettings set org.gnome.desktop.interface cursor-size 24 2>/dev/null || true
    
    # Configurar tema oscuro
    gsettings set org.gnome.desktop.interface color-scheme "prefer-dark" 2>/dev/null || true
    
    log "âœ… Configuraciones gsettings aplicadas"
else
    log "âš ï¸ gsettings no disponible, omitiendo configuraciÃ³n automÃ¡tica"
fi

# Exportar variables de entorno para aplicaciones actuales
export GTK_THEME="Adwaita:dark"
export GTK2_RC_FILES="$HOME/.gtkrc-2.0"

log "ðŸ”„ PASO 4: Sincronizando con aplicaciones del sistema..."

# FunciÃ³n para reiniciar aplicaciones GTK si estÃ¡n ejecutÃ¡ndose
restart_gtk_apps() {
    local apps=("nm-applet" "blueman-applet" "pa-applet" "volumeicon")
    
    for app in "${apps[@]}"; do
        if pgrep -x "$app" > /dev/null; then
            log "ðŸ”„ Reiniciando $app para aplicar nuevos colores..."
            
            # Cerrar aplicaciÃ³n
            pkill -TERM "$app" 2>/dev/null || true
            sleep 1
            
            # Si sigue ejecutÃ¡ndose, forzar cierre
            if pgrep -x "$app" > /dev/null; then
                pkill -KILL "$app" 2>/dev/null || true
                sleep 0.5
            fi
            
            # Reiniciar aplicaciÃ³n
            case "$app" in
                "nm-applet")
                    nm-applet --indicator > /dev/null 2>&1 &
                    log "âœ… nm-applet reiniciado"
                    ;;
                "blueman-applet")
                    blueman-applet > /dev/null 2>&1 &
                    log "âœ… blueman-applet reiniciado"
                    ;;
                "pa-applet")
                    pa-applet > /dev/null 2>&1 &
                    log "âœ… pa-applet reiniciado"
                    ;;
                "volumeicon")
                    volumeicon > /dev/null 2>&1 &
                    log "âœ… volumeicon reiniciado"
                    ;;
            esac
        fi
    done
}

# Reiniciar aplicaciones de sistema
restart_gtk_apps

log "ðŸ”„ PASO 5: Verificando integraciÃ³n con waybar..."

# Verificar que waybar estÃ© usando los colores correctos
if pgrep -x waybar > /dev/null; then
    log "ðŸ“± Waybar detectado - colores GTK sincronizados automÃ¡ticamente"
    
    # Opcional: SeÃ±al a waybar para recargar estilos
    pkill -SIGUSR2 waybar 2>/dev/null || true
    
    log "âœ… Waybar sincronizado con nuevos colores GTK"
else
    log "âš ï¸ Waybar no estÃ¡ ejecutÃ¡ndose"
fi

# Crear archivo de estado para indicar que la sincronizaciÃ³n fue exitosa
echo "$(date): GTK sync completed successfully" > "$HOME/.cache/gtk-pywal-sync-status"

log "âœ… === SINCRONIZACIÃ“N GTK-PYWAL COMPLETADA ==="
log "ðŸŽ¨ Temas GTK3/GTK4 sincronizados con pywal"
log "ðŸ“± nm-applet y aplicaciones del sistema actualizadas"
log "ðŸŒˆ Waybar integrado con nuevos colores"

notify "ðŸŽ¨ Â¡Temas GTK sincronizados exitosamente con pywal!"

exit 0
