#!/bin/bash

# nm-applet pywal watcher - Detecta cambios en colores de pywal inmediatamente
# Usa inotify para respuesta instant√°nea

COLORS_FILE="$HOME/.cache/wal/colors.sh"
COLORS_DIR="$HOME/.cache/wal"
LOGFILE="$HOME/.cache/nm-applet-logs/watcher.log"

# Crear directorio de logs
mkdir -p "$(dirname "$LOGFILE")"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] WATCHER: $1" | tee -a "$LOGFILE"
}

# Funci√≥n para verificar dependencias
check_dependencies() {
    if ! command -v inotifywait >/dev/null 2>&1; then
        log "‚ùå ERROR: inotifywait no est√° instalado"
        log "Instala con: sudo pacman -S inotify-tools"
        exit 1
    fi
    
    if [[ ! -d "$COLORS_DIR" ]]; then
        log "‚ö†Ô∏è Directorio de pywal no existe, cre√°ndolo..."
        mkdir -p "$COLORS_DIR"
    fi
}

# Funci√≥n para ejecutar sincronizaci√≥n
trigger_sync() {
    local event_type="$1"
    log "üé® Detectado cambio en pywal ($event_type) - Ejecutando sincronizaci√≥n..."
    
    # Esperar un momento para que pywal termine de escribir todos los archivos
    sleep 0.5
    
    # Verificar que el archivo de colores existe y no est√° vac√≠o
    if [[ -f "$COLORS_FILE" && -s "$COLORS_FILE" ]]; then
        # Ejecutar el script de CSS inmediatamente
        if [[ -f "$HOME/.local/bin/nm-applet-css-only" ]]; then
            log "üîÑ Ejecutando sincronizaci√≥n CSS..."
            "$HOME/.local/bin/nm-applet-css-only" >> "$LOGFILE" 2>&1
            
            if [[ $? -eq 0 ]]; then
                log "‚úÖ Sincronizaci√≥n completada exitosamente"
                
                # Opcional: notificar al usuario
                if command -v notify-send >/dev/null 2>&1; then
                    notify-send "üé® nm-applet" "Colores sincronizados con pywal" -t 2000 2>/dev/null || true
                fi
            else
                log "‚ùå Error en la sincronizaci√≥n"
            fi
        else
            log "‚ùå Script de sincronizaci√≥n CSS no encontrado"
        fi
    else
        log "‚ö†Ô∏è Archivo de colores no v√°lido, omitiendo sincronizaci√≥n"
    fi
}

# Funci√≥n para manejar se√±ales de terminaci√≥n
cleanup() {
    log "üîÑ Recibida se√±al de terminaci√≥n, cerrando watcher..."
    exit 0
}

# Funci√≥n principal del watcher
main() {
    log "üöÄ === INICIANDO WATCHER DE PYWAL PARA NM-APPLET ==="
    
    # Verificar dependencias
    check_dependencies
    
    # Registrar manejador de se√±ales
    trap cleanup SIGTERM SIGINT SIGQUIT
    
    log "üëÄ Monitoreando cambios en: $COLORS_DIR"
    log "üìÅ Archivo principal: $COLORS_FILE"
    
    # Ejecutar sincronizaci√≥n inicial si ya existen colores
    if [[ -f "$COLORS_FILE" && -s "$COLORS_FILE" ]]; then
        log "üé® Ejecutando sincronizaci√≥n inicial..."
        trigger_sync "inicial"
    fi
    
    # Monitor principal con inotifywait
    # Monitoreamos tanto el directorio como el archivo espec√≠fico para m√°xima cobertura
    while true; do
        log "üëÅÔ∏è Esperando cambios en colores de pywal..."
        
        # Usar inotifywait para detectar cambios inmediatamente
        # Monitorear tanto el archivo colors.sh como todo el directorio wal
        inotifywait -e modify,create,moved_to \
                   --format '%w%f %e' \
                   "$COLORS_DIR" \
                   2>/dev/null | while read file event; do
            
            # Solo procesar si es el archivo de colores o archivos relacionados
            if [[ "$file" =~ colors\.sh$ ]] || [[ "$file" =~ colors$ ]] || [[ "$file" =~ sequences$ ]]; then
                log "üìù Detectado cambio: $file ($event)"
                trigger_sync "$event"
                
                # Peque√±a pausa para evitar m√∫ltiples triggers muy r√°pidos
                sleep 1
            fi
        done
        
        # Si inotifywait falla, esperar un poco antes de reintentar
        log "‚ö†Ô∏è inotifywait termin√≥ inesperadamente, reiniciando en 3 segundos..."
        sleep 3
    done
}

# Mostrar ayuda
if [[ "$1" == "help" || "$1" == "--help" || "$1" == "-h" ]]; then
    cat << EOF
Uso: $0

Watcher que detecta cambios en colores de pywal instant√°neamente usando inotify.

FUNCIONALIDAD:
- Monitorea $COLORS_DIR usando inotifywait
- Detecta cambios en colors.sh inmediatamente
- Ejecuta sincronizaci√≥n autom√°tica de nm-applet CSS
- Mantiene logs en $LOGFILE

DEPENDENCIAS:
- inotify-tools (pacman -S inotify-tools)
- nm-applet-css-only script

ARCHIVOS MONITOREADOS:
- $COLORS_FILE
- $COLORS_DIR (directorio completo)

EOF
    exit 0
fi

# Ejecutar funci√≥n principal
main
