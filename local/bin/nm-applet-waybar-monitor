#!/bin/bash

# Monitor autom√°tico para mantener nm-applet sincronizado con waybar
# Se ejecuta en background y detecta cambios de colores

CACHE_FILE="$HOME/.cache/nm-applet-waybar-sync.cache"
COLORS_FILE="$HOME/.cache/wal/colors.sh"

echo "üîÑ Iniciando monitor de sincronizaci√≥n nm-applet ‚Üî Waybar..."

# Funci√≥n para obtener hash de colores actuales
get_colors_hash() {
    if [[ -f "$COLORS_FILE" ]]; then
        md5sum "$COLORS_FILE" | cut -d' ' -f1
    else
        echo "no-colors"
    fi
}

# Funci√≥n para sincronizar colores
sync_colors() {
    echo "üé® Detectado cambio de colores, sincronizando..."
    
    # Ejecutar script de sincronizaci√≥n
    if [[ -f "$HOME/.local/bin/fix-nm-applet-waybar-sync" ]]; then
        # Ejecutar en background sin input interactivo
        echo "n" | "$HOME/.local/bin/fix-nm-applet-waybar-sync" > /dev/null 2>&1
        
        # Guardar nuevo hash
        get_colors_hash > "$CACHE_FILE"
        
        echo "‚úÖ Sincronizaci√≥n autom√°tica completada"
        
        # Notificaci√≥n opcional
        if command -v notify-send > /dev/null; then
            notify-send "üé® Auto-Sync" "nm-applet sincronizado con waybar" -t 2000 2>/dev/null || true
        fi
    else
        echo "‚ùå Script de sincronizaci√≥n no encontrado"
    fi
}

# Inicializar cache si no existe
if [[ ! -f "$CACHE_FILE" ]]; then
    get_colors_hash > "$CACHE_FILE"
    echo "üìã Cache inicializado"
fi

echo "üëÅÔ∏è Monitoreando cambios de colores... (Ctrl+C para detener)"

# Loop de monitoreo
while true; do
    current_hash=$(get_colors_hash)
    cached_hash=$(cat "$CACHE_FILE" 2>/dev/null || echo "")
    
    if [[ "$current_hash" != "$cached_hash" ]] && [[ "$current_hash" != "no-colors" ]]; then
        sync_colors
    fi
    
    # Verificar que nm-applet est√© corriendo
    if ! pgrep -x nm-applet > /dev/null; then
        echo "üîÑ nm-applet no est√° corriendo, reiniciando..."
        nohup nm-applet > /dev/null 2>&1 &
        sleep 2
    fi
    
    # Esperar 5 segundos antes de la siguiente verificaci√≥n
    sleep 5
done
