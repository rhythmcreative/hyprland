#!/bin/bash

# Script de prueba para verificar el funcionamiento de wallpaper + waybar + pywal

echo "üß™ Iniciando prueba de sincronizaci√≥n Wallpaper + Waybar + Pywal"
echo "================================================================="

# Verificar dependencias
echo -n "Verificando dependencias... "
missing_deps=()
for dep in wal swww waybar rofi convert; do
    if ! command -v "$dep" > /dev/null 2>&1; then
        missing_deps+=("$dep")
    fi
done

if [[ ${#missing_deps[@]} -gt 0 ]]; then
    echo "‚ùå FALLO"
    echo "Dependencias faltantes: ${missing_deps[*]}"
    exit 1
else
    echo "‚úÖ OK"
fi

# Verificar directorios
echo -n "Verificando directorio de wallpapers... "
if [[ -d "$HOME/Pictures/Wallpapers" ]]; then
    wallpaper_count=$(find "$HOME/Pictures/Wallpapers" -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.gif" -o -name "*.webp" -o -name "*.bmp" | wc -l)
    echo "‚úÖ OK ($wallpaper_count im√°genes encontradas)"
else
    echo "‚ùå No existe $HOME/Pictures/Wallpapers"
    exit 1
fi

# Verificar archivos de configuraci√≥n
echo -n "Verificando configuraci√≥n de Waybar... "
if [[ -f "$HOME/.config/waybar/config" && -f "$HOME/.config/waybar/style.css" ]]; then
    echo "‚úÖ OK"
else
    echo "‚ùå Archivos de configuraci√≥n de Waybar no encontrados"
fi

# Verificar scripts
echo -n "Verificando scripts personalizados... "
scripts_ok=0
total_scripts=0

for script in "wallpaper-simple-no-duplicates" "waybar-gif-colors-sync" "waybar-pywal-universal-sync" "fix-gif-wallpaper"; do
    total_scripts=$((total_scripts + 1))
    if [[ -x "$HOME/.local/bin/$script" ]]; then
        scripts_ok=$((scripts_ok + 1))
    else
        echo ""
        echo "  ‚ö†Ô∏è  $script no encontrado o no es ejecutable"
    fi
done

if [[ $scripts_ok -eq $total_scripts ]]; then
    echo "‚úÖ OK ($scripts_ok/$total_scripts scripts)"
else
    echo "‚ö†Ô∏è  $scripts_ok/$total_scripts scripts disponibles"
fi

# Verificar procesos
echo -n "Verificando procesos activos... "
processes_status=""

if pgrep -x waybar > /dev/null; then
    processes_status+="waybar:‚úÖ "
else
    processes_status+="waybar:‚ùå "
fi

if pgrep -x swww-daemon > /dev/null; then
    processes_status+="swww-daemon:‚úÖ "
else
    processes_status+="swww-daemon:‚ùå "
fi

echo "$processes_status"

# Verificar archivos de pywal
echo -n "Verificando archivos de pywal... "
pywal_files_ok=0
if [[ -f "$HOME/.cache/wal/colors.css" ]]; then
    pywal_files_ok=$((pywal_files_ok + 1))
fi
if [[ -f "$HOME/.cache/wal/colors-hyprland.conf" ]]; then
    pywal_files_ok=$((pywal_files_ok + 1))
fi

if [[ $pywal_files_ok -eq 2 ]]; then
    echo "‚úÖ OK"
else
    echo "‚ö†Ô∏è  Algunos archivos de pywal no est√°n disponibles"
fi

# Verificar wallpaper actual
echo -n "Verificando wallpaper actual... "
if [[ -f "$HOME/.cache/current-wallpaper" ]]; then
    current_wallpaper=$(cat "$HOME/.cache/current-wallpaper")
    if [[ -f "$current_wallpaper" ]]; then
        wallpaper_name=$(basename "$current_wallpaper")
        if [[ "${current_wallpaper,,}" == *.gif ]]; then
            echo "‚úÖ OK (GIF: $wallpaper_name)"
        else
            echo "‚úÖ OK (Imagen: $wallpaper_name)"
        fi
    else
        echo "‚ö†Ô∏è  Archivo no existe: $current_wallpaper"
    fi
else
    echo "‚ö†Ô∏è  No hay wallpaper configurado"
fi

echo ""
echo "üéØ KEYBINDINGS DISPONIBLES:"
echo "  Super+Shift+W           : Selector principal de wallpapers"
echo "  Super+Ctrl+Shift+W      : Sincronizaci√≥n universal waybar+pywal"
echo "  Super+Alt+W             : Reiniciar waybar manualmente"
echo "  Super+Shift+G           : Reparar animaci√≥n de GIF"
echo "  Super+Ctrl+W            : Sincronizar waybar con pywal"

echo ""
echo "üìã RESUMEN:"
if [[ ${#missing_deps[@]} -eq 0 ]]; then
    echo "‚úÖ Todas las dependencias est√°n disponibles"
else
    echo "‚ùå Faltan dependencias cr√≠ticas"
fi

if [[ $scripts_ok -eq $total_scripts ]]; then
    echo "‚úÖ Todos los scripts est√°n listos"
else
    echo "‚ö†Ô∏è  Algunos scripts necesitan verificaci√≥n"
fi

echo ""
echo "üöÄ ¬°Prueba Super+Shift+W para abrir el selector de wallpapers!"
echo "================================================================="
