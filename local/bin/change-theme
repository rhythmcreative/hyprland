#!/bin/bash

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# CAMBIO R√ÅPIDO DE TEMA Y WALLPAPER + LIBREWOLF
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Cambia wallpaper, actualiza pywal y sincroniza LibreWolf

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Funci√≥n para logging
log() {
    echo -e "${GREEN}[$(date +'%H:%M:%S')]${NC} $1"
}

log_info() {
    echo -e "${BLUE}[$(date +'%H:%M:%S')] INFO:${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[$(date +'%H:%M:%S')] WARNING:${NC} $1"
}

log_error() {
    echo -e "${RED}[$(date +'%H:%M:%S')] ERROR:${NC} $1"
}

# Funci√≥n de ayuda
show_help() {
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë               ${WHITE}üé® CHANGE-THEME HELPER üé®${CYAN}               ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo
    echo -e "${WHITE}Uso:${NC}"
    echo -e "  ${GREEN}change-theme [imagen]${NC}          - Cambiar tema con imagen espec√≠fica"
    echo -e "  ${GREEN}change-theme --random${NC}          - Cambiar a wallpaper aleatorio"
    echo -e "  ${GREEN}change-theme --dark${NC}            - Aplicar tema oscuro"
    echo -e "  ${GREEN}change-theme --light${NC}           - Aplicar tema claro"
    echo -e "  ${GREEN}change-theme --list${NC}            - Listar wallpapers disponibles"
    echo -e "  ${GREEN}change-theme --current${NC}         - Mostrar wallpaper actual"
    echo -e "  ${GREEN}change-theme --help${NC}            - Mostrar esta ayuda"
    echo
    echo -e "${WHITE}Ejemplos:${NC}"
    echo -e "  ${YELLOW}change-theme ~/Pictures/wallpaper.jpg${NC}"
    echo -e "  ${YELLOW}change-theme --random${NC}"
    echo -e "  ${YELLOW}change-theme --dark${NC}"
    echo
}

# Obtener wallpaper actual
get_current_wallpaper() {
    if [ -f "$HOME/.cache/wal/colors.json" ]; then
        if command -v jq &> /dev/null; then
            jq -r '.wallpaper' "$HOME/.cache/wal/colors.json"
        else
            grep -o '"wallpaper": "[^"]*"' "$HOME/.cache/wal/colors.json" | cut -d'"' -f4
        fi
    else
        echo "No hay wallpaper configurado"
    fi
}

# Listar wallpapers disponibles
list_wallpapers() {
    local wallpaper_dirs=(
        "$HOME/Pictures/Wallpapers"
        "$HOME/Pictures"
        "$HOME/Wallpapers"
        "/usr/share/pixmaps"
        "/usr/share/backgrounds"
    )
    
    log_info "Buscando wallpapers en directorios comunes..."
    echo
    
    local count=0
    for dir in "${wallpaper_dirs[@]}"; do
        if [ -d "$dir" ]; then
            log_info "üìÅ $dir:"
            find "$dir" -maxdepth 2 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) 2>/dev/null | head -10 | while read -r file; do
                echo "   ‚Ä¢ $(basename "$file")"
                ((count++))
            done
            echo
        fi
    done
    
    if [ $count -eq 0 ]; then
        log_warn "No se encontraron wallpapers en los directorios comunes"
        echo -e "${WHITE}Puedes colocar tus wallpapers en: $HOME/Pictures/Wallpapers${NC}"
    fi
}

# Obtener wallpaper aleatorio
get_random_wallpaper() {
    local wallpaper_dirs=(
        "$HOME/Pictures/Wallpapers"
        "$HOME/Pictures"
        "$HOME/Wallpapers"
    )
    
    local wallpapers=()
    for dir in "${wallpaper_dirs[@]}"; do
        if [ -d "$dir" ]; then
            while IFS= read -r -d '' file; do
                wallpapers+=("$file")
            done < <(find "$dir" -maxdepth 2 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) -print0 2>/dev/null)
        fi
    done
    
    if [ ${#wallpapers[@]} -eq 0 ]; then
        log_error "No se encontraron wallpapers para selecci√≥n aleatoria"
        exit 1
    fi
    
    local random_index=$((RANDOM % ${#wallpapers[@]}))
    echo "${wallpapers[$random_index]}"
}

# Aplicar wallpaper y actualizar tema
apply_wallpaper() {
    local wallpaper="$1"
    local extra_flags="$2"
    
    if [ ! -f "$wallpaper" ]; then
        log_error "El archivo '$wallpaper' no existe"
        exit 1
    fi
    
    log "üñºÔ∏è Aplicando wallpaper: $(basename "$wallpaper")"
    
    # Aplicar con pywal
    if ! wal -i "$wallpaper" $extra_flags; then
        log_error "Error al aplicar wallpaper con pywal"
        exit 1
    fi
    
    log "‚úÖ Wallpaper aplicado exitosamente"
    
    # Actualizar LibreWolf autom√°ticamente
    if command -v update-librewolf-theme &> /dev/null; then
        log "ü¶ä Actualizando tema de LibreWolf..."
        update-librewolf-theme --auto
    else
        log_warn "Script de actualizaci√≥n de LibreWolf no encontrado"
    fi
    
    # Mostrar informaci√≥n del tema aplicado
    show_current_info
}

# Mostrar informaci√≥n del tema actual
show_current_info() {
    local current_wallpaper=$(get_current_wallpaper)
    
    echo
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë                 ${WHITE}üé® TEMA ACTUAL üé®${CYAN}                     ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo
    echo -e "${WHITE}üì∏ Wallpaper:${NC} $(basename "$current_wallpaper")"
    echo -e "${WHITE}üìÅ Ruta:${NC} $current_wallpaper"
    
    if [ -f "$HOME/.cache/wal/colors.json" ]; then
        if command -v jq &> /dev/null; then
            local bg=$(jq -r '.special.background' "$HOME/.cache/wal/colors.json")
            local fg=$(jq -r '.special.foreground' "$HOME/.cache/wal/colors.json")
            local color4=$(jq -r '.colors.color4' "$HOME/.cache/wal/colors.json")
            
            echo -e "${WHITE}üé® Colores principales:${NC}"
            echo -e "   ‚Ä¢ Fondo: $bg"
            echo -e "   ‚Ä¢ Texto: $fg"
            echo -e "   ‚Ä¢ Acento: $color4"
        fi
    fi
    
    echo
    echo -e "${GREEN}‚ú® Tema sincronizado con:${NC}"
    echo -e "${WHITE}  ‚Ä¢ LibreWolf (navegador)${NC}"
    echo -e "${WHITE}  ‚Ä¢ Terminal${NC}"
    echo -e "${WHITE}  ‚Ä¢ Aplicaciones compatibles${NC}"
    echo
}

# Funci√≥n principal
main() {
    case "${1:-}" in
        --help|-h)
            show_help
            ;;
        --list|-l)
            echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
            echo -e "${CYAN}‚ïë             ${WHITE}üìã WALLPAPERS DISPONIBLES üìã${CYAN}             ‚ïë${NC}"
            echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
            echo
            list_wallpapers
            ;;
        --current|-c)
            show_current_info
            ;;
        --random|-r)
            echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
            echo -e "${CYAN}‚ïë              ${WHITE}üé≤ WALLPAPER ALEATORIO üé≤${CYAN}               ‚ïë${NC}"
            echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
            echo
            local random_wallpaper=$(get_random_wallpaper)
            apply_wallpaper "$random_wallpaper"
            ;;
        --dark|-d)
            echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
            echo -e "${CYAN}‚ïë                ${WHITE}üåô TEMA OSCURO üåô${CYAN}                     ‚ïë${NC}"
            echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
            echo
            local current_wallpaper=$(get_current_wallpaper)
            if [ "$current_wallpaper" != "No hay wallpaper configurado" ]; then
                apply_wallpaper "$current_wallpaper" "--saturate 0.7"
            else
                log_error "No hay wallpaper configurado. Usa primero: change-theme [imagen]"
                exit 1
            fi
            ;;
        --light|-L)
            echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
            echo -e "${CYAN}‚ïë                ${WHITE}‚òÄÔ∏è TEMA CLARO ‚òÄÔ∏è${CYAN}                      ‚ïë${NC}"
            echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
            echo
            local current_wallpaper=$(get_current_wallpaper)
            if [ "$current_wallpaper" != "No hay wallpaper configurado" ]; then
                apply_wallpaper "$current_wallpaper" "-l"
            else
                log_error "No hay wallpaper configurado. Usa primero: change-theme [imagen]"
                exit 1
            fi
            ;;
        "")
            log_error "Debes especificar una imagen o usar una opci√≥n"
            echo -e "${YELLOW}Usa: ${WHITE}change-theme --help${YELLOW} para ver la ayuda${NC}"
            exit 1
            ;;
        *)
            # Imagen espec√≠fica
            local wallpaper="$1"
            
            # Si es un path relativo, intentar convertir a absoluto
            if [[ "$wallpaper" != /* ]]; then
                if [ -f "$PWD/$wallpaper" ]; then
                    wallpaper="$PWD/$wallpaper"
                elif [ -f "$HOME/Pictures/Wallpapers/$wallpaper" ]; then
                    wallpaper="$HOME/Pictures/Wallpapers/$wallpaper"
                elif [ -f "$HOME/Pictures/$wallpaper" ]; then
                    wallpaper="$HOME/Pictures/$wallpaper"
                fi
            fi
            
            echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
            echo -e "${CYAN}‚ïë              ${WHITE}üé® APLICANDO TEMA NUEVO üé®${CYAN}              ‚ïë${NC}"
            echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
            echo
            apply_wallpaper "$wallpaper"
            ;;
    esac
}

# Verificar dependencias b√°sicas
if ! command -v wal &> /dev/null; then
    log_error "pywal no est√° instalado. Instala con: pip install pywal"
    exit 1
fi

# Ejecutar funci√≥n principal
main "$@"
