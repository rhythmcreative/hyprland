#!/bin/bash

# Script para sincronizar nm-applet con colores de pywal
# Reinicia nm-applet para que use los nuevos colores GTK

LOG_FILE="$HOME/.cache/nm-applet-sync.log"

# FunciÃ³n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "ğŸ”„ Iniciando sincronizaciÃ³n de nm-applet..."

# Verificar si pywal ha generado colores
if [[ ! -f "$HOME/.cache/wal/colors.sh" ]]; then
    log "âš ï¸ No se encontraron colores de pywal"
    notify-send "âš ï¸ Advertencia" "No hay colores de pywal para aplicar" -t 2000
    exit 1
fi

# Cargar colores de pywal
source "$HOME/.cache/wal/colors.sh"
log "âœ… Colores de pywal cargados"

# Sincronizar GTK para asegurar que los colores estÃ©n disponibles
if command -v gsettings >/dev/null 2>&1; then
    gsettings set org.gnome.desktop.interface gtk-theme "oomox-pywal" 2>/dev/null || true
    gsettings set org.gnome.desktop.interface icon-theme "Papirus-Dark" 2>/dev/null || true
    log "âœ… GTK theme actualizado"
fi

# Reiniciar nm-applet para aplicar nuevos colores
log "ğŸ”„ Reiniciando nm-applet..."

if pgrep -f nm-applet >/dev/null; then
    log "â¹ï¸ Cerrando nm-applet actual..."
    pkill -f nm-applet 2>/dev/null || true
    
    # Esperar a que se cierre completamente
    for i in {1..5}; do
        if ! pgrep -f nm-applet >/dev/null; then
            break
        fi
        sleep 1
        log "â³ Esperando cierre ($i/5)..."
    done
    
    # Si sigue corriendo, forzar cierre
    if pgrep -f nm-applet >/dev/null; then
        log "ğŸ”¨ Forzando cierre de nm-applet..."
        pkill -9 -f nm-applet 2>/dev/null || true
        sleep 1
    fi
    
    log "âœ… nm-applet cerrado exitosamente"
else
    log "â„¹ï¸ nm-applet no estaba corriendo"
fi

# Iniciar nm-applet en segundo plano con variables de entorno actualizadas
log "ğŸš€ Iniciando nm-applet con nuevos colores..."

# Asegurar que las variables GTK estÃ©n configuradas
export GTK_THEME="oomox-pywal"
export GTK2_RC_FILES="$HOME/.gtkrc-2.0"

# Iniciar nm-applet
if command -v setsid >/dev/null 2>&1; then
    setsid nm-applet >/dev/null 2>&1 &
    disown
else
    nohup nm-applet >/dev/null 2>&1 &
    disown
fi

# Dar tiempo para que se inicie
sleep 2

# Verificar que se haya iniciado correctamente
if pgrep -f nm-applet >/dev/null; then
    log "âœ… nm-applet iniciado correctamente con nuevos colores"
    notify-send "ğŸŒ nm-applet" "Sincronizado con colores de pywal" -t 2000 2>/dev/null || true
else
    log "âŒ Error: No se pudo iniciar nm-applet"
    notify-send "âŒ Error nm-applet" "No se pudo reiniciar" -u critical -t 3000 2>/dev/null || true
    exit 1
fi

log "ğŸ‰ SincronizaciÃ³n de nm-applet completada"
exit 0
