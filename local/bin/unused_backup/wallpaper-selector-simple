#!/bin/bash

# Wallpaper Selector - Versi√≥n simplificada
# Solo cambia wallpaper y reinicia waybar una vez, sin pywal

WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
LOG_FILE="$HOME/.cache/wallpaper-simple.log"

# Crear directorio log si no existe
mkdir -p "$(dirname "$LOG_FILE")"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Verificar si el directorio existe
if [[ ! -d "$WALLPAPER_DIR" ]]; then
    log "ERROR: Directorio $WALLPAPER_DIR no encontrado"
    notify-send "‚ùå Error" "Directorio $WALLPAPER_DIR no encontrado" -t 3000
    exit 1
fi

log "Iniciando selector de wallpaper simplificado"

# Obtener lista de im√°genes y GIFs
mapfile -t images < <(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.bmp" -o -iname "*.gif" \) | sort)

if [[ ${#images[@]} -eq 0 ]]; then
    log "ERROR: No se encontraron im√°genes en $WALLPAPER_DIR"
    notify-send "‚ùå Error" "No se encontraron im√°genes en $WALLPAPER_DIR" -t 3000
    exit 1
fi

log "Encontradas ${#images[@]} im√°genes"

# Generar lista simple para rofi
image_list=""
for img in "${images[@]}"; do
    basename_img=$(basename "$img")
    file_ext="${img##*.}"
    file_ext_upper="${file_ext^^}"
    
    # A√±adir emoji indicador
    if [[ "${img,,}" == *.gif ]]; then
        display_name="üé¨ ${basename_img%.*} | $file_ext_upper"
    else
        display_name="üñºÔ∏è ${basename_img%.*} | $file_ext_upper"
    fi
    
    image_list="$image_list$display_name\n"
done

# Mostrar selector con rofi
log "Mostrando selector rofi"
selected=$(echo -e "$image_list" | rofi -dmenu -i -p "üé® Selecciona Wallpaper:" \
    -theme "$HOME/.config/rofi/wallpaper-theme.rasi")

# Si no se seleccion√≥ nada, salir
if [[ -z "$selected" ]]; then
    log "No se seleccion√≥ ning√∫n wallpaper"
    exit 0
fi

log "Seleccionado: $selected"

# Encontrar la ruta completa del archivo seleccionado
selected_path=""
for img in "${images[@]}"; do
    basename_img=$(basename "$img")
    file_ext="${img##*.}"
    file_ext_upper="${file_ext^^}"
    
    if [[ "${img,,}" == *.gif ]]; then
        display_name="üé¨ ${basename_img%.*} | $file_ext_upper"
    else
        display_name="üñºÔ∏è ${basename_img%.*} | $file_ext_upper"
    fi
    
    if [[ "$display_name" == "$selected" ]]; then
        selected_path="$img"
        break
    fi
done

if [[ -z "$selected_path" ]]; then
    log "ERROR: No se pudo encontrar el archivo seleccionado"
    notify-send "‚ùå Error" "No se pudo encontrar el archivo seleccionado" -t 3000
    exit 1
fi

log "Ruta completa: $selected_path"

# Guardar el wallpaper seleccionado
echo "$selected_path" > "$HOME/.cache/current-wallpaper"
log "Wallpaper guardado en cache"

# Verificar que swww-daemon est√° corriendo
if ! pgrep -x "swww-daemon" > /dev/null; then
    log "Iniciando swww-daemon..."
    notify-send "üîÑ Iniciando swww-daemon..." -t 2000
    swww-daemon --format xrgb &
    sleep 3
fi

# Aplicar wallpaper
log "Aplicando wallpaper: $selected_path"

if [[ "${selected_path,,}" == *.gif ]]; then
    log "Aplicando GIF animado"
    swww img "$selected_path" --transition-type fade --transition-duration 0.8 --transition-fps 60
    if [ $? -eq 0 ]; then
        log "GIF wallpaper aplicado exitosamente"
        notify-send "üé¨ GIF Wallpaper" "$(basename "$selected_path") aplicado" -t 2000
    else
        log "ERROR: Fallo al aplicar GIF wallpaper"
        notify-send "‚ùå Error" "No se pudo aplicar el GIF wallpaper" -t 3000
        exit 1
    fi
else
    log "Aplicando imagen est√°tica"
    swww img "$selected_path" --transition-type grow --transition-pos "0.9,0.1" --transition-duration 1.5
    if [ $? -eq 0 ]; then
        log "Imagen wallpaper aplicada exitosamente"
        notify-send "üñºÔ∏è Wallpaper" "$(basename "$selected_path") aplicado" -t 2000
    else
        log "ERROR: Fallo al aplicar imagen wallpaper"
        notify-send "‚ùå Error" "No se pudo aplicar el wallpaper" -t 3000
        exit 1
    fi
fi

# Esperar un momento antes de reiniciar waybar
log "Esperando antes de reiniciar waybar..."
sleep 2

# Reiniciar waybar una sola vez usando nuestro script simple
log "Reiniciando waybar..."
~/.local/bin/waybar-restart-once

notify-send "‚úÖ Completado" "Wallpaper aplicado y waybar reiniciado" -t 2000
log "Proceso completado exitosamente"
