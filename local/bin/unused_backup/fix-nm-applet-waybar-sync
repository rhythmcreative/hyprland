#!/bin/bash

# Solucionador completo de sincronizaciÃ³n nm-applet â†” Waybar
# Fuerza a nm-applet a usar exactamente los mismos colores que waybar

set -eo pipefail

echo "ğŸ¨ Arreglando sincronizaciÃ³n nm-applet â†” Waybar..."

# FunciÃ³n para extraer colores de pywal
extract_colors() {
    echo "ğŸ“Š Extrayendo colores actuales de pywal..."
    
    if [[ ! -f "$HOME/.cache/wal/colors.sh" ]]; then
        echo "âŒ Error: No se encontraron colores de pywal"
        echo "   Ejecuta 'wal -i [imagen]' primero"
        exit 1
    fi
    
    # Extraer colores directamente sin cargar todo el archivo
    BG_COLOR=$(grep "^background=" "$HOME/.cache/wal/colors.sh" | cut -d"'" -f2)
    FG_COLOR=$(grep "^foreground=" "$HOME/.cache/wal/colors.sh" | cut -d"'" -f2)
    ACCENT_COLOR=$(grep "^color4=" "$HOME/.cache/wal/colors.sh" | cut -d"'" -f2)
    HIGHLIGHT_COLOR=$(grep "^color2=" "$HOME/.cache/wal/colors.sh" | cut -d"'" -f2)
    WARNING_COLOR=$(grep "^color3=" "$HOME/.cache/wal/colors.sh" | cut -d"'" -f2)
    ERROR_COLOR=$(grep "^color1=" "$HOME/.cache/wal/colors.sh" | cut -d"'" -f2)
    
    echo "âœ… Colores extraÃ­dos:"
    echo "   Background: $BG_COLOR"
    echo "   Foreground: $FG_COLOR" 
    echo "   Accent: $ACCENT_COLOR"
}

# FunciÃ³n para crear CSS personalizado para nm-applet
create_nm_applet_css() {
    echo "ğŸ¨ Creando CSS personalizado para nm-applet..."
    
    local gtk3_dir="$HOME/.config/gtk-3.0"
    local gtk4_dir="$HOME/.config/gtk-4.0"
    
    mkdir -p "$gtk3_dir" "$gtk4_dir"
    
    # CSS para nm-applet con colores exactos de waybar
    cat > "$gtk3_dir/nm-applet.css" << EOF
/* nm-applet sincronizado con waybar - $(date) */

/* Ventana principal de nm-applet */
window.nm-applet,
window.background.nm-applet,
#nm-applet,
.nm-applet {
    background-color: $BG_COLOR;
    color: $FG_COLOR;
    border: 1px solid $ACCENT_COLOR;
    border-radius: 6px;
}

/* MenÃºs y elementos desplegables */
popover,
menu,
.menu {
    background-color: $BG_COLOR;
    color: $FG_COLOR;
    border: 1px solid $ACCENT_COLOR;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Items del menÃº */
menuitem,
.menuitem {
    background-color: transparent;
    color: $FG_COLOR;
    padding: 8px 12px;
    border-radius: 4px;
}

menuitem:hover,
.menuitem:hover {
    background-color: $ACCENT_COLOR;
    color: $BG_COLOR;
}

/* ConexiÃ³n activa */
menuitem.active,
.menuitem.active {
    color: $ACCENT_COLOR;
    font-weight: bold;
}

/* Separadores */
separator {
    background-color: $ACCENT_COLOR;
    opacity: 0.3;
    margin: 4px 0;
}

/* Botones */
button {
    background-color: $ACCENT_COLOR;
    color: $BG_COLOR;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    font-weight: bold;
}

button:hover {
    background-color: $HIGHLIGHT_COLOR;
}

/* Campos de entrada */
entry {
    background-color: $BG_COLOR;
    color: $FG_COLOR;
    border: 1px solid $ACCENT_COLOR;
    border-radius: 4px;
    padding: 6px;
}

/* Listas */
list,
listview {
    background-color: $BG_COLOR;
    color: $FG_COLOR;
}

list row,
listview row {
    background-color: transparent;
    color: $FG_COLOR;
    padding: 4px 8px;
    border-radius: 2px;
}

list row:hover,
listview row:hover {
    background-color: $ACCENT_COLOR;
    color: $BG_COLOR;
}

/* Icono en system tray */
.system-tray .nm-applet {
    color: $FG_COLOR;
}

/* Scrollbars */
scrollbar {
    background-color: transparent;
}

scrollbar slider {
    background-color: $ACCENT_COLOR;
    border-radius: 10px;
    min-width: 6px;
    min-height: 6px;
}

scrollbar slider:hover {
    background-color: $HIGHLIGHT_COLOR;
}
EOF

    # Copiar tambiÃ©n para GTK4
    cp "$gtk3_dir/nm-applet.css" "$gtk4_dir/nm-applet.css"
    
    echo "âœ… CSS creado en $gtk3_dir/nm-applet.css"
}

# FunciÃ³n para configurar GTK para usar nuestro CSS
configure_gtk() {
    echo "âš™ï¸  Configurando GTK para usar CSS personalizado..."
    
    local gtk3_css="$HOME/.config/gtk-3.0/gtk.css"
    local gtk4_css="$HOME/.config/gtk-4.0/gtk.css"
    
    # Para GTK3
    if [[ ! -f "$gtk3_css" ]] || ! grep -q "nm-applet.css" "$gtk3_css"; then
        echo '@import "nm-applet.css";' >> "$gtk3_css"
        echo "âœ… CSS importado en gtk.css (GTK3)"
    fi
    
    # Para GTK4
    if [[ ! -f "$gtk4_css" ]] || ! grep -q "nm-applet.css" "$gtk4_css"; then
        echo '@import "nm-applet.css";' >> "$gtk4_css"
        echo "âœ… CSS importado en gtk.css (GTK4)"
    fi
}

# FunciÃ³n para crear variables de entorno GTK
create_gtk_env() {
    echo "ğŸ”§ Configurando variables de entorno GTK..."
    
    # Crear archivo de configuraciÃ³n de tema
    cat > "$HOME/.config/gtk-3.0/settings.ini" << EOF
[Settings]
gtk-theme-name=Adwaita-dark
gtk-application-prefer-dark-theme=1
gtk-cursor-theme-name=default
gtk-font-name=JetBrainsMono Nerd Font 11
gtk-enable-animations=true
EOF

    cat > "$HOME/.config/gtk-4.0/settings.ini" << EOF
[Settings]
gtk-theme-name=Adwaita-dark
gtk-application-prefer-dark-theme=1
gtk-cursor-theme-name=default
gtk-font-name=JetBrainsMono Nerd Font 11
EOF

    echo "âœ… ConfiguraciÃ³n GTK actualizada"
}

# FunciÃ³n para reiniciar nm-applet con nuevo tema
restart_nm_applet() {
    echo "ğŸ”„ Reiniciando nm-applet con tema sincronizado..."
    
    # Matar nm-applet actual
    if pgrep -x nm-applet > /dev/null; then
        pkill nm-applet
        sleep 2
        echo "ğŸ›‘ nm-applet anterior terminado"
    fi
    
    # Variables de entorno para consistencia de tema
    export GTK_THEME="Adwaita-dark"
    export GTK2_RC_FILES="$HOME/.gtkrc-2.0"
    export GDK_BACKEND="wayland,x11"
    export GTK_CSD=0
    
    # Iniciar nm-applet con entorno correcto
    nohup env GTK_THEME="Adwaita-dark" nm-applet > /dev/null 2>&1 &
    
    sleep 3
    
    if pgrep -x nm-applet > /dev/null; then
        echo "âœ… nm-applet reiniciado exitosamente"
        # Mostrar notificaciÃ³n si estÃ¡ disponible
        if command -v notify-send > /dev/null; then
            notify-send "ğŸ¨ nm-applet Sincronizado" \
                       "Ahora usa los mismos colores que Waybar" \
                       -t 3000 -i network-wireless 2>/dev/null || true
        fi
    else
        echo "âŒ Error al reiniciar nm-applet"
        exit 1
    fi
}

# FunciÃ³n para aplicar cambios de tema globales
apply_global_theme() {
    echo "ğŸŒ Aplicando cambios de tema globales..."
    
    # Configurar gsettings
    if command -v gsettings > /dev/null; then
        gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark" 2>/dev/null || true
        gsettings set org.gnome.desktop.interface color-scheme "prefer-dark" 2>/dev/null || true
        echo "âœ… gsettings configurado"
    fi
    
    # Enviar seÃ±ales D-Bus para actualizar temas
    if command -v dbus-send > /dev/null; then
        dbus-send --type=signal /org/gtk/Settings org.gtk.Settings.SettingChanged \
                  string:"gtk-theme-name" 2>/dev/null || true
        echo "âœ… SeÃ±ales D-Bus enviadas"
    fi
}

# FunciÃ³n para reiniciar waybar si es necesario
maybe_restart_waybar() {
    echo "ğŸ”„ Verificando si waybar necesita reinicio..."
    
    # Solo reiniciar si waybar estÃ¡ corriendo
    if pgrep -x waybar > /dev/null; then
        echo "â„¹ï¸  Waybar estÃ¡ corriendo. Â¿Reiniciar waybar tambiÃ©n? (y/n)"
        read -r -t 5 restart_waybar || restart_waybar="n"
        
        if [[ "$restart_waybar" =~ ^[Yy]$ ]]; then
            pkill waybar
            sleep 1
            nohup waybar > /dev/null 2>&1 &
            echo "âœ… Waybar reiniciado"
        fi
    fi
}

# FunciÃ³n para verificar el resultado
verify_sync() {
    echo "ğŸ” Verificando sincronizaciÃ³n..."
    
    # Verificar que nm-applet estÃ© corriendo
    if pgrep -x nm-applet > /dev/null; then
        echo "âœ… nm-applet estÃ¡ corriendo"
    else
        echo "âŒ nm-applet no estÃ¡ corriendo"
        return 1
    fi
    
    # Verificar que los archivos CSS existan
    if [[ -f "$HOME/.config/gtk-3.0/nm-applet.css" ]]; then
        echo "âœ… CSS personalizado creado"
    else
        echo "âŒ CSS personalizado no encontrado"
        return 1
    fi
    
    echo "ğŸ‰ SincronizaciÃ³n completada exitosamente!"
    echo ""
    echo "ğŸ“‹ Resumen:"
    echo "   â€¢ nm-applet ahora usa los colores de waybar"
    echo "   â€¢ CSS personalizado aplicado"
    echo "   â€¢ ConfiguraciÃ³n GTK actualizada"
    echo ""
    echo "ğŸ’¡ Si necesitas volver a sincronizar despuÃ©s de cambiar wallpaper:"
    echo "   Ejecuta: fix-nm-applet-waybar-sync"
}

# FunciÃ³n principal
main() {
    echo "=== Arreglando sincronizaciÃ³n nm-applet â†” Waybar ==="
    echo ""
    
    # Ejecutar todas las funciones
    extract_colors
    create_nm_applet_css
    configure_gtk
    create_gtk_env
    apply_global_theme
    restart_nm_applet
    maybe_restart_waybar
    verify_sync
    
    echo ""
    echo "ğŸ¨ Â¡SincronizaciÃ³n completada! nm-applet deberÃ­a usar ahora los colores de waybar."
}

# Ejecutar funciÃ³n principal
main "$@"
