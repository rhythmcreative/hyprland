#!/bin/bash

# Script corregido para cambio de wallpaper que PRESERVA waybar
# Versi√≥n mejorada que evita el cierre de waybar

set -euo pipefail

WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
CACHE_DIR="$HOME/.cache/wallpaper-previews"
TEMP_FILE="/tmp/rofi_wallpaper_$$"
LOG_FILE="$HOME/.cache/wallpaper-changer-fixed.log"

# Crear directorios necesarios
mkdir -p "$CACHE_DIR"
mkdir -p "$(dirname "$LOG_FILE")"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
    echo "$1" >&2
}

# Funci√≥n para preservar waybar
preserve_waybar() {
    local waybar_pids=$(pgrep -x waybar || true)
    
    if [[ -n "$waybar_pids" ]]; then
        log "‚úÖ Waybar corriendo (PIDs: $waybar_pids) - manteniendo activo"
        return 0
    else
        log "‚ö†Ô∏è Waybar no est√° corriendo, inici√°ndolo..."
        waybar -c "$HOME/.config/waybar/config" -s "$HOME/.config/waybar/style.css" > /dev/null 2>&1 &
        sleep 1
        return 0
    fi
}

# Funci√≥n para aplicar wallpaper preservando waybar
apply_wallpaper_safely() {
    local wallpaper_file="$1"
    
    log "üñºÔ∏è Aplicando wallpaper: $wallpaper_file"
    preserve_waybar
    
    # Aplicar wallpaper con swww
    if swww img "$wallpaper_file" --transition-type grow --transition-pos "0.9,0.1" --transition-duration 1.5; then
        log "‚úÖ Wallpaper aplicado exitosamente"
    else
        log "‚ùå Error al aplicar wallpaper"
        return 1
    fi
    
    # Guardar wallpaper actual
    echo "$wallpaper_file" > "$HOME/.cache/current-wallpaper"
    
    # Aplicar pywal con sincronizaci√≥n completa
    if command -v wal > /dev/null 2>&1; then
        log "üé® Aplicando colores con pywal..."
        notify-send "üåà Generando colores..." "Aplicando tema completo" -t 2000 2>/dev/null || true
        
        # Aplicar pywal con backend optimizado y opciones adicionales
        if wal -i "$wallpaper_file" -n -q --backend wal --saturate 0.8; then
            log "‚úÖ Pywal aplicado con saturaci√≥n optimizada"
            
            # Generar templates adicionales para aplicaciones
            if [[ -f "$HOME/.cache/wal/colors.sh" ]]; then
                source "$HOME/.cache/wal/colors.sh"
                
                # Crear CSS para waybar si no existe
                mkdir -p "$HOME/.config/waybar"
                cat > "$HOME/.config/waybar/colors-pywal.css" << EOF
/* Colores generados autom√°ticamente por pywal - $(date) */
@define-color background ${background};
@define-color foreground ${foreground};
@define-color cursor ${cursor};
@define-color color0 ${color0};
@define-color color1 ${color1};
@define-color color2 ${color2};
@define-color color3 ${color3};
@define-color color4 ${color4};
@define-color color5 ${color5};
@define-color color6 ${color6};
@define-color color7 ${color7};
@define-color color8 ${color8};
@define-color color9 ${color9};
@define-color color10 ${color10};
@define-color color11 ${color11};
@define-color color12 ${color12};
@define-color color13 ${color13};
@define-color color14 ${color14};
@define-color color15 ${color15};
EOF
                log "‚úÖ CSS de waybar actualizado"
                
                # Forzar cambio de mtime en style.css para evitar cach√© de CSS
                if [[ -f "$HOME/.config/waybar/style.css" ]]; then
                    sed -i "1s|^|/* reload-ts: $(date +%s) */\n|" "$HOME/.config/waybar/style.css" || true
                    log "üïí Forzado reload timestamp en style.css"
                fi
                
                # Sincronizar aplicaciones GTK
                if command -v gsettings >/dev/null 2>&1; then
                    gsettings set org.gnome.desktop.interface gtk-theme "oomox-pywal" 2>/dev/null || true
                    gsettings set org.gnome.desktop.interface icon-theme "Papirus-Dark" 2>/dev/null || true
                    log "‚úÖ GTK sincronizado"
                fi
                
                # Sincronizar kitty si existe
                if [[ -f "$HOME/.config/kitty/kitty.conf" ]] && [[ -f "$HOME/.cache/wal/colors-kitty.conf" ]]; then
                    pkill -USR1 kitty 2>/dev/null || true
                    log "‚úÖ Kitty sincronizado"
                fi
                
                # Sincronizar nm-applet (reinicio para aplicar nuevos colores GTK)
                log "üîÑ Sincronizando nm-applet..."
                if pgrep -f nm-applet >/dev/null; then
                    pkill -f nm-applet 2>/dev/null || true
                    sleep 1
                    # Reiniciar nm-applet en segundo plano
                    nohup nm-applet >/dev/null 2>&1 &
                    disown
                    sleep 1
                    log "‚úÖ nm-applet reiniciado con nuevos colores"
                else
                    # Si no estaba corriendo, iniciarlo
                    nohup nm-applet >/dev/null 2>&1 &
                    disown
                    log "‚úÖ nm-applet iniciado"
                fi
            fi
            
            sleep 1.5
            
            # REINICIAR waybar completamente para cargar nuevos colores CSS
            log "üîÑ Reiniciando waybar para cargar nuevos colores..."
            if pgrep -x waybar > /dev/null; then
                log "‚èπÔ∏è Cerrando waybar..."
                pkill waybar
                
                # Esperar hasta 5 segundos a que se cierre
                for i in {1..5}; do
                    if ! pgrep waybar > /dev/null; then
                        break
                    fi
                    sleep 1
                    log "‚è≥ Esperando cierre ($i/5)..."
                done
                
                # Si sigue corriendo, forzar cierre
                if pgrep waybar > /dev/null; then
                    log "üî® Forzando cierre de waybar..."
                    pkill -9 waybar
                    sleep 1
                fi
            fi
            
            # Iniciar waybar con nuevos colores
            log "üöÄ Iniciando waybar con colores actualizados..."
            if command -v setsid >/dev/null 2>&1; then
                setsid waybar -c "$HOME/.config/waybar/config" -s "$HOME/.config/waybar/style.css" >/dev/null 2>&1 &
                disown
            else
                nohup waybar -c "$HOME/.config/waybar/config" -s "$HOME/.config/waybar/style.css" >/dev/null 2>&1 &
                disown
            fi
            
            sleep 3

            # Refuerzo: ejecutar recarga completa de Waybar con pywal si est√° disponible
            if [[ -x "$HOME/.local/bin/waybar-pywal-reload" ]]; then
                log "üîÅ Ejecutando waybar-pywal-reload para asegurar sincronizaci√≥n..."
                "$HOME/.local/bin/waybar-pywal-reload" >/dev/null 2>&1 || true
            fi
            
            # Recargar Hyprland
            hyprctl reload > /dev/null 2>&1 || true
            
            # Verificar waybar final
            if pgrep -x waybar > /dev/null; then
                log "‚úÖ Waybar funcionando correctamente"
                notify-send "üé® Tema Aplicado" "Wallpaper + colores (Waybar preservado)" -t 3000 2>/dev/null || true
            else
                log "‚ùå Reiniciando waybar emergencia"
                waybar -c "$HOME/.config/waybar/config" -s "$HOME/.config/waybar/style.css" > /dev/null 2>&1 &
                sleep 2
            fi
        else
            log "‚ùå Error: Pywal fall√≥"
            notify-send "‚ö†Ô∏è Error Pywal" "Wallpaper aplicado, colores fallaron" -t 3000 2>/dev/null || true
        fi
    else
        log "‚ÑπÔ∏è Solo wallpaper aplicado"
        notify-send "‚úÖ Wallpaper Aplicado" "$(basename "$wallpaper_file")" -t 2000 2>/dev/null || true
    fi
}

# Funci√≥n de limpieza
cleanup() {
    rm -f "$TEMP_FILE"* 2>/dev/null || true
    if ! pgrep -x waybar > /dev/null; then
        log "üö® Asegurando waybar al salir"
        waybar > /dev/null 2>&1 &
    fi
}

trap cleanup EXIT INT TERM

log "=== Selector de wallpapers (versi√≥n corregida) ==="

# Verificaciones
if [[ ! -d "$WALLPAPER_DIR" ]]; then
    notify-send "‚ùå Error" "Directorio no encontrado" -u critical
    exit 1
fi

if ! command -v swww &> /dev/null; then
    notify-send "‚ùå Error" "swww no instalado" -u critical
    exit 1
fi

# Iniciar swww-daemon si necesario
if ! pgrep -x "swww-daemon" > /dev/null; then
    log "üöÄ Iniciando swww-daemon"
    swww-daemon --format xrgb &
    sleep 3
fi

# Buscar im√°genes
cd "$WALLPAPER_DIR" || exit 1
mapfile -t images < <(find . -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" -o -iname "*.webp" -o -iname "*.bmp" \) | sed 's|^./||' | sort)

if [[ ${#images[@]} -eq 0 ]]; then
    notify-send "‚ùå Error" "No hay im√°genes" -u critical
    exit 1
fi

# Crear previews para rofi
> "$TEMP_FILE"
for img in "${images[@]}"; do
    [[ ! -f "$img" ]] && continue
    clean_name="${img%.*}"
    preview_file="$CACHE_DIR/preview_${clean_name}.png"
    
    if [[ ! -f "$preview_file" ]]; then
        if [[ "$img" == *.gif ]]; then
            convert "$img[0]" -resize "200x150^" -gravity center -extent "200x150" "$preview_file" 2>/dev/null || continue
        else
            convert "$img" -resize "200x150^" -gravity center -extent "200x150" "$preview_file" 2>/dev/null || continue
        fi
    fi
    
    if [[ -f "$preview_file" ]]; then
        echo -e "$clean_name\\0icon\\x1f$preview_file" >> "$TEMP_FILE"
    else
        echo "$clean_name" >> "$TEMP_FILE"
    fi
done

# Mostrar selector sin ocultar waybar
log "üé≠ Mostrando selector (waybar visible)"
selected=$(rofi -dmenu -i \
    -p "üñºÔ∏è Wallpaper (Waybar protegido)" \
    -show-icons \
    -theme "$HOME/HyprNova/.config/rofi/themes/wallpaper-select.rasi" \
    < "$TEMP_FILE")

# Si no hay selecci√≥n, salir
if [[ -z "$selected" ]]; then
    log "‚ÑπÔ∏è No se seleccion√≥ wallpaper"
    exit 0
fi

# Buscar archivo
selected_file=""
for img in "${images[@]}"; do
    if [[ "${img%.*}" == "$selected" ]]; then
        selected_file="$WALLPAPER_DIR/$img"
        break
    fi
done

if [[ -z "$selected_file" ]] || [[ ! -f "$selected_file" ]]; then
    notify-send "‚ùå Error" "Archivo no encontrado" -u critical
    exit 1
fi

# Aplicar wallpaper preservando waybar
apply_wallpaper_safely "$selected_file"

log "üéâ Completado - Waybar preservado"
exit 0
